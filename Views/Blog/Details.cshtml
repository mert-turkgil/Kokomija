@model Kokomija.Models.ViewModels.Blog.BlogDetailsViewModel
@inject Kokomija.Services.ILocalizationService L
@inject Kokomija.Services.ILocalizedUrlService LocalizedUrl

@{
    ViewData["Title"] = Model.Title;
}

@{
    // Build absolute image URL for social media sharing
    var baseUrl = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var absoluteImageUrl = !string.IsNullOrEmpty(Model.FeaturedImage) 
        ? (Model.FeaturedImage.StartsWith("http") ? Model.FeaturedImage : $"{baseUrl}{Model.FeaturedImage}")
        : null;
}

@section Meta {
    <meta name="description" content="@Model.MetaDescription">
    <meta name="keywords" content="@Model.MetaKeywords">
    <meta name="author" content="@Model.AuthorName">
    <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
    <link rel="canonical" href="@Model.CanonicalUrl">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:url" content="@Model.CanonicalUrl">
    <meta property="og:title" content="@Model.Title">
    <meta property="og:description" content="@Model.MetaDescription">
    <meta property="og:site_name" content="Kokomija">
    <meta property="og:locale" content="@System.Globalization.CultureInfo.CurrentCulture.Name.Replace("-", "_")">
    <meta property="article:published_time" content="@Model.PublishedDate?.ToString("yyyy-MM-ddTHH:mm:ssZ")">
    <meta property="article:modified_time" content="@Model.UpdatedAt.ToString("yyyy-MM-ddTHH:mm:ssZ")">
    <meta property="article:author" content="@Model.AuthorName">
    <meta property="article:section" content="@Model.CategoryName">
    @if (!string.IsNullOrEmpty(absoluteImageUrl))
    {
        <meta property="og:image" content="@absoluteImageUrl">
        <meta property="og:image:width" content="1200">
        <meta property="og:image:height" content="630">
        <meta property="og:image:alt" content="@Model.Title">
    }
    @foreach (var tag in Model.Tags)
    {
        <meta property="article:tag" content="@tag">
    }
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="@Model.CanonicalUrl">
    <meta name="twitter:title" content="@Model.Title">
    <meta name="twitter:description" content="@Model.MetaDescription">
    <meta name="twitter:site" content="@@Kokomija">
    <meta name="twitter:creator" content="@@Kokomija">
    @if (!string.IsNullOrEmpty(absoluteImageUrl))
    {
        <meta name="twitter:image" content="@absoluteImageUrl">
        <meta name="twitter:image:alt" content="@Model.Title">
    }

    <!-- JSON-LD Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "BlogPosting",
        "mainEntityOfPage": {
            "@@type": "WebPage",
            "@@id": "@Model.CanonicalUrl"
        },
        "headline": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.Title).ToString())",
        "description": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.MetaDescription ?? "").ToString())",
        @if (!string.IsNullOrEmpty(absoluteImageUrl))
        {
            <text>"image": {
            "@@type": "ImageObject",
            "url": "@absoluteImageUrl",
            "width": 1200,
            "height": 630
        },</text>
        }
        "author": {
            "@@type": "Person",
            "name": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.AuthorName ?? "").ToString())"
        },
        "publisher": {
            "@@type": "Organization",
            "name": "Kokomija",
            "logo": {
                "@@type": "ImageObject",
                "url": "@baseUrl/img/logo_black.png"
            }
        },
        "datePublished": "@Model.PublishedDate?.ToString("yyyy-MM-ddTHH:mm:ssZ")",
        "dateModified": "@Model.UpdatedAt.ToString("yyyy-MM-ddTHH:mm:ssZ")",
        "articleSection": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.CategoryName ?? "").ToString())",
        "keywords": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.MetaKeywords ?? "").ToString())",
        "wordCount": @(Model.Content?.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length ?? 0),
        "inLanguage": "@System.Globalization.CultureInfo.CurrentCulture.TwoLetterISOLanguageName"
    }
    </script>

    <!-- BreadcrumbList Structured Data -->
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "@baseUrl"
            },
            {
                "@@type": "ListItem",
                "position": 2,
                "name": "Blog",
                "item": "@baseUrl/blog"
            },
            {
                "@@type": "ListItem",
                "position": 3,
                "name": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.CategoryName ?? "").ToString())",
                "item": "@baseUrl/blog?categoryId=@Model.CategoryId"
            },
            {
                "@@type": "ListItem",
                "position": 4,
                "name": "@Html.Raw(System.Text.Json.JsonEncodedText.Encode(Model.Title).ToString())"
            }
        ]
    }
    </script>
}

<div class="blog-details-page">
    <!-- Article Header -->
    <article class="blog-article">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10 col-xl-8">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" class="mb-4">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">@L["Nav_Home"]</a></li>
                            <li class="breadcrumb-item"><a asp-controller="Blog" asp-action="Index">@L["Blog_Title"]</a></li>
                            <li class="breadcrumb-item"><a asp-action="Index" asp-route-categoryId="@Model.CategoryId">@Model.CategoryName</a></li>
                            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
                        </ol>
                    </nav>

                    <!-- Article Meta -->
                    <div class="article-meta mb-4">
                        <a asp-action="Index" asp-route-categoryId="@Model.CategoryId" class="category-badge-large">
                            @Model.CategoryName
                        </a>
                    </div>

                    <!-- Article Title -->
                    <h1 class="article-title">@Model.Title</h1>

                    <!-- Article Info -->
                    <div class="article-info">
                        <div class="author-info">
                            <div class="author-avatar">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div class="author-details">
                                <div class="author-name">@Model.AuthorName</div>
                                <div class="article-date">
                                    <i class="bi bi-calendar3"></i>
                                    @Model.PublishedDate?.ToString("MMMM dd, yyyy")
                                    @if (Model.UpdatedAt > Model.PublishedDate)
                                    {
                                        <span class="text-muted ms-2">
                                            (@L["Blog_Updated"]: @Model.UpdatedAt.ToString("MMM dd, yyyy"))
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="article-stats">
                            <span class="stat-item">
                                <i class="bi bi-clock"></i>
                                @Model.ReadingTimeMinutes @L["Blog_MinRead"]
                            </span>
                            <span class="stat-item">
                                <i class="bi bi-eye"></i>
                                @Model.Views @L["Blog_Views"]
                            </span>
                        </div>
                    </div>

                    <!-- Featured Image -->
                    @if (!string.IsNullOrEmpty(Model.FeaturedImage))
                    {
                        <div class="article-featured-image">
                            <img src="@Model.FeaturedImage" alt="@Model.Title" onerror="this.src='/img/logo_black.png'">
                        </div>
                    }

                    <!-- Article Content -->
                    <div class="article-content">
                        @Html.Raw(Model.Content)
                    </div>

                    <!-- Article Tags -->
                    @if (Model.Tags.Any())
                    {
                        <div class="article-tags">
                            <h5 class="tags-title">@L["Blog_Tags"]:</h5>
                            <div class="tags-list">
                                @foreach (var tag in Model.Tags)
                                {
                                    <a asp-action="Tag" asp-route-tag="@tag" class="tag-badge">#@tag</a>
                                }
                            </div>
                        </div>
                    }

                    <!-- Share Buttons -->
                    <div class="article-share">
                        <h5 class="share-title">@L["Blog_Share"]:</h5>
                        <div class="share-buttons">
                            <a href="https://www.facebook.com/sharer/sharer.php?u=@Uri.EscapeDataString(Model.CanonicalUrl)" 
                               target="_blank" 
                               class="share-btn share-facebook"
                               title="@L["Blog_ShareFacebook"]">
                                <i class="bi bi-facebook"></i>
                            </a>
                            <a href="https://twitter.com/intent/tweet?url=@Uri.EscapeDataString(Model.CanonicalUrl)&text=@Uri.EscapeDataString(Model.Title)" 
                               target="_blank" 
                               class="share-btn share-twitter"
                               title="@L["Blog_ShareTwitter"]">
                                <i class="bi bi-twitter"></i>
                            </a>
                            <a href="https://www.linkedin.com/shareArticle?mini=true&url=@Uri.EscapeDataString(Model.CanonicalUrl)&title=@Uri.EscapeDataString(Model.Title)" 
                               target="_blank" 
                               class="share-btn share-linkedin"
                               title="@L["Blog_ShareLinkedIn"]">
                                <i class="bi bi-linkedin"></i>
                            </a>
                            <a href="https://pinterest.com/pin/create/button/?url=@Uri.EscapeDataString(Model.CanonicalUrl)&description=@Uri.EscapeDataString(Model.Title)" 
                               target="_blank" 
                               class="share-btn share-pinterest"
                               title="@L["Blog_SharePinterest"]">
                                <i class="bi bi-pinterest"></i>
                            </a>
                            <button class="share-btn share-copy" 
                                    onclick="copyToClipboard('@Model.CanonicalUrl')"
                                    title="@L["Blog_CopyLink"]">
                                <i class="bi bi-link-45deg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Author Bio -->
                    <div class="author-bio-section">
                        <div class="author-bio-card">
                            <div class="author-avatar-large">
                                <i class="bi bi-person-circle"></i>
                            </div>
                            <div class="author-bio-content">
                                <h4 class="author-bio-name">@Model.AuthorName</h4>
                                <p class="author-bio-description">
                                    @(Model.AuthorBio ?? L["Blog_AuthorDefaultBio"])
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Related Product -->
                    @if (Model.RelatedProduct != null)
                    {
                        <div class="related-product-section">
                            <h3 class="section-title">@L["Blog_FeaturedProduct"]</h3>
                            <div class="related-product-card">
                                <div class="row align-items-center">
                                    <div class="col-md-4">
                                        @if (Model.RelatedProduct.Images.Any())
                                        {
                                            <img src="@Model.RelatedProduct.Images.First().ImageUrl" 
                                                 alt="@Model.RelatedProduct.Name" 
                                                 class="product-image"
                                                 onerror="this.src='/img/logo_black.png'">
                                        }
                                    </div>
                                    <div class="col-md-8">
                                        <h4 class="product-name">@Model.RelatedProduct.Name</h4>
                                        <p class="product-description">@Model.RelatedProduct.Description</p>
                                        <div class="product-price">
                                            @Model.RelatedProduct.Price.ToString("C")
                                        </div>
                                        <a asp-controller="Product" asp-action="Details" asp-route-id="@Model.RelatedProduct.Id" 
                                           class="btn btn-primary mt-3">
                                            @L["Blog_ViewProduct"] <i class="bi bi-arrow-right ms-2"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </article>

    <!-- Related Posts -->
    @if (Model.RelatedPosts.Any())
    {
        <section class="related-posts-section">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-10 col-xl-8">
                        <h3 class="section-title text-center mb-5">@L["Blog_RelatedPosts"]</h3>
                        <div class="row g-4">
                            @foreach (var post in Model.RelatedPosts)
                            {
                                <div class="col-md-4">
                                    <article class="related-post-card">
                                        @if (!string.IsNullOrEmpty(post.FeaturedImage))
                                        {
                                            <a href="@LocalizedUrl.GetBlogPostUrl(post.Slug)" class="related-post-image">
                                                <img src="@post.FeaturedImage" alt="@post.Title" onerror="this.src='/img/logo_black.png'">
                                            </a>
                                        }
                                        <div class="related-post-body">
                                            <div class="post-category-small">@post.CategoryName</div>
                                            <h5 class="related-post-title">
                                                <a href="@LocalizedUrl.GetBlogPostUrl(post.Slug)">@post.Title</a>
                                            </h5>
                                            <p class="related-post-excerpt">@post.Excerpt</p>
                                            <div class="related-post-meta">
                                                <span class="text-muted">
                                                    <i class="bi bi-calendar3"></i>
                                                    @post.PublishedDate?.ToString("MMM dd")
                                                </span>
                                                <span class="text-muted">
                                                    <i class="bi bi-clock"></i>
                                                    @post.ReadingTimeMinutes @L["Blog_Min"]
                                                </span>
                                            </div>
                                        </div>
                                    </article>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </section>
    }

    <!-- Back to Blog Button -->
    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8 text-center">
                <a asp-action="Index" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-arrow-left me-2"></i> @L["Blog_BackToBlog"]
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('@L["Blog_LinkCopied"]');
            }, function() {
                alert('@L["Blog_CopyFailed"]');
            });
        }

        // Convert CKEditor oembed tags to proper embeds (YouTube, Vimeo, etc.)
        document.addEventListener('DOMContentLoaded', function() {
            convertOembedToIframes();
        });

        function convertOembedToIframes() {
            // Find all oembed elements in article content
            const oembedElements = document.querySelectorAll('.article-content oembed[url], .article-content figure.media oembed');
            
            oembedElements.forEach(function(element) {
                const url = element.getAttribute('url');
                if (!url) return;

                const container = document.createElement('div');
                container.className = 'video-embed-container';
                
                const iframe = createIframeFromUrl(url);
                if (iframe) {
                    container.appendChild(iframe);
                    
                    // Replace the figure.media or oembed element
                    const figure = element.closest('figure.media') || element.parentElement;
                    if (figure && figure.tagName === 'FIGURE') {
                        figure.replaceWith(container);
                    } else {
                        element.replaceWith(container);
                    }
                }
            });

            // Also handle figures with data-oembed-url attribute
            const figuresWithOembed = document.querySelectorAll('.article-content figure[data-oembed-url]');
            figuresWithOembed.forEach(function(figure) {
                const url = figure.getAttribute('data-oembed-url');
                if (!url) return;

                const container = document.createElement('div');
                container.className = 'video-embed-container';
                
                const iframe = createIframeFromUrl(url);
                if (iframe) {
                    container.appendChild(iframe);
                    figure.replaceWith(container);
                }
            });
        }

        function createIframeFromUrl(url) {
            let embedUrl = null;
            
            // YouTube URLs
            const youtubeMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (youtubeMatch) {
                embedUrl = `https://www.youtube.com/embed/${youtubeMatch[1]}?rel=0&modestbranding=1`;
            }
            
            // Vimeo URLs
            const vimeoMatch = url.match(/(?:vimeo\.com\/)(\d+)/);
            if (vimeoMatch) {
                embedUrl = `https://player.vimeo.com/video/${vimeoMatch[1]}`;
            }

            // Dailymotion URLs
            const dailymotionMatch = url.match(/(?:dailymotion\.com\/video\/|dai\.ly\/)([a-zA-Z0-9]+)/);
            if (dailymotionMatch) {
                embedUrl = `https://www.dailymotion.com/embed/video/${dailymotionMatch[1]}`;
            }

            // Spotify URLs
            const spotifyMatch = url.match(/spotify\.com\/(track|album|playlist|episode)\/([a-zA-Z0-9]+)/);
            if (spotifyMatch) {
                embedUrl = `https://open.spotify.com/embed/${spotifyMatch[1]}/${spotifyMatch[2]}`;
            }

            if (embedUrl) {
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.setAttribute('frameborder', '0');
                iframe.setAttribute('allowfullscreen', 'true');
                iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
                iframe.setAttribute('loading', 'lazy');
                iframe.setAttribute('title', 'Embedded video');
                return iframe;
            }

            return null;
        }
    </script>
}

@section Styles {
    <style>
        /* Blog content responsive styles */
        .article-content {
            font-size: 1.125rem;
            line-height: 1.8;
            color: #333;
        }

        /* Make all images in blog content responsive */
        .article-content img {
            max-width: 100% !important;
            height: auto !important;
            display: block;
            margin: 2rem auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* CKEditor figure wrapper */
        .article-content figure {
            margin: 2rem 0;
            text-align: center;
        }

        .article-content figure img {
            max-width: 100% !important;
            height: auto !important;
        }

        .article-content figcaption {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #666;
            font-style: italic;
        }

        /* Video embed container for converted oembed */
        .article-content .video-embed-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            margin: 2rem 0;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            background: #000;
        }

        .article-content .video-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 12px;
        }

        /* YouTube and other iframe embeds - Responsive */
        .article-content iframe {
            max-width: 100% !important;
            width: 100% !important;
            height: auto !important;
            aspect-ratio: 16 / 9;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin: 2rem 0;
        }

        /* CKEditor media embed wrapper */
        .article-content .ck-media__wrapper,
        .article-content figure.media {
            position: relative;
            width: 100% !important;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            margin: 2rem 0;
            border-radius: 12px;
            background: #000;
        }

        .article-content .ck-media__wrapper iframe,
        .article-content figure.media iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            margin: 0;
            border: none;
        }

        /* Hide raw oembed tags before JS converts them */
        .article-content oembed {
            display: none;
        }

        /* Tables responsive */
        .article-content table {
            width: 100% !important;
            max-width: 100%;
            margin: 2rem 0;
            border-collapse: collapse;
            display: block;
            overflow-x: auto;
        }

        .article-content table td,
        .article-content table th {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
        }

        .article-content table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        /* Code blocks */
        .article-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            margin: 1.5rem 0;
        }

        .article-content code {
            background-color: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.875em;
        }

        /* Lists */
        .article-content ul,
        .article-content ol {
            margin: 1.5rem 0;
            padding-left: 2rem;
        }

        .article-content li {
            margin: 0.5rem 0;
        }

        /* Blockquotes */
        .article-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 1.5rem;
            margin: 2rem 0;
            font-style: italic;
            color: #666;
        }

        /* Headings in content */
        .article-content h2 {
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .article-content h3 {
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .article-content h4 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Links */
        .article-content a {
            color: #667eea;
            text-decoration: underline;
        }

        .article-content a:hover {
            color: #764ba2;
        }

        /* Mobile responsiveness */
        @@media (max-width: 768px) {
            .article-content {
                font-size: 1rem;
                line-height: 1.7;
            }

            .article-content img {
                margin: 1.5rem auto;
            }

            .article-content h2 {
                font-size: 1.5rem;
            }

            .article-content h3 {
                font-size: 1.25rem;
            }

            .article-content h4 {
                font-size: 1.125rem;
            }

            .article-content .video-embed-container {
                margin: 1.5rem 0;
                border-radius: 8px;
            }
        }

        /* Dark mode support */
        [data-bs-theme="dark"] .article-content {
            color: #e9ecef;
        }

        [data-bs-theme="dark"] .article-content blockquote {
            color: #adb5bd;
        }

        [data-bs-theme="dark"] .article-content pre,
        [data-bs-theme="dark"] .article-content code {
            background-color: #212529;
        }

        [data-bs-theme="dark"] .article-content table th {
            background-color: #343a40;
        }

        [data-bs-theme="dark"] .article-content table td,
        [data-bs-theme="dark"] .article-content table th {
            border-color: #495057;
        }
    </style>
}
