@using Kokomija.Entity
@using Kokomija.Models.ViewModels.Admin
@model BlogUpdateDto
@{
    ViewData["Title"] = "Edit Blog Post";
    List<BlogCategory>? categories = ViewBag.Categories as List<BlogCategory> ?? new List<BlogCategory>();
    List<Product>? products = ViewBag.Products as List<Product> ?? new List<Product>();
    string? ckEditorLicenseKey = ViewBag.CKEditorLicenseKey as string ?? "";
    BlogTranslationDto? enTranslation = Model.Translations?.FirstOrDefault(t => t.CultureCode == "en-US");
    BlogTranslationDto? plTranslation = Model.Translations?.FirstOrDefault(t => t.CultureCode == "pl-PL");
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />
    <style>
        .ck-editor__editable {
            min-height: 400px;
            max-height: 600px;
        }
        .nav-tabs-custom .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        .nav-tabs-custom .nav-link.active {
            color: #0d6efd;
            background: transparent;
            border-bottom: 3px solid #0d6efd;
        }
        .nav-tabs-custom .nav-link:hover {
            color: #0d6efd;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: #fff;
            border-bottom: 1px solid rgba(0,0,0,.05);
            padding: 1rem 1.25rem;
            font-weight: 600;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .15);
        }
        #autoSaveStatus {
            transition: all 0.3s ease;
        }
        .progress {
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .seo-suggestion {
            padding: 8px 12px;
            background: #fff8e1;
            border-left: 3px solid #ffc107;
            margin-bottom: 8px;
            border-radius: 0 4px 4px 0;
        }
        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        .image-preview-container .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .character-counter {
            font-size: 0.75rem;
            transition: color 0.2s;
        }
        .character-counter.warning {
            color: #ffc107;
        }
        .character-counter.danger {
            color: #dc3545;
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12 my-2">
            <div class="page-title-box d-flex align-items-center justify-content-between">
                <h4 class="">Edit Blog Post #@Model.Id</h4>
                <div class="page-title-right">
                    <ol class="breadcrumb m-0">
                        <li class="breadcrumb-item"><a asp-action="Index">Blogs</a></li>
                        <li class="breadcrumb-item active">Edit</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <form asp-action="Edit" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data" id="blogForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-lg-8">
                <!-- Language Tabs -->
                <div class="card">
                    <div class="card-body">
                        <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#english-tab" role="tab">
                                    <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                                    <span class="d-none d-sm-block">English</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#polish-tab" role="tab">
                                    <span class="d-block d-sm-none"><i class="far fa-user"></i></span>
                                    <span class="d-none d-sm-block">Polski</span>
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content p-3 text-muted">
                            <!-- English Translation -->
                            <div class="tab-pane active" id="english-tab" role="tabpanel">
                                <input type="hidden" name="Translations[0].CultureCode" value="en-US" />
                                <input type="hidden" name="Translations[0].Id" value="@(enTranslation?.Id ?? 0)" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Title <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="Translations[0].Title" 
                                           id="titleEn" value="@(enTranslation?.Title ?? "")" 
                                           placeholder="Enter blog title" required maxlength="200" />
                                    <span asp-validation-for="Translations[0].Title" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Slug <small class="text-muted">(max 200 chars)</small></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="Translations[0].Slug" 
                                               id="slugEn" value="@(enTranslation?.Slug ?? "")" 
                                               placeholder="auto-generated-slug" maxlength="200" />
                                        <button type="button" class="btn btn-outline-secondary" id="generateSlugEn">
                                            <i class="fas fa-sync-alt"></i> Generate
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="validateSlugEn">
                                            <i class="fas fa-check"></i> Validate
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Leave empty for auto-generation from title</small>
                                    <div id="slugValidationEn" class="mt-1"></div>
                                    <span asp-validation-for="Translations[0].Slug" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Content <span class="text-danger">*</span></label>
                                    <textarea name="Translations[0].Content" id="contentEn" class="ckeditor">@Html.Raw(enTranslation?.Content ?? "")</textarea>
                                    <span asp-validation-for="Translations[0].Content" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Excerpt <small class="text-muted">(max 500 chars)</small></label>
                                    <textarea class="form-control" name="Translations[0].Excerpt" 
                                              id="excerptEn" rows="3" placeholder="Brief summary (optional)" 
                                              maxlength="500">@(enTranslation?.Excerpt ?? "")</textarea>
                                    <small class="form-text text-muted">
                                        Used in blog listings and previews. <span id="excerptCountEn">@((enTranslation?.Excerpt ?? "").Length)</span>/500 characters
                                    </small>
                                    <span asp-validation-for="Translations[0].Excerpt" class="text-danger"></span>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Description <small class="text-muted">(max 160 chars)</small></label>
                                        <textarea class="form-control" name="Translations[0].MetaDescription" 
                                                  id="metaDescEn" rows="2" maxlength="160" 
                                                  placeholder="SEO meta description">@(enTranslation?.MetaDescription ?? "")</textarea>
                                        <small class="form-text text-muted">
                                            <span id="metaDescCountEn">@((enTranslation?.MetaDescription ?? "").Length)</span>/160 characters
                                        </small>
                                        <span asp-validation-for="Translations[0].MetaDescription" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Keywords <small class="text-muted">(max 500 chars)</small></label>
                                        <input type="text" class="form-control" name="Translations[0].MetaKeywords" 
                                               id="metaKeywordsEn" value="@(enTranslation?.MetaKeywords ?? "")"
                                               placeholder="keyword1, keyword2, keyword3" maxlength="500" />
                                        <small class="form-text text-muted">Comma-separated keywords</small>
                                        <span asp-validation-for="Translations[0].MetaKeywords" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tags <small class="text-muted">(max 500 chars)</small></label>
                                    <input type="text" class="form-control" name="Translations[0].Tags" 
                                           id="tagsEn" value="@(enTranslation?.Tags ?? "")"
                                           placeholder="tag1, tag2, tag3" maxlength="500" />
                                    <small class="form-text text-muted">Comma-separated tags for categorization</small>
                                    <span asp-validation-for="Translations[0].Tags" class="text-danger"></span>
                                </div>
                            </div>

                            <!-- Polish Translation -->
                            <div class="tab-pane" id="polish-tab" role="tabpanel">
                                <input type="hidden" name="Translations[1].CultureCode" value="pl-PL" />
                                <input type="hidden" name="Translations[1].Id" value="@(plTranslation?.Id ?? 0)" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Tytu≈Ç <small class="text-muted">(max 200 znak√≥w)</small></label>
                                    <input type="text" class="form-control" name="Translations[1].Title" 
                                           id="titlePl" value="@(plTranslation?.Title ?? "")"
                                           placeholder="Wprowad≈∫ tytu≈Ç bloga" maxlength="200" />
                                    <span asp-validation-for="Translations[1].Title" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Slug <small class="text-muted">(max 200 znak√≥w)</small></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="Translations[1].Slug" 
                                               id="slugPl" value="@(plTranslation?.Slug ?? "")"
                                               placeholder="automatycznie-generowany-slug" maxlength="200" />
                                        <button type="button" class="btn btn-outline-secondary" id="generateSlugPl">
                                            <i class="fas fa-sync-alt"></i> Generuj
                                        </button>
                                        <button type="button" class="btn btn-outline-info" id="validateSlugPl">
                                            <i class="fas fa-check"></i> Sprawd≈∫
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Zostaw puste dla automatycznego generowania</small>
                                    <div id="slugValidationPl" class="mt-1"></div>
                                    <span asp-validation-for="Translations[1].Slug" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tre≈õƒá</label>
                                    <textarea name="Translations[1].Content" id="contentPl" class="ckeditor">@Html.Raw(plTranslation?.Content ?? "")</textarea>
                                    <span asp-validation-for="Translations[1].Content" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Excerpt <small class="text-muted">(max 500 znak√≥w)</small></label>
                                    <textarea class="form-control" name="Translations[1].Excerpt" 
                                              id="excerptPl" rows="3" placeholder="Kr√≥tkie podsumowanie (opcjonalne)" 
                                              maxlength="500">@(plTranslation?.Excerpt ?? "")</textarea>
                                    <small class="form-text text-muted">
                                        <span id="excerptCountPl">@((plTranslation?.Excerpt ?? "").Length)</span>/500 znak√≥w
                                    </small>
                                    <span asp-validation-for="Translations[1].Excerpt" class="text-danger"></span>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Opis <small class="text-muted">(max 160 znak√≥w)</small></label>
                                        <textarea class="form-control" name="Translations[1].MetaDescription" 
                                                  id="metaDescPl" rows="2" maxlength="160" 
                                                  placeholder="SEO meta opis">@(plTranslation?.MetaDescription ?? "")</textarea>
                                        <small class="form-text text-muted">
                                            <span id="metaDescCountPl">@((plTranslation?.MetaDescription ?? "").Length)</span>/160 znak√≥w
                                        </small>
                                        <span asp-validation-for="Translations[1].MetaDescription" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta S≈Çowa Kluczowe <small class="text-muted">(max 500 znak√≥w)</small></label>
                                        <input type="text" class="form-control" name="Translations[1].MetaKeywords" 
                                               id="metaKeywordsPl" value="@(plTranslation?.MetaKeywords ?? "")"
                                               placeholder="s≈Çowo1, s≈Çowo2, s≈Çowo3" maxlength="500" />
                                        <span asp-validation-for="Translations[1].MetaKeywords" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Tagi <small class="text-muted">(max 500 znak√≥w)</small></label>
                                    <input type="text" class="form-control" name="Translations[1].Tags" 
                                           id="tagsPl" value="@(plTranslation?.Tags ?? "")"
                                           placeholder="tag1, tag2, tag3" maxlength="500" />
                                    <span asp-validation-for="Translations[1].Tags" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEO Analysis Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line"></i> SEO Analysis
                            <button type="button" class="btn btn-sm btn-outline-primary float-end" id="analyzeSeoBtn">
                                <i class="fas fa-sync-alt"></i> Analyze
                            </button>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="seoAnalysisResult" class="d-none">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span><strong>SEO Score:</strong></span>
                                    <span id="seoScore" class="badge bg-secondary">0%</span>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div id="seoProgressBar" class="progress-bar" role="progressbar" 
                                         style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                </div>
                            </div>
                            <div id="seoStats" class="mb-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted">Word Count</small>
                                        <h5 id="wordCount">0</h5>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Reading Time</small>
                                        <h5 id="readingTime">0 min</h5>
                                    </div>
                                </div>
                            </div>
                            <div id="seoSuggestions"></div>
                        </div>
                        <div id="seoAnalysisPlaceholder" class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-3x mb-3"></i>
                            <p>Click "Analyze" to check your SEO score</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Publish Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Publish</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" asp-for="IsPublished" id="publishStatus">
                                <option value="false">Draft</option>
                                <option value="true">Published</option>
                            </select>
                        </div>

                        <div class="mb-3" id="publishDateGroup" style="display: @(Model.IsPublished ? "block" : "none");">
                            <label class="form-label">Publish Date</label>
                            <input type="datetime-local" class="form-control" asp-for="PublishedDate" 
                                   id="publishedDate" value="@(Model.PublishedDate?.ToString("yyyy-MM-ddTHH:mm") ?? DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm"))" />
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" asp-for="AllowComments" 
                                   id="allowComments" />
                            <label class="form-check-label" for="allowComments">
                                Allow Comments
                            </label>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Update Blog
                            </button>
                            <button type="button" class="btn btn-outline-success" id="togglePublishBtn">
                                <i class="fas fa-toggle-on"></i> @(Model.IsPublished ? "Unpublish" : "Publish")
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="saveDraftBtn">
                                <i class="fas fa-file-alt"></i> Save as Draft
                            </button>
                            <a asp-action="Index" class="btn btn-outline-danger">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Featured Image Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Featured Image</h5>
                    </div>
                    <div class="card-body">
                        <div id="imagePreview" class="mb-3 text-center @(string.IsNullOrEmpty(Model.FeaturedImage) ? "d-none" : "")">
                            <img id="previewImg" src="@(Model.FeaturedImage ?? "")" alt="Preview" class="img-fluid rounded" style="max-height: 200px;" />
                            <button type="button" class="btn btn-sm btn-danger mt-2" id="removeImageBtn">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <input type="file" class="form-control" id="featuredImageInput" accept="image/*" />
                        <input type="hidden" asp-for="FeaturedImage" id="featuredImageUrl" />
                        <input type="hidden" id="imageTempFileName" />
                        <small class="form-text text-muted d-block mt-2">
                            Recommended: 1200x630px, Max: 10MB<br/>
                            Formats: JPG, PNG, GIF, WEBP
                        </small>
                    </div>
                </div>

                <!-- Category Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Category <span class="text-danger">*</span></h5>
                    </div>
                    <div class="card-body">
                        <select class="form-select" asp-for="CategoryId" id="categorySelect" required>
                            <option value="">Select Category</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                    </div>
                </div>

                <!-- Product Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Related Product (Optional)</h5>
                    </div>
                    <div class="card-body">
                        <select class="form-select" asp-for="ProductId" id="productSelect">
                            <option value="">No Product</option>
                            @foreach (var product in products)
                            {
                                <option value="@product.Id">@product.Name</option>
                            }
                        </select>
                        <small class="form-text text-muted d-block mt-2">
                            Link this blog post to a product
                        </small>
                    </div>
                </div>

                <!-- Auto-save Indicator -->
                <div class="card">
                    <div class="card-body text-center">
                        <div id="autoSaveStatus" class="text-muted">
                            <i class="fas fa-cloud"></i> Auto-save ready
                        </div>
                        <small class="text-muted" id="lastSaved"></small>
                    </div>
                </div>

                <!-- Delete Card -->
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="card-title mb-0">Danger Zone</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small">Once you delete this blog post, it will be moved to trash. You can restore it later from the admin panel.</p>
                        <form asp-action="Delete" asp-route-id="@Model.Id" method="post" id="deleteForm" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <button type="button" class="btn btn-danger w-100" id="deleteBtn">
                                <i class="fas fa-trash"></i> Delete Blog Post
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
    <partial name="_ValidationScriptsPartial" />

    <script>
        // CKEditor instances
        let ckEditorEn = null;
        let ckEditorPl = null;
        let autoSaveTimer = null;
        const autoSaveInterval = 60000; // Auto-save every 60 seconds
        const blogId = @Model.Id;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ============================================
        // FORM PERSISTENCE (Protection against page refresh)
        // ============================================
        const STORAGE_KEY = 'blog_edit_form_data_' + blogId;
        const IMAGE_STORAGE_KEY = 'blog_edit_featured_image_' + blogId;
        
        function saveFormToStorage() {
            try {
                const formData = collectFormData();
                sessionStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
                console.log('üìù Form data saved to session storage');
            } catch (error) {
                console.error('Failed to save form data:', error);
            }
        }

        function saveImageToStorage(file, previewUrl) {
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        base64: e.target.result,
                        name: file.name,
                        type: file.type,
                        previewUrl: previewUrl
                    };
                    sessionStorage.setItem(IMAGE_STORAGE_KEY, JSON.stringify(imageData));
                    console.log('üñºÔ∏è Image saved to session storage');
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('Failed to save image:', error);
            }
        }

        function restoreFormFromStorage() {
            try {
                const savedData = sessionStorage.getItem(STORAGE_KEY);
                if (!savedData) return false;

                const formData = JSON.parse(savedData);
                
                // Only restore if data is newer than server data
                // Skip restoring if the form was just loaded with fresh data
                
                // Restore basic fields
                const categorySelect = document.getElementById('categorySelect');
                if (categorySelect && formData.CategoryId) {
                    categorySelect.value = formData.CategoryId;
                }

                const productSelect = document.getElementById('productSelect');
                if (productSelect && formData.ProductId) {
                    productSelect.value = formData.ProductId;
                }

                const publishedDate = document.getElementById('publishedDate');
                if (publishedDate && formData.PublishedDate) {
                    publishedDate.value = formData.PublishedDate.split('T')[0];
                }
                
                const allowComments = document.getElementById('allowComments');
                if (allowComments) allowComments.checked = formData.AllowComments !== false;

                // Restore translations
                if (formData.Translations && formData.Translations.length >= 2) {
                    const enTrans = formData.Translations[0];
                    setFieldValue('titleEn', enTrans.Title);
                    setFieldValue('slugEn', enTrans.Slug);
                    setFieldValue('excerptEn', enTrans.Excerpt);
                    setFieldValue('metaDescEn', enTrans.MetaDescription);
                    setFieldValue('metaKeywordsEn', enTrans.MetaKeywords);
                    setFieldValue('tagsEn', enTrans.Tags);
                    window.pendingContentEn = enTrans.Content;

                    const plTrans = formData.Translations[1];
                    setFieldValue('titlePl', plTrans.Title);
                    setFieldValue('slugPl', plTrans.Slug);
                    setFieldValue('excerptPl', plTrans.Excerpt);
                    setFieldValue('metaDescPl', plTrans.MetaDescription);
                    setFieldValue('metaKeywordsPl', plTrans.MetaKeywords);
                    setFieldValue('tagsPl', plTrans.Tags);
                    window.pendingContentPl = plTrans.Content;
                }

                console.log('‚úÖ Form data restored from session storage');
                showRestoreNotification();
                return true;
            } catch (error) {
                console.error('Failed to restore form data:', error);
                return false;
            }
        }

        function restoreImageFromStorage() {
            try {
                const savedImage = sessionStorage.getItem(IMAGE_STORAGE_KEY);
                if (!savedImage) return;

                const imageData = JSON.parse(savedImage);
                
                const previewImg = document.getElementById('previewImg');
                if (previewImg) {
                    previewImg.src = imageData.base64;
                    document.getElementById('imagePreview')?.classList.remove('d-none');
                    reuploadImageFromBase64(imageData);
                }
                
                console.log('üñºÔ∏è Image restored from session storage');
            } catch (error) {
                console.error('Failed to restore image:', error);
            }
        }

        async function reuploadImageFromBase64(imageData) {
            try {
                const response = await fetch(imageData.base64);
                const blob = await response.blob();
                const file = new File([blob], imageData.name, { type: imageData.type });
                
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch('@Url.Action("UploadImage", "AdminBlog")', {
                    method: 'POST',
                    body: formData
                });

                const result = await uploadResponse.json();
                
                if (result.success) {
                    document.getElementById('featuredImageUrl').value = result.tempUrl;
                    document.getElementById('imageTempFileName').value = result.tempFileName;
                    console.log('üîÑ Image re-uploaded successfully');
                }
            } catch (error) {
                console.error('Failed to re-upload image:', error);
            }
        }

        function setFieldValue(id, value) {
            const field = document.getElementById(id);
            if (field && value) {
                field.value = value;
                field.dispatchEvent(new Event('input'));
            }
        }

        function showRestoreNotification() {
            const toast = document.createElement('div');
            toast.className = 'alert alert-info alert-dismissible fade show position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: slideIn 0.3s ease;';
            toast.innerHTML = `
                <i class="fas fa-magic me-2"></i>
                <strong>Form Restored!</strong> Your previous work has been recovered.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function clearFormStorage() {
            sessionStorage.removeItem(STORAGE_KEY);
            sessionStorage.removeItem(IMAGE_STORAGE_KEY);
            console.log('üóëÔ∏è Form storage cleared');
        }

        function setupFormPersistence() {
            const form = document.getElementById('blogForm');
            if (form) {
                form.addEventListener('input', debounce(saveFormToStorage, 1000));
                form.addEventListener('change', saveFormToStorage);
            }

            form?.addEventListener('submit', function(e) {
                if (validateForm()) {
                    clearFormStorage();
                }
            });

            window.addEventListener('beforeunload', saveFormToStorage);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeEditors();
            setupEventListeners();
            setupAutoSave();
            console.log('‚úÖ Blog Editor initialized for editing blog #' + blogId);
        });

        async function initializeEditors() {
            const { ClassicEditor, Essentials, Paragraph, Bold, Italic, Underline, Strikethrough, 
                    Link, List, BlockQuote, Heading, Image, ImageToolbar, ImageCaption, ImageStyle, 
                    ImageResize, ImageUpload, SimpleUploadAdapter, Table, TableToolbar, 
                    MediaEmbed, Indent, Alignment, Font, HorizontalLine, SourceEditing, 
                    FindAndReplace, RemoveFormat } = CKEDITOR;

            const editorConfig = {
                licenseKey: '@ckEditorLicenseKey' || 'GPL',
                plugins: [
                    Essentials, Paragraph, Bold, Italic, Underline, Strikethrough,
                    Link, List, BlockQuote, Heading, Image, ImageToolbar, ImageCaption, 
                    ImageStyle, ImageResize, ImageUpload, SimpleUploadAdapter, Table, 
                    TableToolbar, MediaEmbed, Indent, Alignment, Font, HorizontalLine,
                    SourceEditing, FindAndReplace, RemoveFormat
                ],
                toolbar: {
                    items: [
                        'heading', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|',
                        'link', 'uploadImage', 'mediaEmbed', 'insertTable', 'blockQuote', '|',
                        'bulletedList', 'numberedList', '|',
                        'outdent', 'indent', 'alignment', '|',
                        'fontSize', 'fontColor', 'fontBackgroundColor', '|',
                        'horizontalLine', 'removeFormat', '|',
                        'findAndReplace', 'sourceEditing', '|',
                        'undo', 'redo'
                    ],
                    shouldNotGroupWhenFull: true
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                        { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                        { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                        { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' }
                    ]
                },
                image: {
                    toolbar: [
                        'imageTextAlternative', 'toggleImageCaption', '|',
                        'imageStyle:inline', 'imageStyle:block', 'imageStyle:side'
                    ]
                },
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                },
                simpleUpload: {
                    uploadUrl: '@Url.Action("UploadCKEditorImage", "AdminBlog")',
                    withCredentials: true,
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                }
            };

            try {
                // First, restore form data if available (before CKEditor init)
                const hasRestoredData = restoreFormFromStorage();
                
                const enElement = document.getElementById('contentEn');
                if (enElement) {
                    ckEditorEn = await ClassicEditor.create(enElement, editorConfig);
                    console.log('‚úÖ English CKEditor initialized');
                    
                    // Restore content if we have pending content from storage
                    if (window.pendingContentEn) {
                        ckEditorEn.setData(window.pendingContentEn);
                        delete window.pendingContentEn;
                    }
                    
                    // Save to storage when content changes
                    ckEditorEn.model.document.on('change:data', debounce(saveFormToStorage, 2000));
                }

                const plElement = document.getElementById('contentPl');
                if (plElement) {
                    ckEditorPl = await ClassicEditor.create(plElement, editorConfig);
                    console.log('‚úÖ Polish CKEditor initialized');
                    
                    // Restore content if we have pending content from storage
                    if (window.pendingContentPl) {
                        ckEditorPl.setData(window.pendingContentPl);
                        delete window.pendingContentPl;
                    }
                    
                    // Save to storage when content changes
                    ckEditorPl.model.document.on('change:data', debounce(saveFormToStorage, 2000));
                }
                
                // Restore image after editors are ready
                if (hasRestoredData) {
                    restoreImageFromStorage();
                }
                
                // Set up form persistence after everything is initialized
                setupFormPersistence();
                
            } catch (error) {
                console.error('CKEditor initialization error:', error);
            }
        }

        function setupEventListeners() {
            document.getElementById('publishStatus')?.addEventListener('change', function() {
                document.getElementById('publishDateGroup').style.display = this.value === 'true' ? 'block' : 'none';
            });

            document.getElementById('categorySelect')?.addEventListener('change', function() {
                loadProductsByCategory(this.value);
            });

            document.getElementById('featuredImageInput')?.addEventListener('change', function() {
                if (this.files && this.files[0]) uploadFeaturedImage(this.files[0]);
            });

            document.getElementById('removeImageBtn')?.addEventListener('click', cancelImageUpload);

            document.getElementById('generateSlugEn')?.addEventListener('click', () => generateSlug('En'));
            document.getElementById('generateSlugPl')?.addEventListener('click', () => generateSlug('Pl'));
            document.getElementById('validateSlugEn')?.addEventListener('click', () => validateSlug('En'));
            document.getElementById('validateSlugPl')?.addEventListener('click', () => validateSlug('Pl'));

            document.getElementById('analyzeSeoBtn')?.addEventListener('click', analyzeSEO);

            setupCharacterCounter('metaDescEn', 'metaDescCountEn', 160);
            setupCharacterCounter('metaDescPl', 'metaDescCountPl', 160);
            setupCharacterCounter('excerptEn', 'excerptCountEn', 500);
            setupCharacterCounter('excerptPl', 'excerptCountPl', 500);

            document.getElementById('togglePublishBtn')?.addEventListener('click', togglePublish);
            document.getElementById('saveDraftBtn')?.addEventListener('click', function() {
                document.getElementById('publishStatus').value = 'false';
                document.getElementById('blogForm').submit();
            });
            document.getElementById('deleteBtn')?.addEventListener('click', confirmDelete);

            document.getElementById('blogForm')?.addEventListener('submit', function(e) {
                syncEditorContent();
                if (!validateForm()) e.preventDefault();
            });
        }

        function syncEditorContent() {
            if (ckEditorEn) {
                const hiddenEn = document.querySelector('textarea[name="Translations[0].Content"]');
                if (hiddenEn) hiddenEn.value = ckEditorEn.getData();
            }
            if (ckEditorPl) {
                const hiddenPl = document.querySelector('textarea[name="Translations[1].Content"]');
                if (hiddenPl) hiddenPl.value = ckEditorPl.getData();
            }
        }

        function setupCharacterCounter(inputId, counterId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            if (!input || !counter) return;

            input.addEventListener('input', function() {
                const len = this.value.length;
                counter.textContent = len;
                counter.classList.remove('warning', 'danger');
                if (len > maxLength * 0.9) counter.classList.add('danger');
                else if (len > maxLength * 0.7) counter.classList.add('warning');
            });
        }

        function setupAutoSave() {
            autoSaveTimer = setInterval(autoSaveDraft, autoSaveInterval);
        }

        async function autoSaveDraft() {
            const formData = collectFormData();
            if (!formData.Translations[0].Title) return;

            updateAutoSaveStatus('saving');
            
            try {
                const response = await fetch('@Url.Action("AutoSaveDraft", "AdminBlog")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                updateAutoSaveStatus(result.success ? 'saved' : 'error', result.timestamp);
            } catch (error) {
                console.error('Auto-save error:', error);
                updateAutoSaveStatus('error');
            }
        }

        function updateAutoSaveStatus(status, timestamp) {
            const statusEl = document.getElementById('autoSaveStatus');
            const lastSavedEl = document.getElementById('lastSaved');
            if (!statusEl) return;
            
            const icons = {
                saving: '<i class="fas fa-spinner fa-spin"></i> Saving...',
                saved: '<i class="fas fa-cloud-check text-success"></i> Saved',
                error: '<i class="fas fa-exclamation-triangle text-danger"></i> Save failed'
            };
            
            statusEl.innerHTML = icons[status] || icons.error;
            statusEl.className = status === 'saved' ? 'text-success' : status === 'error' ? 'text-danger' : 'text-info';
            
            if (timestamp && lastSavedEl) {
                const date = new Date(timestamp);
                lastSavedEl.textContent = 'Last saved: ' + date.toLocaleTimeString();
            }
        }

        function collectFormData() {
            return {
                Id: blogId,
                CategoryId: parseInt(document.getElementById('categorySelect')?.value) || 0,
                ProductId: document.getElementById('productSelect')?.value ? parseInt(document.getElementById('productSelect').value) : null,
                FeaturedImage: document.getElementById('featuredImageUrl')?.value || '',
                IsPublished: document.getElementById('publishStatus')?.value === 'true',
                PublishedDate: document.getElementById('publishedDate')?.value || null,
                AllowComments: document.getElementById('allowComments')?.checked ?? true,
                Translations: [
                    {
                        CultureCode: 'en-US',
                        Title: document.getElementById('titleEn')?.value || '',
                        Slug: document.getElementById('slugEn')?.value || '',
                        Content: ckEditorEn ? ckEditorEn.getData() : '',
                        Excerpt: document.getElementById('excerptEn')?.value || '',
                        MetaDescription: document.getElementById('metaDescEn')?.value || '',
                        MetaKeywords: document.getElementById('metaKeywordsEn')?.value || '',
                        Tags: document.getElementById('tagsEn')?.value || ''
                    },
                    {
                        CultureCode: 'pl-PL',
                        Title: document.getElementById('titlePl')?.value || '',
                        Slug: document.getElementById('slugPl')?.value || '',
                        Content: ckEditorPl ? ckEditorPl.getData() : '',
                        Excerpt: document.getElementById('excerptPl')?.value || '',
                        MetaDescription: document.getElementById('metaDescPl')?.value || '',
                        MetaKeywords: document.getElementById('metaKeywordsPl')?.value || '',
                        Tags: document.getElementById('tagsPl')?.value || ''
                    }
                ]
            };
        }

        async function uploadFeaturedImage(file) {
            // Save image to storage first (for recovery) - as base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = {
                    base64: e.target.result,
                    name: file.name,
                    type: file.type
                };
                sessionStorage.setItem(IMAGE_STORAGE_KEY, JSON.stringify(imageData));
                console.log('üñºÔ∏è Image saved to session storage');
            };
            reader.readAsDataURL(file);
            
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('@Url.Action("UploadImage", "AdminBlog")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('previewImg').src = result.tempUrl;
                    document.getElementById('imagePreview').classList.remove('d-none');
                    document.getElementById('featuredImageUrl').value = result.tempUrl;
                    document.getElementById('imageTempFileName').value = result.tempFileName;
                    
                    // Save form data after successful image upload
                    saveFormToStorage();
                } else {
                    alert('Upload failed: ' + result.message);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed');
            }
        }

        async function cancelImageUpload() {
            const tempFileName = document.getElementById('imageTempFileName')?.value;
            
            if (tempFileName) {
                try {
                    await fetch('@Url.Action("CancelUpload", "AdminBlog")', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ imageTempFileName: tempFileName })
                    });
                } catch (error) {
                    console.error('Cancel upload error:', error);
                }
            }

            document.getElementById('imagePreview')?.classList.add('d-none');
            const previewImg = document.getElementById('previewImg');
            if (previewImg) previewImg.src = '';
            const featuredUrl = document.getElementById('featuredImageUrl');
            if (featuredUrl) featuredUrl.value = '';
            const tempFileInput = document.getElementById('imageTempFileName');
            if (tempFileInput) tempFileInput.value = '';
            const fileInput = document.getElementById('featuredImageInput');
            if (fileInput) fileInput.value = '';
        }

        async function loadProductsByCategory(categoryId) {
            if (!categoryId) return;

            try {
                const response = await fetch('@Url.Action("GetProductsByCategory", "AdminBlog")?categoryId=' + categoryId);
                const result = await response.json();
                
                if (result.success) {
                    const currentProductId = document.getElementById('productSelect')?.value;
                    let html = '<option value="">No Product</option>';
                    result.products.forEach(p => {
                        const selected = p.id == currentProductId ? 'selected' : '';
                        html += `<option value="${p.id}" ${selected}>${p.name}</option>`;
                    });
                    document.getElementById('productSelect').innerHTML = html;
                }
            } catch (error) {
                console.error('Load products error:', error);
            }
        }

        function generateSlug(lang) {
            const title = document.getElementById('title' + lang)?.value;
            if (!title) {
                alert('Please enter a title first');
                return;
            }

            let slug = title.toLowerCase()
                .replace(/ƒÖ/g, 'a').replace(/ƒá/g, 'c').replace(/ƒô/g, 'e')
                .replace(/≈Ç/g, 'l').replace(/≈Ñ/g, 'n').replace(/√≥/g, 'o')
                .replace(/≈õ/g, 's').replace(/≈∫/g, 'z').replace(/≈º/g, 'z')
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-+|-+$/g, '')
                .substring(0, 200);

            const slugInput = document.getElementById('slug' + lang);
            if (slugInput) slugInput.value = slug;
        }

        async function validateSlug(lang) {
            const slug = document.getElementById('slug' + lang)?.value;
            const cultureCode = lang === 'En' ? 'en-US' : 'pl-PL';
            const validationDiv = document.getElementById('slugValidation' + lang);

            if (!slug || !validationDiv) {
                if (validationDiv) validationDiv.innerHTML = '';
                return;
            }

            try {
                const response = await fetch('@Url.Action("ValidateSlug", "AdminBlog")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ slug: slug, cultureCode: cultureCode, blogId: blogId })
                });

                const result = await response.json();
                validationDiv.innerHTML = result.success 
                    ? '<small class="text-success"><i class="fas fa-check-circle"></i> Slug is available</small>'
                    : '<small class="text-danger"><i class="fas fa-times-circle"></i> ' + result.message + '</small>';
            } catch (error) {
                console.error('Validate slug error:', error);
            }
        }

        async function analyzeSEO() {
            const titleEn = document.getElementById('titleEn')?.value || '';
            const contentEn = ckEditorEn ? ckEditorEn.getData() : '';
            const metaDescEn = document.getElementById('metaDescEn')?.value || '';
            const keywordsEn = document.getElementById('metaKeywordsEn')?.value || '';

            if (!titleEn && !contentEn) {
                alert('Please add at least a title and content to analyze');
                return;
            }

            try {
                const response = await fetch('@Url.Action("AnalyzeSEO", "AdminBlog")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: titleEn,
                        content: contentEn,
                        metaDescription: metaDescEn,
                        keywords: keywordsEn
                    })
                });

                const result = await response.json();
                if (result.success) displaySEOAnalysis(result.data);
            } catch (error) {
                console.error('SEO analysis error:', error);
            }
        }

        function displaySEOAnalysis(data) {
            document.getElementById('seoAnalysisPlaceholder')?.classList.add('d-none');
            document.getElementById('seoAnalysisResult')?.classList.remove('d-none');

            const score = data.percentage || 0;
            const progressBar = document.getElementById('seoProgressBar');
            const seoScore = document.getElementById('seoScore');
            
            if (progressBar) {
                progressBar.style.width = score + '%';
                progressBar.setAttribute('aria-valuenow', score);
                progressBar.textContent = score + '%';
                progressBar.className = 'progress-bar ' + (score >= 80 ? 'bg-success' : score >= 60 ? 'bg-warning' : 'bg-danger');
            }
            
            if (seoScore) {
                seoScore.textContent = score + '%';
                seoScore.className = 'badge ' + (score >= 80 ? 'bg-success' : score >= 60 ? 'bg-warning' : 'bg-danger');
            }

            const wordCount = document.getElementById('wordCount');
            const readingTime = document.getElementById('readingTime');
            if (wordCount) wordCount.textContent = data.wordCount || 0;
            if (readingTime) readingTime.textContent = (data.readingTime || 0) + ' min';

            const suggestionsDiv = document.getElementById('seoSuggestions');
            if (suggestionsDiv) {
                if (data.suggestions && data.suggestions.length > 0) {
                    let html = '<h6 class="mb-3">Suggestions:</h6>';
                    data.suggestions.forEach(s => {
                        html += `<div class="seo-suggestion"><i class="fas fa-lightbulb text-warning me-2"></i>${s}</div>`;
                    });
                    suggestionsDiv.innerHTML = html;
                } else {
                    suggestionsDiv.innerHTML = '<div class="alert alert-success mb-0"><i class="fas fa-check-circle me-2"></i>Great! Your content is well-optimized.</div>';
                }
            }
        }

        async function togglePublish() {
            if (!confirm('Are you sure you want to change the publish status?')) return;

            try {
                const response = await fetch('@Url.Action("TogglePublish", "AdminBlog")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ id: blogId })
                });

                const result = await response.json();
                if (result.success) location.reload();
                else alert('Failed to toggle publish status: ' + result.message);
            } catch (error) {
                console.error('Toggle publish error:', error);
                alert('Failed to toggle publish status');
            }
        }

        function confirmDelete() {
            if (confirm('Are you sure you want to delete this blog post? This action can be undone from the admin panel.')) {
                document.getElementById('deleteForm').submit();
            }
        }

        function validateForm() {
            const titleEn = document.getElementById('titleEn')?.value;
            const categoryId = document.getElementById('categorySelect')?.value;

            if (!titleEn?.trim()) {
                alert('Please enter an English title');
                return false;
            }

            if (!categoryId) {
                alert('Please select a category');
                return false;
            }

            return true;
        }

        window.addEventListener('beforeunload', function() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
        });
    </script>
}
