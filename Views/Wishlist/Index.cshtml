@model IEnumerable<Kokomija.Entity.Wishlist>
@inject Kokomija.Services.ILocalizationService L

@{
    ViewData["Title"] = L["Wishlist_Title"];
}

<div class="wishlist-page container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">
            <i class="fas fa-heart text-danger me-2"></i>
            @L.GetString("Title", "Wishlist")
        </h1>
        <span class="badge bg-primary">@Model.Count() @L.GetString("Items", "Wishlist")</span>
    </div>

    @if (Model.Any())
    {
        <div class="row g-4">
            @foreach (var item in Model)
            {
                var product = item.Product;
                var productName = product.Name;
                var imageUrl = product.Images?.OrderBy(i => i.DisplayOrder).FirstOrDefault()?.ImageUrl ?? "logo_black.png";
                var hasDiscount = product.Price < (product.Price * 1.1m); // Example discount check

                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="wishlist-card card h-100 shadow-sm">
                        <!-- Notification Badge -->
                        @if (hasDiscount)
                        {
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-danger">
                                    <i class="fas fa-tag"></i> @L.GetString("OnSale", "Wishlist")
                                </span>
                            </div>
                        }

                        <!-- Product Image -->
                        <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id">
                            <img src="@Url.Content($"~/img/ProductImage/{imageUrl}")" 
                                 class="card-img-top product-image" 
                                 alt="@productName"
                                 onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")';" />
                        </a>

                        <div class="card-body d-flex flex-column">
                            <!-- Product Title -->
                            <h6 class="card-title">
                                <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id" class="text-decoration-none text-dark">
                                    @productName
                                </a>
                            </h6>

                            <!-- Price -->
                            <div class="price-section mt-auto">
                                <p class="price mb-2">
                                    <strong>@product.Price.ToString("N2") zł</strong>
                                </p>
                                @if (product.PackSize > 0)
                                {
                                    var perPiece = product.Price / product.PackSize;
                                    <small class="text-muted">
                                        @perPiece.ToString("N2") zł / @L["Product_Piece"]
                                    </small>
                                }
                            </div>

                            <!-- Added Date -->
                            <small class="text-muted mt-2">
                                <i class="fas fa-clock me-1"></i>
                                @L.GetString("AddedOn", "Wishlist") @item.AddedAt.ToString("dd MMM yyyy")
                            </small>

                            <!-- Actions -->
                            <div class="btn-group mt-3" role="group">
                                <a asp-controller="Product" asp-action="Details" asp-route-id="@product.Id" class="btn btn-sm btn-primary flex-fill">
                                    <i class="fas fa-eye me-1"></i>
                                    @L.GetString("View", "Wishlist")
                                </a>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFromWishlist(@product.Id)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-wishlist text-center py-5">
            <i class="far fa-heart text-muted" style="font-size: 5rem;"></i>
            <h3 class="mt-4 text-muted">@L.GetString("Empty", "Wishlist")</h3>
            <p class="text-muted">@L.GetString("Empty_Message", "Wishlist")</p>
            <a asp-controller="Product" asp-action="Index" class="btn btn-primary mt-3">
                <i class="fas fa-shopping-bag me-2"></i>
                @L.GetString("StartShopping", "Wishlist")
            </a>
        </div>
    }
</div>

@section Styles {
    <style>
        .wishlist-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .wishlist-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.15) !important;
        }

        .wishlist-card .product-image {
            height: 250px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .wishlist-card:hover .product-image {
            transform: scale(1.05);
        }

        .wishlist-card .card-title a:hover {
            color: var(--bs-primary) !important;
        }

        [data-bs-theme="dark"] .wishlist-card {
            background-color: #24272e;
            border-color: #3a3d44;
        }

        [data-bs-theme="dark"] .wishlist-card .card-title a {
            color: #e4e6eb !important;
        }

        [data-bs-theme="dark"] .wishlist-card .card-title a:hover {
            color: #4a8bae !important;
        }
    </style>
}

@section Scripts {
    <script>
        function removeFromWishlist(productId) {
            if (!confirm('@L.GetString("Confirm_Remove", "Wishlist")')) {
                return;
            }

            fetch('/Wishlist/Toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    productId: productId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '@L["Error_Generic"]');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('@L["Error_Generic"]');
            });
        }
    </script>
}

