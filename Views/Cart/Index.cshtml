@model Kokomija.Models.ViewModels.Cart.CartIndexViewModel
@inject Kokomija.Services.ILocalizationService L
@using System.Globalization

@{
    ViewData["Title"] = "Shopping Cart";
    var plnCulture = new CultureInfo("pl-PL");
}

<div class="cart-page container my-5">
    <h1 class="mb-4">Shopping Cart</h1>

    @if (!Model.Items.Any())
    {
        <div class="empty-cart text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h3 class="mt-3">Your cart is empty</h3>
            <p class="text-muted">Start shopping to add items to your cart</p>
            <a asp-controller="Product" asp-action="Index" class="btn btn-primary">Continue Shopping</a>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                @* Cart Items *@
                <div class="card mb-4">
                    <div class="card-body">
                        @foreach (var item in Model.Items)
                        {
                            <div class="cart-item border-bottom py-3" 
                                 data-product-id="@item.ProductId" 
                                 data-color-id="@(item.ColorId?.ToString() ?? "")" 
                                 data-size-id="@(item.SizeId?.ToString() ?? "")">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        @if (!string.IsNullOrEmpty(item.ProductImage))
                                        {
                                            <img src="@Url.Content("~/img/ProductImage/" + item.ProductImage)" 
                                                 alt="@item.ProductName" 
                                                 class="img-fluid rounded product-image"
                                                 onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');">
                                        }
                                        else
                                        {
                                            <img src="@Url.Content("~/img/logo_black.png")" 
                                                 alt="Kokomija" 
                                                 class="img-fluid rounded logo-fallback">
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <h5 class="mb-1">@item.ProductName.Split("-")[0].Trim()</h5>
                                        @if (item.PackSize > 1)
                                        {
                                            <span class="badge bg-primary mb-2">
                                                <i class="bi bi-box-seam"></i> @item.PackSize @L["Product_ItemsPerPack"]
                                            </span>
                                            <br />
                                            <small class="text-muted">
                                                <i class="bi bi-stack"></i> @L["Product_TotalItems"]: <strong>@item.TotalItems</strong>
                                            </small>
                                            <br />
                                        }
                                        @if (!string.IsNullOrEmpty(item.ColorName))
                                        {
                                            <small class="text-muted"><i class="bi bi-palette"></i> Color: @item.ColorName</small><br />
                                        }
                                        @if (!string.IsNullOrEmpty(item.SizeName))
                                        {
                                            <small class="text-muted"><i class="bi bi-rulers"></i> Size: @item.SizeName</small>
                                        }
                                    </div>
                                    <div class="col-md-2">
                                        <div class="input-group input-group-sm">
                                            <button class="btn btn-outline-secondary quantity-decrease" type="button">
                                                <i class="bi bi-dash"></i>
                                            </button>
                                            <input type="number" class="form-control text-center quantity-input" value="@item.Quantity" min="1" max="@item.MaxQuantity" readonly>
                                            <button class="btn btn-outline-secondary quantity-increase" type="button" @(item.Quantity >= item.MaxQuantity ? "disabled" : "")>
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        @if (!item.IsInStock)
                                        {
                                            <small class="text-danger">Out of stock</small>
                                        }
                                        else if (item.Quantity >= item.MaxQuantity)
                                        {
                                            <small class="text-warning">Max quantity</small>
                                        }
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <strong>@item.TotalPrice.ToString("C", plnCulture)</strong>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-danger remove-item">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @* Coupon Section *@
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Have a coupon?</h5>
                        @if (!string.IsNullOrEmpty(Model.AppliedCouponCode))
                        {
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-check-circle"></i> Coupon <strong>@Model.AppliedCouponCode</strong> applied!
                                    @if (Model.CouponDiscountPercentage.HasValue)
                                    {
                                        <span class="badge bg-success ms-2">@Model.CouponDiscountPercentage.Value% OFF</span>
                                    }
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="removeCoupon">Remove</button>
                            </div>
                        }
                        else
                        {
                            @if (Model.AvailableCoupons != null && Model.AvailableCoupons.Any())
                            {
                                <div class="available-coupons mb-3">
                                    <p class="text-muted mb-2"><small><i class="bi bi-ticket-perforated"></i> Available coupons:</small></p>
                                    <div class="d-flex flex-wrap gap-2">
                                        @foreach (var coupon in Model.AvailableCoupons)
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-primary apply-coupon-btn" data-coupon="@coupon">
                                                <i class="bi bi-tag"></i> @coupon
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <form id="couponForm" class="row g-3">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" id="couponCode" placeholder="Enter coupon code" required>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-outline-primary w-100">Apply Coupon</button>
                                </div>
                            </form>
                            <div id="couponMessage" class="mt-2"></div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                @* Order Summary *@
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong>@Model.Subtotal.ToString("C", plnCulture)</strong>
                        </div>

                        @* Always show VIP tier status *@
                        @if (Model.VipTier != "None")
                        {
                            <div class="vip-discount-row mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="vip-label">
                                        <i class="bi bi-star-fill"></i> VIP Discount
                                        <span class="badge bg-gradient-purple ms-2">@Model.VipTier</span>
                                        <span class="vip-percentage">@Model.VipDiscountPercentage%</span>
                                    </span>
                                    <strong class="vip-amount">-@Model.VipDiscountAmount.ToString("C", plnCulture)</strong>
                                </div>
                            </div>
                        }

                        @if (Model.CouponDiscountAmount > 0)
                        {
                            <div class="coupon-discount-row mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="coupon-label">
                                        <i class="bi bi-ticket-perforated-fill"></i> Coupon Discount
                                        @if (!string.IsNullOrEmpty(Model.AppliedCouponCode))
                                        {
                                            <span class="badge bg-success ms-2">@Model.AppliedCouponCode</span>
                                        }
                                        @if (Model.CouponDiscountPercentage.HasValue)
                                        {
                                            <span class="coupon-percentage">@Model.CouponDiscountPercentage%</span>
                                        }
                                    </span>
                                    <strong class="coupon-amount">-@Model.CouponDiscountAmount.ToString("C", plnCulture)</strong>
                                </div>
                            </div>
                        }
                        
                        @if (Model.DiscountAmount > 0)
                        {
                            <div class="d-flex justify-content-between mb-2 text-success">
                                <span><strong>Total Savings:</strong></span>
                                <strong>-@Model.DiscountAmount.ToString("C", plnCulture)</strong>
                            </div>
                        }

                        @* Shipping Options Section *@
                        <div class="shipping-options-section mb-3">
                            <h6 class="mb-2">
                                <i class="bi bi-truck me-2"></i>@L["Shipping_Method"]
                            </h6>
                            
                            @if (Model.IsFreeShippingVip)
                            {
                                <div class="alert alert-success py-2 mb-2">
                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                    @L["Shipping_FreeVip"]
                                </div>
                            }
                            else if (Model.HasFreeShipping)
                            {
                                <div class="alert alert-success py-2 mb-2">
                                    <i class="bi bi-check-circle me-1"></i>
                                    @L["Shipping_FreeThreshold"]
                                </div>
                            }
                            
                            <div class="shipping-options">
                                @foreach (var option in Model.ShippingOptions)
                                {
                                    <div class="shipping-option @(option.IsSelected ? "selected" : "")" 
                                         data-shipping-id="@option.Id"
                                         data-cost="@option.Cost">
                                        <div class="form-check">
                                            <input class="form-check-input shipping-radio" 
                                                   type="radio" 
                                                   name="shippingOption" 
                                                   id="shipping_@option.Id" 
                                                   value="@option.Id"
                                                   @(option.IsSelected ? "checked" : "")>
                                            <label class="form-check-label w-100" for="shipping_@option.Id">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>@option.Name</strong>
                                                        @if (!string.IsNullOrEmpty(option.ProviderName))
                                                        {
                                                            <small class="text-muted d-block">@option.ProviderName</small>
                                                        }
                                                        <small class="text-muted">
                                                            <i class="bi bi-calendar-event me-1"></i>
                                                            @option.DeliveryEstimate @L["Business_Days"]
                                                            @if (option.EstimatedDeliveryDate.HasValue)
                                                            {
                                                                <span class="text-primary ms-1">
                                                                    (@L["Arrives_By"] @option.EstimatedDeliveryDate.Value.ToString("MMM d"))
                                                                </span>
                                                            }
                                                        </small>
                                                    </div>
                                                    <div class="text-end">
                                                        @if (option.IsFree)
                                                        {
                                                            <span class="badge bg-success">@L["Free"]</span>
                                                            @if (option.OriginalCost > 0)
                                                            {
                                                                <small class="text-decoration-line-through text-muted d-block">
                                                                    @option.OriginalCost.ToString("C", plnCulture)
                                                                </small>
                                                            }
                                                        }
                                                        else if (option.Cost < option.OriginalCost)
                                                        {
                                                            <strong>@option.Cost.ToString("C", plnCulture)</strong>
                                                            <small class="text-decoration-line-through text-muted d-block">
                                                                @option.OriginalCost.ToString("C", plnCulture)
                                                            </small>
                                                        }
                                                        else
                                                        {
                                                            <strong>@option.Cost.ToString("C", plnCulture)</strong>
                                                        }
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>

                        @if (!Model.HasFreeShipping && Model.RemainingForFreeShipping > 0)
                        {
                            <div class="free-shipping-progress mb-3">
                                <small class="text-muted">@L["Cart_FreeShipping_Add"] @Model.RemainingForFreeShipping.ToString("C", plnCulture) @L["Cart_FreeShipping_More"]</small>
                                <div class="progress mt-1" style="height: 5px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: @((int)(((Model.FreeShippingThreshold - Model.RemainingForFreeShipping) / Model.FreeShippingThreshold) * 100))%"></div>
                                </div>
                            </div>
                        }

                        <div class="d-flex justify-content-between mb-2">
                            <span>@L["Shipping"]:</span>
                            <strong id="shippingCostDisplay">@(Model.ShippingCost > 0 ? Model.ShippingCost.ToString("C", plnCulture) : L["Free"].ToString())</strong>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (23%):<br /><small class="text-muted">(Included in total)</small></span>
                            <strong>@Model.TaxAmount.ToString("C", plnCulture)</strong>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between mb-3">
                            <h5>Total:</h5>
                            <h5 id="totalDisplay">@Model.Total.ToString("C", plnCulture)</h5>
                        </div>

                        <button type="button" id="proceedToCheckout" class="btn btn-primary w-100 mb-2">
                            <i class="bi bi-lock-fill"></i> Proceed to Secure Checkout
                        </button>
                        <a asp-controller="Product" asp-action="Index" class="btn btn-outline-secondary w-100">Continue Shopping</a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        $(document).ready(function() {
            // Initialize Stripe
            const stripe = Stripe('@ViewBag.StripePublishableKey');

            // Get cart item data from DOM
            function getCartItemData($button) {
                const $item = $button.closest('.cart-item');
                return {
                    productId: parseInt($item.data('product-id')),
                    colorId: $item.data('color-id') ? parseInt($item.data('color-id')) : null,
                    sizeId: $item.data('size-id') ? parseInt($item.data('size-id')) : null
                };
            }

            // Proceed to checkout - create Stripe session directly
            $('#proceedToCheckout').on('click', async function() {
                const $button = $(this);
                const originalHtml = $button.html();
                
                $button.prop('disabled', true);
                $button.html('<span class="spinner-border spinner-border-sm me-2"></span>Processing...');

                try {
                    const response = await fetch('/Checkout/CreateCheckoutSession', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Redirect to Stripe Checkout
                        const result = await stripe.redirectToCheckout({
                            sessionId: data.sessionId
                        });

                        if (result.error) {
                            alert(result.error.message);
                            $button.prop('disabled', false);
                            $button.html(originalHtml);
                        }
                    } else {
                        alert(data.message || 'Failed to create checkout session');
                        $button.prop('disabled', false);
                        $button.html(originalHtml);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while processing checkout');
                    $button.prop('disabled', false);
                    $button.html(originalHtml);
                }
            });

            // Apply coupon from available coupons list
            $('.apply-coupon-btn').on('click', function() {
                const couponCode = $(this).data('coupon');
                $('#couponCode').val(couponCode);
                $('#couponForm').submit();
            });

            // Update quantity
            $('.quantity-decrease, .quantity-increase').on('click', function() {
                const $button = $(this);
                const isIncrease = $button.hasClass('quantity-increase');
                const $item = $button.closest('.cart-item');
                const $input = $item.find('.quantity-input');
                let quantity = parseInt($input.val());

                if (isIncrease) {
                    quantity++;
                } else if (quantity > 1) {
                    quantity--;
                } else {
                    return; // Don't allow quantity below 1
                }

                const itemData = getCartItemData($button);
                itemData.quantity = quantity;

                // Update via AJAX
                $.ajax({
                    url: '/Cart/api/update-quantity',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(itemData),
                    success: function(response) {
                        if (response.success) {
                            location.reload(); // Refresh to update totals
                        } else {
                            alert(response.message || 'Failed to update quantity');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        alert('An error occurred while updating quantity');
                    }
                });
            });

            // Remove item
            $('.remove-item').on('click', function() {
                if (!confirm('Remove this item from cart?')) return;

                const $button = $(this);
                const itemData = getCartItemData($button);

                $.ajax({
                    url: '/Cart/api/remove',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(itemData),
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message || 'Failed to remove item');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        alert('An error occurred while removing item');
                    }
                });
            });

            // Apply coupon
            $('#couponForm').on('submit', function(e) {
                e.preventDefault();
                const couponCode = $('#couponCode').val().trim();

                $.ajax({
                    url: '/Cart/api/apply-coupon',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ couponCode: couponCode }),
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            $('#couponMessage').html(`<div class="alert alert-danger">${response.message}</div>`);
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        $('#couponMessage').html('<div class="alert alert-danger">An error occurred</div>');
                    }
                });
            });

            // Remove coupon
            $('#removeCoupon').on('click', function() {
                $.ajax({
                    url: '/Cart/api/remove-coupon',
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                    }
                });
            });

            // Shipping option change
            $('.shipping-radio').on('change', function() {
                const shippingOption = $(this).val();
                const $container = $(this).closest('.shipping-options');
                
                // Update visual selection
                $container.find('.shipping-option').removeClass('selected');
                $(this).closest('.shipping-option').addClass('selected');
                
                // Update via AJAX
                $.ajax({
                    url: '/Cart/api/update-shipping',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ shippingOption: shippingOption }),
                    success: function(response) {
                        if (response.success) {
                            // Update displayed values
                            const formattedShipping = response.shippingCost === 0 
                                ? '@L["Free"]' 
                                : new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(response.shippingCost);
                            $('#shippingCostDisplay').text(formattedShipping);
                            
                            const formattedTotal = new Intl.NumberFormat('pl-PL', { style: 'currency', currency: 'PLN' }).format(response.total);
                            $('#totalDisplay').text(formattedTotal);
                        } else {
                            alert(response.message || 'Failed to update shipping');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        alert('An error occurred while updating shipping');
                    }
                });
            });
        });
    </script>
}
