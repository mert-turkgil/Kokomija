@model Kokomija.Entity.Product
@inject Kokomija.Services.ILocalizationService L
@inject Kokomija.Services.ILocalizedUrlService LocalizedUrl
@inject Kokomija.Data.Abstract.IUnitOfWork UnitOfWork
@using System.Globalization
@using System.Text.Json

@{
    var relatedProducts = ViewBag.RelatedProducts as List<Kokomija.Entity.Product> ?? new List<Kokomija.Entity.Product>();
    var currentCulture = CultureInfo.CurrentCulture.TwoLetterISOLanguageName;
    
    // Get translation for current culture if available
    var translation = ViewData["CurrentTranslation"] as Kokomija.Entity.ProductTranslation 
        ?? Model.Translations?.FirstOrDefault(t => t.CultureCode.StartsWith(currentCulture));
    
    // Use translated values or fallback to default
    var productName = translation?.Name ?? Model.Name;
    var productDescription = translation?.Description ?? Model.Description;
    var metaDescription = translation?.MetaDescription ?? (productDescription.Length > 160 ? productDescription.Substring(0, 157) + "..." : productDescription);
    var metaKeywords = translation?.MetaKeywords ?? "";
    var productSlug = translation?.Slug ?? Model.Slug ?? Model.Id.ToString();
    
    // Calculate pricing for structured data
    var pricePerPiece = Model.PackSize > 1 ? Model.Price / Model.PackSize : Model.Price;
    var hasDiscount = Model.Price > 60; // Best value indicator
    var primaryImage = Model.Images?.OrderBy(i => i.DisplayOrder).FirstOrDefault();
    var primaryImageUrl = primaryImage != null 
        ? $"{Context.Request.Scheme}://{Context.Request.Host}/img/ProductImage/{primaryImage.ImageUrl}"
        : $"{Context.Request.Scheme}://{Context.Request.Host}/img/logo_black.png";
    
    // WELCOME10 discount for non-authenticated users (10% off first order)
    var isAuthenticated = User.Identity?.IsAuthenticated == true;
    var welcomeDiscountPercent = 10m;
    var welcomeDiscountedPrice = Model.Price * (1 - welcomeDiscountPercent / 100);
    var welcomeDiscountedPricePerPiece = Model.PackSize > 1 ? welcomeDiscountedPrice / Model.PackSize : welcomeDiscountedPrice;
    var showWelcomeDiscount = !isAuthenticated; // Show discount for non-logged-in users
    
    // For SEO structured data, always show the discount price (WELCOME10 available for new users)
    var seoPrice = showWelcomeDiscount ? welcomeDiscountedPrice : Model.Price;
    var seoHighPrice = Model.Price;
    var seoLowPrice = welcomeDiscountedPrice;
    
    // SEO: Set ViewData for layout
    ViewData["Title"] = productName + " | Kokomija";
    ViewData["MetaDescription"] = metaDescription;
    ViewData["MetaKeywords"] = metaKeywords;
    ViewData["OgTitle"] = productName;
    ViewData["OgDescription"] = metaDescription;
    ViewData["OgImage"] = primaryImageUrl;
    ViewData["OgType"] = "product";
    
    // Build canonical URL for sharing
    var canonicalUrl = $"{Context.Request.Scheme}://{Context.Request.Host}{LocalizedUrl.GetProductUrl(productSlug)}";
    ViewData["CanonicalUrl"] = canonicalUrl;
    
    // Calculate average rating - show real data only, 0 when no reviews
    var visibleReviews = Model.Reviews?.Where(r => r.IsVisible).ToList() ?? new List<Kokomija.Entity.ProductReview>();
    var reviewCount = visibleReviews.Count;
    var averageRating = reviewCount > 0 ? visibleReviews.Average(r => r.Rating) : 0m;
    
    // Availability
    var inStock = Model.Variants?.Any(v => v.StockQuantity > 0) ?? true;
    var availability = inStock ? "https://schema.org/InStock" : "https://schema.org/OutOfStock";
}

@section Styles {
    <style>
        /* Product page specific SEO-friendly styles */
        .product-schema-hidden { display: none; }
        
        /* Welcome discount container */
        .welcome-discount-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* Welcome discount badge styles */
        .welcome-discount-badge {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            width: fit-content;
        }
        
        /* Promo code box */
        .promo-code-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bs-light);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px dashed var(--bs-border-color);
            width: fit-content;
        }
        
        .use-code-text {
            font-size: 0.8rem;
            color: var(--bs-secondary);
        }
        
        .promo-code {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .copy-code-btn {
            background: none;
            border: none;
            color: var(--bs-primary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .copy-code-btn:hover {
            background: var(--bs-primary);
            color: white;
        }
        
        .copy-code-btn.copied {
            background: var(--bs-success);
            color: white;
        }
        
        [data-bs-theme="dark"] .promo-code-box {
            background: var(--bs-dark);
            border-color: var(--bs-border-color);
        }
        
        .original-price {
            text-decoration: line-through;
            color: var(--bs-secondary);
            font-size: 0.9em;
            margin-left: 0.5rem;
        }
        
        .discount-price {
            color: #ee5a24;
            font-weight: 700;
        }
    </style>
}

@section Meta {
    @* SEO Meta Tags *@
    <meta name="description" content="@metaDescription" />
    @if (!string.IsNullOrEmpty(metaKeywords))
    {
        <meta name="keywords" content="@metaKeywords" />
    }
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="@ViewData["CanonicalUrl"]" />
    
    @* Open Graph Tags *@
    <meta property="og:title" content="@productName" />
    <meta property="og:description" content="@metaDescription" />
    <meta property="og:type" content="product" />
    <meta property="og:url" content="@ViewData["CanonicalUrl"]" />
    <meta property="og:image" content="@primaryImageUrl" />
    <meta property="og:site_name" content="Kokomija" />
    <meta property="og:locale" content="@(currentCulture == "pl" ? "pl_PL" : currentCulture == "tr" ? "tr_TR" : "en_US")" />
    <meta property="product:price:amount" content="@Model.Price.ToString("F2", CultureInfo.InvariantCulture)" />
    <meta property="product:price:currency" content="PLN" />
    <meta property="product:availability" content="@(inStock ? "in stock" : "out of stock")" />
    
    @* Twitter Card Tags *@
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="@productName" />
    <meta name="twitter:description" content="@metaDescription" />
    <meta name="twitter:image" content="@primaryImageUrl" />
    
    @* Alternate language URLs for SEO *@
    @if (Model.Translations != null)
    {
        foreach (var trans in Model.Translations.Where(t => !string.IsNullOrEmpty(t.Slug)))
        {
            var langCode = trans.CultureCode.Split('-')[0];
            var hrefLang = trans.CultureCode.ToLower();
            var altUrl = $"{Context.Request.Scheme}://{Context.Request.Host}/{langCode}/{(langCode == "pl" ? "produkt" : langCode == "tr" ? "urun" : "product")}/{trans.Slug}";
            <link rel="alternate" hreflang="@hrefLang" href="@altUrl" />
        }
        <link rel="alternate" hreflang="x-default" href="@ViewData["CanonicalUrl"]" />
    }
    
    @* JSON-LD Structured Data for Product *@
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "Product",
        "name": "@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(productName))",
        "description": "@Html.Raw(System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(productDescription))",
        "image": [
            @foreach (var img in Model.Images?.OrderBy(i => i.DisplayOrder) ?? Enumerable.Empty<Kokomija.Entity.ProductImage>())
            {
                var imgUrl = $"{Context.Request.Scheme}://{Context.Request.Host}/img/ProductImage/{img.ImageUrl}";
                @Html.Raw($"\"{imgUrl}\"")
                if (img != Model.Images?.OrderBy(i => i.DisplayOrder).LastOrDefault())
                {
                    @Html.Raw(",")
                }
            }
        ],
        "sku": "@(Model.Variants?.FirstOrDefault()?.SKU ?? $"PROD-{Model.Id}")",
        "brand": {
            "@@type": "Brand",
            "name": "Kokomija"
        },
        "category": "@(Model.Category?.Name ?? "Underwear")",
        "offers": {
            "@@type": "AggregateOffer",
            "url": "@ViewData["CanonicalUrl"]",
            "priceCurrency": "PLN",
            "lowPrice": "@seoLowPrice.ToString("F2", CultureInfo.InvariantCulture)",
            "highPrice": "@seoHighPrice.ToString("F2", CultureInfo.InvariantCulture)",
            "offerCount": "2",
            "priceValidUntil": "@DateTime.UtcNow.AddMonths(6).ToString("yyyy-MM-dd")",
            "availability": "@availability",
            "itemCondition": "https://schema.org/NewCondition",
            "seller": {
                "@@type": "Organization",
                "name": "Kokomija"
            },
            "shippingDetails": {
                "@@type": "OfferShippingDetails",
                "shippingRate": {
                    "@@type": "MonetaryAmount",
                    "value": "15.00",
                    "currency": "PLN"
                },
                "deliveryTime": {
                    "@@type": "ShippingDeliveryTime",
                    "handlingTime": {
                        "@@type": "QuantitativeValue",
                        "minValue": 1,
                        "maxValue": 2,
                        "unitCode": "DAY"
                    },
                    "transitTime": {
                        "@@type": "QuantitativeValue",
                        "minValue": 2,
                        "maxValue": 5,
                        "unitCode": "DAY"
                    }
                },
                "shippingDestination": {
                    "@@type": "DefinedRegion",
                    "addressCountry": "PL"
                }
            }
        }
        @if (reviewCount > 0)
        {
            @Html.Raw($@",
        ""aggregateRating"": {{
            ""@@type"": ""AggregateRating"",
            ""ratingValue"": ""{averageRating:F1}"",
            ""reviewCount"": ""{reviewCount}"",
            ""bestRating"": ""5"",
            ""worstRating"": ""1""
        }}")
        }
    }
    </script>
    
    @* BreadcrumbList Structured Data *@
    <script type="application/ld+json">
    {
        "@@context": "https://schema.org",
        "@@type": "BreadcrumbList",
        "itemListElement": [
            {
                "@@type": "ListItem",
                "position": 1,
                "name": "@L["Home"]",
                "item": "@($"{Context.Request.Scheme}://{Context.Request.Host}{LocalizedUrl.GetHomeUrl()}")"
            },
            {
                "@@type": "ListItem",
                "position": 2,
                "name": "@L["Products"]",
                "item": "@($"{Context.Request.Scheme}://{Context.Request.Host}{LocalizedUrl.GetProductsUrl()}")"
            }
            @if (Model.Category != null)
            {
                @Html.Raw($@",
            {{
                ""@@type"": ""ListItem"",
                ""position"": 3,
                ""name"": ""{(!string.IsNullOrEmpty(Model.Category.NameKey) ? L[Model.Category.NameKey] : Model.Category.Name)}"",
                ""item"": ""{Context.Request.Scheme}://{Context.Request.Host}/Product/Category/{Model.Category.Slug}""
            }},
            {{
                ""@@type"": ""ListItem"",
                ""position"": 4,
                ""name"": ""{System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(productName)}""
            }}")
            }
            else
            {
                @Html.Raw($@",
            {{
                ""@@type"": ""ListItem"",
                ""position"": 3,
                ""name"": ""{System.Text.Encodings.Web.JavaScriptEncoder.Default.Encode(productName)}""
            }}")
            }
        ]
    }
    </script>
}

<div class="product-detail-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="product-breadcrumb">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">@L["Home"]</a></li>
                <li class="breadcrumb-item"><a asp-controller="Product" asp-action="Index">@L["Products"]</a></li>
                @if (Model.Category != null)
                {
                    <li class="breadcrumb-item">
                        <a asp-controller="Product" asp-action="Category" asp-route-slug="@Model.Category.Slug">
                            @(!string.IsNullOrEmpty(Model.Category.NameKey) ? L[Model.Category.NameKey] : Model.Category.Name)
                        </a>
                    </li>
                }
                <li class="breadcrumb-item active" aria-current="page">@productName</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row g-5">
            <!-- Image Gallery Section -->
            <div class="col-lg-7">
                <div class="product-gallery" id="productGallery" itemscope itemtype="https://schema.org/ImageGallery">
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        var imageCount = Model.Images.Count();
                        var orderedImages = Model.Images.OrderBy(i => i.DisplayOrder).ToList();
                        
                        @if (imageCount == 1)
                        {
                            <!-- Single Large Image -->
                            var singleImage = orderedImages.First();
                            var imgUrl = Url.Content($"~/img/ProductImage/{singleImage.ImageUrl}");
                            var seoAltText = !string.IsNullOrEmpty(singleImage.AltText) ? singleImage.AltText : $"{productName} - Kokomija";
                            
                            <div class="single-image-container">
                                <img src="@imgUrl" 
                                     alt="@seoAltText" 
                                     title="@productName"
                                     class="single-product-image" 
                                     id="viewerImage"
                                     itemprop="image"
                                     loading="eager"
                                     onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                <div class="image-click-hint">
                                    <i class="fas fa-search-plus"></i> @L.GetString("ClickToEnlarge", "Product")
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Multiple Images with Thumbnails and Navigation -->
                            var mainImage = orderedImages.First();
                            var mainImageUrl = Url.Content($"~/img/ProductImage/{mainImage.ImageUrl}");
                            var mainAltText = !string.IsNullOrEmpty(mainImage.AltText) ? mainImage.AltText : $"{productName} - główne zdjęcie - Kokomija";
                            
                            <div class="main-image-container">
                                <div class="image-zoom-wrapper">
                                    <img src="@mainImageUrl" 
                                         alt="@mainAltText"
                                         title="@productName" 
                                         class="main-product-image" 
                                         id="mainImage"
                                         data-index="0"
                                         onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                    <div class="image-click-hint">
                                        <i class="fas fa-search-plus"></i> @L.GetString("ClickToEnlarge", "Product")
                                    </div>
                                </div>
                                
                                <!-- Image Navigation Arrows -->
                                <button class="image-nav prev" id="prevImage" aria-label="@L["Previous"]">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="image-nav next" id="nextImage" aria-label="@L["Next"]">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                
                                <!-- Image Counter -->
                                <div class="image-counter">
                                    <span id="currentImageIndex">1</span> / <span id="totalImages">@imageCount</span>
                                </div>
                            </div>

                            <!-- Thumbnail Gallery -->
                            <div class="thumbnail-gallery">
                                @for (int i = 0; i < orderedImages.Count; i++)
                                {
                                    var image = orderedImages[i];
                                    var imgUrl = Url.Content($"~/img/ProductImage/{image.ImageUrl}");
                                    var thumbAltText = !string.IsNullOrEmpty(image.AltText) ? image.AltText : $"{productName} - zdjęcie {i + 1}";
                                    
                                    <div class="thumbnail-item @(i == 0 ? "active" : "")" 
                                         data-index="@i"
                                         data-image="@imgUrl"
                                         data-alt="@thumbAltText">
                                        <img src="@imgUrl" 
                                             alt="@thumbAltText"
                                             title="@productName - @(i + 1)" 
                                             loading="lazy"
                                             onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.parentElement.classList.add('logo-fallback');" />
                                    </div>
                                }
                            </div>
                        }
                        
                        <!-- Hidden images for viewer -->
                        <div id="imageViewer" style="display: none;">
                            @foreach (var image in orderedImages)
                            {
                                var imgUrl = Url.Content($"~/img/ProductImage/{image.ImageUrl}");
                                <img src="@imgUrl" alt="@productName" />
                            }
                        </div>
                    }
                    else
                    {
                        <!-- No Images - Show Logo -->
                        <div class="single-image-container">
                            <img src="@Url.Content("~/img/logo_black.png")" 
                                 alt="Kokomija" 
                                 class="single-product-image logo-fallback" 
                                 id="viewerImage" />
                        </div>
                    }
                </div>

                <!-- Product Features (Below Gallery) -->
                <div class="product-features">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-shield-alt"></i>
                                <h6>@L.GetString("Quality", "Product")</h6>
                                <p>@L.GetString("QualityDesc", "Product")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-truck-fast"></i>
                                <h6>@L.GetString("FastShipping", "Product")</h6>
                                <p>@L.GetString("FastShippingDesc", "Product")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-rotate-left"></i>
                                <h6>@L.GetString("Returns", "Product")</h6>
                                <p>@L.GetString("ReturnsDesc", "Product")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="col-lg-5">
                <article class="product-info" itemscope itemtype="https://schema.org/Product">
                    <!-- Hidden schema data -->
                    <meta itemprop="name" content="@productName" />
                    <meta itemprop="description" content="@productDescription" />
                    <link itemprop="url" href="@ViewData["CanonicalUrl"]" />
                    
                    <!-- Product Title -->
                    <h1 class="product-title">@productName</h1>

                    <!-- Rating and Reviews -->
                    <div class="product-rating" itemprop="aggregateRating" itemscope itemtype="https://schema.org/AggregateRating">
                        <meta itemprop="ratingValue" content="@averageRating.ToString("F1", CultureInfo.InvariantCulture)" />
                        <meta itemprop="reviewCount" content="@reviewCount" />
                        <meta itemprop="bestRating" content="5" />
                        <meta itemprop="worstRating" content="1" />
                        <div class="stars" aria-label="@L.GetString("Rating", "Product"): @averageRating.ToString("F1") @L.GetString("OutOf", "Product") 5">
                            @for (int i = 1; i <= 5; i++)
                            {
                                if (i <= Math.Floor(averageRating))
                                {
                                    <i class="fas fa-star" aria-hidden="true"></i>
                                }
                                else if (i - averageRating < 1 && i - averageRating > 0)
                                {
                                    <i class="fas fa-star-half-alt" aria-hidden="true"></i>
                                }
                                else
                                {
                                    <i class="far fa-star" aria-hidden="true"></i>
                                }
                            }
                        </div>
                        <span class="rating-text">@averageRating.ToString("F2") <span class="review-count">(@reviewCount @L.GetString("Reviews", "Product"))</span></span>
                    </div>

                    <!-- Price with Schema.org markup -->
                    <div class="product-price-section" itemprop="offers" itemscope itemtype="https://schema.org/AggregateOffer">
                        <meta itemprop="priceCurrency" content="PLN" />
                        <meta itemprop="lowPrice" content="@seoLowPrice.ToString("F2", CultureInfo.InvariantCulture)" />
                        <meta itemprop="highPrice" content="@seoHighPrice.ToString("F2", CultureInfo.InvariantCulture)" />
                        <link itemprop="url" href="@ViewData["CanonicalUrl"]" />
                        <meta itemprop="availability" content="@availability" />
                        <meta itemprop="priceValidUntil" content="@DateTime.UtcNow.AddMonths(6).ToString("yyyy-MM-dd")" />
                        
                        <div class="price-display">
                            @if (showWelcomeDiscount)
                            {
                                @* Show discounted price for non-authenticated users *@
                                @if (Model.PackSize > 1)
                                {
                                    <span class="current-price discount-price" id="productPrice">
                                        @welcomeDiscountedPrice.ToString("N2") zł
                                    </span>
                                    <span class="original-price">@Model.Price.ToString("N2") zł</span>
                                    <span class="price-per-piece">(@welcomeDiscountedPricePerPiece.ToString("N2") zł / @L.GetString("Piece", "Product"))</span>
                                }
                                else
                                {
                                    <span class="current-price discount-price" id="productPrice">@welcomeDiscountedPrice.ToString("N2") zł</span>
                                    <span class="original-price">@Model.Price.ToString("N2") zł</span>
                                }
                                <div class="welcome-discount-container mt-2">
                                    <div class="welcome-discount-badge">
                                        <i class="fas fa-gift me-1"></i>
                                        <span>@L.GetString("WelcomeDiscount", "Product")</span>
                                    </div>
                                    <div class="promo-code-box mt-2">
                                        <span class="use-code-text">@L.GetString("UseCode", "Product"):</span>
                                        <code class="promo-code">WELCOME10</code>
                                        <button type="button" class="copy-code-btn" onclick="copyPromoCode('WELCOME10')" title="@L["Product_CopyLink"]">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                @* Show regular price for authenticated users *@
                                @if (Model.PackSize > 1)
                                {
                                    <span class="current-price" id="productPrice" itemprop="priceSpecification" itemscope itemtype="https://schema.org/PriceSpecification">
                                        <span itemprop="price">@Model.Price.ToString("N2")</span> <span itemprop="priceCurrency">zł</span>
                                    </span>
                                    <span class="price-per-piece">(@pricePerPiece.ToString("N2") zł / @L.GetString("Piece", "Product"))</span>
                                }
                                else
                                {
                                    <span class="current-price" id="productPrice">@Model.Price.ToString("N2") zł</span>
                                }
                            }
                        </div>
                        @if (Model.Price > 60)
                        {
                            <div class="savings-badge">
                                <i class="fas fa-tag"></i>
                                @L.GetString("BestValue", "Product")
                            </div>
                        }
                    </div>

                    <!-- Pack Size Switcher -->
                    @{
                        var hasRelatedProducts = relatedProducts.Any();
                        var allPackOptions = new List<Kokomija.Entity.Product>();
                        
                        if (Model.ProductGroupId.HasValue)
                        {
                            // Build complete list of all packs including current
                            allPackOptions = relatedProducts.ToList();
                            allPackOptions.Add(Model);
                            allPackOptions = allPackOptions.OrderBy(p => p.PackSize).ToList();
                        }
                    }
                    
                    @if (allPackOptions.Any())
                    {
                        <div class="pack-switcher">
                            <label class="section-label">@L.GetString("PackSize", "Product")</label>
                            <div class="pack-options">
                                @foreach (var pack in allPackOptions)
                                {
                                    var isCurrentProduct = pack.Id == Model.Id;
                                    var packSize = pack.PackSize;
                                    var perPiecePrice = pack.Price / packSize;
                                    var isBestValue = packSize == allPackOptions.Max(p => p.PackSize);
                                    
                                    var packTranslation = pack.Translations?.FirstOrDefault(t => t.CultureCode.StartsWith(currentCulture));
                                    var packSlug = packTranslation?.Slug ?? pack.Slug ?? pack.Id.ToString();
                                    
                                    <a asp-controller="Product" asp-action="DetailsBySlug" asp-route-culture="@currentCulture" asp-route-slug="@packSlug" 
                                       class="pack-option @(isCurrentProduct ? "active" : "") @(isBestValue ? "best-value" : "")">
                                        @if (isBestValue)
                                        {
                                            <span class="best-value-tag">@L.GetString("BestValue", "Product")</span>
                                        }
                                        <div class="pack-count">@packSize @L.GetString("Pack", "Product")</div>
                                        <div class="pack-price">@pack.Price.ToString("N2") zł</div>
                                        <div class="pack-unit-price">@perPiecePrice.ToString("N2") zł/@L.GetString("Piece", "Product")</div>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    <!-- Size Selection -->
                    @if (Model.Variants != null && Model.Variants.Any())
                    {
                        <div class="size-selection">
                            <label class="section-label">
                                @L.GetString("SelectSize", "Product")
                                <a href="#sizeGuide" class="size-guide-link">
                                    <i class="fas fa-ruler"></i> @L.GetString("SizeGuide", "Product")
                                </a>
                            </label>
                            <div class="size-options">
                                @foreach (var variant in Model.Variants.GroupBy(v => v.Size?.Name).OrderBy(g => g.Key))
                                {
                                    var size = variant.First().Size;
                                    var isAvailable = variant.First().StockQuantity > 0;
                                    var variantId = variant.First().Id;
                                    var colorId = variant.First().ColorId;
                                    var sizeId = variant.First().SizeId;
                                    
                                    <button class="size-option @(!isAvailable ? "out-of-stock" : "")" 
                                            data-variant-id="@variantId"
                                            data-color-id="@colorId"
                                            data-size-id="@sizeId"
                                            data-size="@size?.Name"
                                            data-stock="@variant.First().StockQuantity"
                                            @(!isAvailable ? "disabled" : "")>
                                        <span class="size-name">@size?.Name</span>
                                        @if (!isAvailable)
                                        {
                                            <span class="stock-status">@L.GetString("OutOfStock", "Product")</span>
                                        }
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <!-- Quantity Selector -->
                    <div class="quantity-selector">
                        <label class="section-label">@L.GetString("Quantity", "Product")</label>
                        <div class="quantity-controls">
                            <button type="button" class="qty-btn minus" id="qtyMinus">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="qty-input" id="quantity" value="1" min="1" max="99" readonly />
                            <button type="button" class="qty-btn plus" id="qtyPlus">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <span class="stock-info" id="stockInfo">
                            <i class="fas fa-box"></i> @L.GetString("InStock", "Product")
                        </span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="product-actions">
                        <button class="btn btn-primary btn-add-cart" id="addToCartBtn" @(Model.Variants == null || !Model.Variants.Any() ? "" : "disabled")>
                            <i class="fas fa-shopping-cart"></i>
                            @L.GetString("AddToCart", "Product")
                        </button>
                        <button class="btn btn-outline-secondary btn-wishlist" id="addToWishlistBtn">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>

                    <!-- Product Description -->
                    <div class="product-description" itemprop="description">
                        <h5 class="description-title">@L["Product_Description"]</h5>
                        <p>@productDescription</p>
                    </div>

                    <!-- Product Specifications -->
                    <div class="product-specifications">
                        <h5 class="specs-title">@L["Product_Specifications"]</h5>
                        <ul class="specs-list">
                            <li>
                                <span class="spec-label">@L["Product_Material"]:</span>
                                <span class="spec-value" itemprop="material">@L["Product_Material_Cotton"]</span>
                            </li>
                            <li>
                                <span class="spec-label">@L["Product_Care"]:</span>
                                <span class="spec-value">@L["Product_Care_Instructions"]</span>
                            </li>
                            <li>
                                <span class="spec-label">@L["Product_Brand"]:</span>
                                <span class="spec-value" itemprop="brand" itemscope itemtype="https://schema.org/Brand">
                                    <span itemprop="name">Kokomija</span>
                                </span>
                            </li>
                            <li>
                                <span class="spec-label">SKU:</span>
                                <span class="spec-value" id="productSKU" itemprop="sku">@(Model.Variants?.FirstOrDefault()?.SKU ?? $"PROD-{Model.Id}")</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="badge-item">
                            <i class="fas fa-lock"></i>
                            <span>@L["Product_SecurePayment"]</span>
                        </div>
                        <div class="badge-item">
                            <i class="fas fa-certificate"></i>
                            <span>@L["Product_Certified"]</span>
                        </div>
                    </div>

                    <!-- Share Buttons -->
                    <div class="product-share mt-4 pt-4 border-top">
                        <h6 class="share-title mb-3">
                            <i class="fas fa-share-alt me-2"></i>@L["Product_Share"]
                        </h6>
                        <div class="share-buttons d-flex gap-2 flex-wrap">
                            <a href="https://www.facebook.com/sharer/sharer.php?u=@Uri.EscapeDataString(canonicalUrl)" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="btn btn-sm btn-outline-primary share-btn"
                               title="@L["Product_ShareFacebook"]">
                                <i class="bi bi-facebook"></i>
                                <span class="d-none d-md-inline ms-1">Facebook</span>
                            </a>
                            <a href="https://twitter.com/intent/tweet?url=@Uri.EscapeDataString(canonicalUrl)&text=@Uri.EscapeDataString(productName)" 
                               target="_blank"
                               rel="noopener noreferrer" 
                               class="btn btn-sm btn-outline-info share-btn"
                               title="@L["Product_ShareTwitter"]">
                                <i class="bi bi-twitter"></i>
                                <span class="d-none d-md-inline ms-1">Twitter</span>
                            </a>
                            <a href="https://pinterest.com/pin/create/button/?url=@Uri.EscapeDataString(canonicalUrl)&media=@Uri.EscapeDataString(primaryImageUrl)&description=@Uri.EscapeDataString(productName)" 
                               target="_blank"
                               rel="noopener noreferrer" 
                               class="btn btn-sm btn-outline-danger share-btn"
                               title="@L["Product_SharePinterest"]">
                                <i class="bi bi-pinterest"></i>
                                <span class="d-none d-md-inline ms-1">Pinterest</span>
                            </a>
                            <button class="btn btn-sm btn-outline-secondary share-btn" 
                                    onclick="copyProductLink()"
                                    title="@L["Product_CopyLink"]">
                                <i class="bi bi-link-45deg"></i>
                                <span class="d-none d-md-inline ms-1">@L["Product_CopyLink"]</span>
                            </button>
                        </div>
                    </div>
                </article>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="container my-5">
    <div class="reviews-section">
        <div class="reviews-header">
            <h2>@L["Review_Title"]</h2>
            @if (Model.Reviews?.Any() == true)
            {
                <div class="rating-summary">
                    <div class="average-rating">
                        <span class="rating-number">@Model.AverageRating.ToString("F1")</span>
                        <div class="stars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= Math.Floor((double)Model.AverageRating))
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else if (i - 0.5 <= (double)Model.AverageRating)
                                {
                                    <i class="fas fa-star-half-alt"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <span class="review-count">@L["Review_BasedOn"] @Model.ReviewCount @L["Review_Reviews"]</span>
                    </div>
                </div>
            }
        </div>

        <!-- Reviews List -->
        <div class="reviews-list">
            @if (Model.Reviews?.Any() == true)
            {
                foreach (var review in Model.Reviews.Where(r => r.IsVisible).OrderByDescending(r => r.CreatedAt))
                {
                    <div class="review-card" data-review-id="@review.Id">
                        <div class="review-header">
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <span class="user-name">@review.User?.UserName</span>
                                    @if (review.IsVerifiedPurchase)
                                    {
                                        <span class="verified-badge">
                                            <i class="fas fa-check-circle"></i> @L["Review_VerifiedPurchase"]
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="review-date">@review.CreatedAt.ToString("dd MMM yyyy")</div>
                        </div>
                        <div class="review-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= review.Rating)
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <div class="review-comment">
                            @review.Comment
                        </div>
                        
                        @if (!string.IsNullOrEmpty(review.AdminReply))
                        {
                            <div class="admin-reply">
                                <div class="admin-reply-header">
                                    <i class="fas fa-reply"></i>
                                    <strong>@L["Review_AdminReply"]</strong>
                                    @if (review.AdminReplyAt.HasValue)
                                    {
                                        <span class="reply-date">@review.AdminReplyAt.Value.ToString("dd MMM yyyy")</span>
                                    }
                                </div>
                                <div class="admin-reply-content">
                                    @review.AdminReply
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="no-reviews">
                    <i class="fas fa-comment-slash"></i>
                    <h3>@L["Review_NoReviews"]</h3>
                    <p>@L["Review_NoReviews_Message"]</p>
                </div>
            }
        </div>

        <!-- Write Review Form -->
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="write-review-section">
                <h3>@L["Review_WriteReview"]</h3>
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle"></i> @L["Review_PurchaseRequired"]
                </p>
                <form id="reviewForm">
                    @Html.AntiForgeryToken()
                    <div class="form-group">
                        <label>@L["Review_YourRating"]</label>
                        <div class="star-rating-input">
                            @for (int i = 5; i >= 1; i--)
                            {
                                <input type="radio" id="star@(i)" name="rating" value="@i" />
                                <label for="star@(i)"><i class="fas fa-star"></i></label>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reviewComment">@L["Review_YourComment"]</label>
                        <textarea id="reviewComment" name="comment" class="form-control" rows="4" 
                                  placeholder="@L["Review_CommentPlaceholder"]" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">@L["Review_Submit"]</button>
                </form>
            </div>
        }
        else
        {
            <div class="login-prompt">
                <i class="fas fa-sign-in-alt"></i>
                <p>@L["Review_LoginRequired"]</p>
                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-primary">@L["Account_Login"]</a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <!-- ViewerJS Library -->
    <link rel="stylesheet" href="~/lib/viewerjs/viewer.min.css" asp-append-version="true" />
    <script src="~/lib/viewerjs/viewer.min.js" asp-append-version="true"></script>
    
    <script>
        var selectedVariantId = null;
        var selectedColorId = null;
        var selectedSizeId = null;
        var hasVariants = @(Model.Variants != null && Model.Variants.Any() ? "true" : "false");
        var isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");
        
        // Size button click
        document.addEventListener('click', function(e) {
            if (e.target.closest('.size-option')) {
                var btn = e.target.closest('.size-option');
                if (btn.disabled) return;
                
                document.querySelectorAll('.size-option').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                selectedVariantId = btn.getAttribute('data-variant-id');
                selectedColorId = btn.getAttribute('data-color-id');
                selectedSizeId = btn.getAttribute('data-size-id');
                var stock = btn.getAttribute('data-stock');
                
                document.getElementById('quantity').max = stock;
                document.getElementById('quantity').readOnly = false;
                document.getElementById('quantity').value = 1;
                document.getElementById('addToCartBtn').disabled = false;
            }
        });
        
        // Quantity minus
        document.getElementById('qtyMinus').onclick = function() {
            var input = document.getElementById('quantity');
            var val = parseInt(input.value) || 1;
            if (val > 1) input.value = val - 1;
        };
        
        // Quantity plus
        document.getElementById('qtyPlus').onclick = function() {
            var input = document.getElementById('quantity');
            var val = parseInt(input.value) || 1;
            var max = parseInt(input.max) || 99;
            if (val < max) input.value = val + 1;
        };
        
        // Add to cart
        document.getElementById('addToCartBtn').onclick = function() {
            if (hasVariants && !selectedVariantId) {
                alert('Please select a size first');
                return;
            }
            
            var quantity = parseInt(document.getElementById('quantity').value) || 1;
            var btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            if (!isAuthenticated) {
                var guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                var itemColorId = hasVariants ? selectedColorId : null;
                var itemSizeId = hasVariants ? selectedSizeId : null;
                
                var existingIndex = -1;
                for (var i = 0; i < guestCart.length; i++) {
                    if (guestCart[i].productId === @Model.Id && 
                        guestCart[i].colorId === itemColorId && 
                        guestCart[i].sizeId === itemSizeId) {
                        existingIndex = i;
                        break;
                    }
                }
                
                if (existingIndex >= 0) {
                    guestCart[existingIndex].quantity += quantity;
                } else {
                    guestCart.push({
                        productId: @Model.Id,
                        colorId: itemColorId,
                        sizeId: itemSizeId,
                        quantity: quantity
                    });
                }
                
                localStorage.setItem('guestCart', JSON.stringify(guestCart));
                
                var totalItems = 0;
                for (var i = 0; i < guestCart.length; i++) {
                    totalItems += guestCart[i].quantity;
                }
                var badge = document.querySelector('.cart-badge');
                if (badge) {
                    badge.textContent = totalItems;
                    badge.style.display = 'block';
                }
                
                // Trigger cart update event
                window.dispatchEvent(new Event('cartUpdated'));
                
                btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                setTimeout(function() {
                    btn.disabled = hasVariants && !selectedVariantId;
                    btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                }, 2000);
                return;
            }
            
            fetch('/Cart/api/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: @Model.Id,
                    colorId: hasVariants ? selectedColorId : null,
                    sizeId: hasVariants ? selectedSizeId : null,
                    quantity: quantity
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    var badge = document.querySelector('.cart-badge');
                    if (badge && data.count) {
                        badge.textContent = data.count;
                        badge.style.display = 'block';
                    }
                    
                    // Trigger cart update event
                    window.dispatchEvent(new Event('cartUpdated'));
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                    setTimeout(function() {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                    }, 2000);
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                }
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
            });
        };
        
        // Wishlist
        document.getElementById('addToWishlistBtn').onclick = function() {
            if (!isAuthenticated) {
                window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            var btn = this;
            fetch('/Wishlist/Toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=@Model.Id'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    var icon = btn.querySelector('i');
                    if (data.added) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                }
            });
        };

        // Copy product link to clipboard
        function copyProductLink() {
            var url = '@Html.Raw(canonicalUrl)';
            navigator.clipboard.writeText(url).then(function() {
                // Show success feedback
                var btn = document.querySelector('.share-btn[onclick="copyProductLink()"]');
                var originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check2"></i> <span class="d-none d-md-inline ms-1">@L["Product_LinkCopied"].Replace("!", "")</span>';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                setTimeout(function() {
                    btn.innerHTML = originalHtml;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            }, function() {
                // Fallback for older browsers
                var tempInput = document.createElement('input');
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('@L["Product_LinkCopied"]');
            });
        }

        // Copy promo code to clipboard
        function copyPromoCode(code) {
            navigator.clipboard.writeText(code).then(function() {
                var btn = document.querySelector('.copy-code-btn');
                btn.classList.add('copied');
                btn.innerHTML = '<i class="bi bi-check2"></i>';
                setTimeout(function() {
                    btn.classList.remove('copied');
                    btn.innerHTML = '<i class="bi bi-clipboard"></i>';
                }, 2000);
            });
        }
    </script>
}


