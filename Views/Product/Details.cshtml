@model Kokomija.Entity.Product
@inject Kokomija.Services.ILocalizationService Localizer

@{
    var relatedProducts = ViewBag.RelatedProducts as List<Kokomija.Entity.Product> ?? new List<Kokomija.Entity.Product>();
    var productName = !string.IsNullOrEmpty(Model.NameKey) ? Localizer[Model.NameKey] : Model.Name;
    var productDescription = !string.IsNullOrEmpty(Model.DescriptionKey) ? Localizer[Model.DescriptionKey] : Model.Description;
}

<div class="product-detail-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="product-breadcrumb">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">@Localizer["Home"]</a></li>
                <li class="breadcrumb-item"><a asp-controller="Product" asp-action="Index">@Localizer["Products"]</a></li>
                @if (Model.Category != null)
                {
                    <li class="breadcrumb-item">
                        <a asp-controller="Product" asp-action="Category" asp-route-slug="@Model.Category.Slug">
                            @(!string.IsNullOrEmpty(Model.Category.NameKey) ? Localizer[Model.Category.NameKey] : Model.Category.Name)
                        </a>
                    </li>
                }
                <li class="breadcrumb-item active" aria-current="page">@productName</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row g-5">
            <!-- Image Gallery Section -->
            <div class="col-lg-7">
                <div class="product-gallery" id="productGallery">
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        var imageCount = Model.Images.Count();
                        var orderedImages = Model.Images.OrderBy(i => i.DisplayOrder).ToList();
                        
                        @if (imageCount == 1)
                        {
                            <!-- Single Large Image -->
                            var singleImage = orderedImages.First();
                            var imgUrl = Url.Content($"~/img/ProductImage/{singleImage.ImageUrl}");
                            
                            <div class="single-image-container">
                                <img src="@imgUrl" 
                                     alt="@productName" 
                                     class="single-product-image" 
                                     id="viewerImage"
                                     onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                <div class="image-click-hint">
                                    <i class="fas fa-search-plus"></i> @Localizer["Product_ClickToEnlarge"]
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Multiple Images with Thumbnails and Navigation -->
                            var mainImage = orderedImages.First();
                            var mainImageUrl = Url.Content($"~/img/ProductImage/{mainImage.ImageUrl}");
                            
                            <div class="main-image-container">
                                <div class="image-zoom-wrapper">
                                    <img src="@mainImageUrl" 
                                         alt="@productName" 
                                         class="main-product-image" 
                                         id="mainImage"
                                         data-index="0"
                                         onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                    <div class="image-click-hint">
                                        <i class="fas fa-search-plus"></i> @Localizer["Product_ClickToEnlarge"]
                                    </div>
                                </div>
                                
                                <!-- Image Navigation Arrows -->
                                <button class="image-nav prev" id="prevImage" aria-label="@Localizer["Previous"]">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="image-nav next" id="nextImage" aria-label="@Localizer["Next"]">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                
                                <!-- Image Counter -->
                                <div class="image-counter">
                                    <span id="currentImageIndex">1</span> / <span id="totalImages">@imageCount</span>
                                </div>
                            </div>

                            <!-- Thumbnail Gallery -->
                            <div class="thumbnail-gallery">
                                @for (int i = 0; i < orderedImages.Count; i++)
                                {
                                    var image = orderedImages[i];
                                    var imgUrl = Url.Content($"~/img/ProductImage/{image.ImageUrl}");
                                    
                                    <div class="thumbnail-item @(i == 0 ? "active" : "")" 
                                         data-index="@i"
                                         data-image="@imgUrl">
                                        <img src="@imgUrl" 
                                             alt="@productName" 
                                             onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.parentElement.classList.add('logo-fallback');" />
                                    </div>
                                }
                            </div>
                        }
                        
                        <!-- Hidden images for viewer -->
                        <div id="imageViewer" style="display: none;">
                            @foreach (var image in orderedImages)
                            {
                                var imgUrl = Url.Content($"~/img/ProductImage/{image.ImageUrl}");
                                <img src="@imgUrl" alt="@productName" />
                            }
                        </div>
                    }
                    else
                    {
                        <!-- No Images - Show Logo -->
                        <div class="single-image-container">
                            <img src="@Url.Content("~/img/logo_black.png")" 
                                 alt="Kokomija" 
                                 class="single-product-image logo-fallback" 
                                 id="viewerImage" />
                        </div>
                    }
                </div>

                <!-- Product Features (Below Gallery) -->
                <div class="product-features">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-shield-alt"></i>
                                <h6>@Localizer["Product_Quality"]</h6>
                                <p>@Localizer["Product_Quality_Desc"]</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-truck-fast"></i>
                                <h6>@Localizer["Product_FastShipping"]</h6>
                                <p>@Localizer["Product_FastShipping_Desc"]</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-rotate-left"></i>
                                <h6>@Localizer["Product_Returns"]</h6>
                                <p>@Localizer["Product_Returns_Desc"]</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="col-lg-5">
                <div class="product-info">
                    <!-- Product Title -->
                    <h1 class="product-title">@productName</h1>

                    <!-- Rating and Reviews -->
                    <div class="product-rating">
                        <div class="stars">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="rating-text">4.89 <span class="review-count">(56 @Localizer["Product_Reviews"])</span></span>
                    </div>

                    <!-- Price -->
                    <div class="product-price-section">
                        <div class="price-display">
                            <span class="current-price" id="productPrice">@Model.Price.ToString("N2") zł</span>
                            <span class="price-per-piece">(@Localizer["Product_PricePerPiece"])</span>
                        </div>
                        @if (Model.Price > 60)
                        {
                            <div class="savings-badge">
                                <i class="fas fa-tag"></i>
                                @Localizer["Product_BestValue"]
                            </div>
                        }
                    </div>

                    <!-- Pack Size Switcher -->
                    @if (relatedProducts.Any())
                    {
                        <div class="pack-switcher">
                            <label class="section-label">@Localizer["Product_PackSize"]</label>
                            <div class="pack-options">
                                @foreach (var relatedProduct in relatedProducts.OrderBy(p => p.Price))
                                {
                                    var isCurrentProduct = relatedProduct.Id == Model.Id;
                                    var packSize = relatedProduct.Name.Contains("5 pak") ? "5" : 
                                                  relatedProduct.Name.Contains("6 pak") ? "6" : "8";
                                    var perPiecePrice = relatedProduct.Price / decimal.Parse(packSize);
                                    var isBestValue = packSize == "8";
                                    
                                    <a asp-controller="Product" asp-action="Details" asp-route-id="@relatedProduct.Id" 
                                       class="pack-option @(isCurrentProduct ? "active" : "") @(isBestValue ? "best-value" : "")">
                                        @if (isBestValue)
                                        {
                                            <span class="best-value-tag">@Localizer["Product_BestValue"]</span>
                                        }
                                        <div class="pack-count">@packSize @Localizer["Product_Pack"]</div>
                                        <div class="pack-price">@relatedProduct.Price.ToString("N2") zł</div>
                                        <div class="pack-unit-price">@perPiecePrice.ToString("N2") zł/@Localizer["Product_Piece"]</div>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    <!-- Size Selection -->
                    @if (Model.Variants != null && Model.Variants.Any())
                    {
                        <div class="size-selection">
                            <label class="section-label">
                                @Localizer["Product_SelectSize"]
                                <a href="#sizeGuide" class="size-guide-link">
                                    <i class="fas fa-ruler"></i> @Localizer["Product_SizeGuide"]
                                </a>
                            </label>
                            <div class="size-options">
                                @foreach (var variant in Model.Variants.GroupBy(v => v.Size?.Name).OrderBy(g => g.Key))
                                {
                                    var size = variant.First().Size;
                                    var isAvailable = variant.First().StockQuantity > 0;
                                    var variantId = variant.First().Id;
                                    var colorId = variant.First().ColorId;
                                    var sizeId = variant.First().SizeId;
                                    
                                    <button class="size-option @(!isAvailable ? "out-of-stock" : "")" 
                                            data-variant-id="@variantId"
                                            data-color-id="@colorId"
                                            data-size-id="@sizeId"
                                            data-size="@size?.Name"
                                            data-stock="@variant.First().StockQuantity"
                                            @(!isAvailable ? "disabled" : "")>
                                        <span class="size-name">@size?.Name</span>
                                        @if (!isAvailable)
                                        {
                                            <span class="stock-status">@Localizer["Product_OutOfStock"]</span>
                                        }
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <!-- Quantity Selector -->
                    <div class="quantity-selector">
                        <label class="section-label">@Localizer["Product_Quantity"]</label>
                        <div class="quantity-controls">
                            <button type="button" class="qty-btn minus" id="qtyMinus">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="qty-input" id="quantity" value="1" min="1" max="99" />
                            <button type="button" class="qty-btn plus" id="qtyPlus">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <span class="stock-info" id="stockInfo">
                            <i class="fas fa-box"></i> @Localizer["Product_InStock"]
                        </span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="product-actions">
                        <button class="btn btn-primary btn-add-cart" id="addToCartBtn" disabled>
                            <i class="fas fa-shopping-cart"></i>
                            @Localizer["Product_AddToCart"]
                        </button>
                        <button class="btn btn-outline-secondary btn-wishlist" id="addToWishlistBtn">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>

                    <!-- Product Description -->
                    <div class="product-description">
                        <h5 class="description-title">@Localizer["Product_Description"]</h5>
                        <p>@productDescription</p>
                    </div>

                    <!-- Product Specifications -->
                    <div class="product-specifications">
                        <h5 class="specs-title">@Localizer["Product_Specifications"]</h5>
                        <ul class="specs-list">
                            <li>
                                <span class="spec-label">@Localizer["Product_Material"]:</span>
                                <span class="spec-value">@Localizer["Product_Material_Cotton"]</span>
                            </li>
                            <li>
                                <span class="spec-label">@Localizer["Product_Care"]:</span>
                                <span class="spec-value">@Localizer["Product_Care_Instructions"]</span>
                            </li>
                            <li>
                                <span class="spec-label">@Localizer["Product_Brand"]:</span>
                                <span class="spec-value">Kokomija</span>
                            </li>
                            <li>
                                <span class="spec-label">SKU:</span>
                                <span class="spec-value" id="productSKU">-</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="badge-item">
                            <i class="fas fa-lock"></i>
                            <span>@Localizer["Product_SecurePayment"]</span>
                        </div>
                        <div class="badge-item">
                            <i class="fas fa-certificate"></i>
                            <span>@Localizer["Product_Certified"]</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="container my-5">
    <div class="reviews-section">
        <div class="reviews-header">
            <h2>@Localizer["Review_Title"]</h2>
            @if (Model.Reviews?.Any() == true)
            {
                <div class="rating-summary">
                    <div class="average-rating">
                        <span class="rating-number">@Model.AverageRating.ToString("F1")</span>
                        <div class="stars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= Math.Floor((double)Model.AverageRating))
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else if (i - 0.5 <= (double)Model.AverageRating)
                                {
                                    <i class="fas fa-star-half-alt"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <span class="review-count">@Localizer["Review_BasedOn"] @Model.ReviewCount @Localizer["Review_Reviews"]</span>
                    </div>
                </div>
            }
        </div>

        <!-- Reviews List -->
        <div class="reviews-list">
            @if (Model.Reviews?.Any() == true)
            {
                foreach (var review in Model.Reviews.Where(r => r.IsVisible).OrderByDescending(r => r.CreatedAt))
                {
                    <div class="review-card" data-review-id="@review.Id">
                        <div class="review-header">
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <span class="user-name">@review.User?.UserName</span>
                                    @if (review.IsVerifiedPurchase)
                                    {
                                        <span class="verified-badge">
                                            <i class="fas fa-check-circle"></i> @Localizer["Review_VerifiedPurchase"]
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="review-date">@review.CreatedAt.ToString("dd MMM yyyy")</div>
                        </div>
                        <div class="review-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= review.Rating)
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <div class="review-comment">
                            @review.Comment
                        </div>
                        
                        @if (!string.IsNullOrEmpty(review.AdminReply))
                        {
                            <div class="admin-reply">
                                <div class="admin-reply-header">
                                    <i class="fas fa-reply"></i>
                                    <strong>@Localizer["Review_AdminReply"]</strong>
                                    @if (review.AdminReplyAt.HasValue)
                                    {
                                        <span class="reply-date">@review.AdminReplyAt.Value.ToString("dd MMM yyyy")</span>
                                    }
                                </div>
                                <div class="admin-reply-content">
                                    @review.AdminReply
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="no-reviews">
                    <i class="fas fa-comment-slash"></i>
                    <h3>@Localizer["Review_NoReviews"]</h3>
                    <p>@Localizer["Review_NoReviews_Message"]</p>
                </div>
            }
        </div>

        <!-- Write Review Form -->
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="write-review-section">
                <h3>@Localizer["Review_WriteReview"]</h3>
                <form id="reviewForm">
                    <div class="form-group">
                        <label>@Localizer["Review_YourRating"]</label>
                        <div class="star-rating-input">
                            @for (int i = 5; i >= 1; i--)
                            {
                                <input type="radio" id="star@(i)" name="rating" value="@i" />
                                <label for="star@(i)"><i class="fas fa-star"></i></label>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reviewComment">@Localizer["Review_YourComment"]</label>
                        <textarea id="reviewComment" name="comment" class="form-control" rows="4" 
                                  placeholder="@Localizer["Review_CommentPlaceholder"]" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">@Localizer["Review_Submit"]</button>
                </form>
            </div>
        }
        else
        {
            <div class="login-prompt">
                <i class="fas fa-sign-in-alt"></i>
                <p>@Localizer["Review_LoginRequired"]</p>
                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-primary">@Localizer["Account_Login"]</a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <!-- ViewerJS Library -->
    <link rel="stylesheet" href="~/lib/viewerjs/viewer.min.css" asp-append-version="true" />
    <script src="~/lib/viewerjs/viewer.min.js" asp-append-version="true"></script>
    
    <script>
        $(document).ready(function() {
            let selectedVariantId = null;
            let selectedColorId = null;
            let selectedSizeId = null;
            let currentImageIndex = 0;
            let viewer = null;
            
            // Initialize ViewerJS for image viewing
            @if (Model.Images != null && Model.Images.Any())
            {
                var imageCount = Model.Images.Count();
                <text>
            const imageCount = @imageCount;</text>
            }
            else
            {
                <text>
            const imageCount = 1;</text>
            }
            <text>
            
            if (imageCount === 1) {
                // Single image - full screen viewer on click
                const singleImage = document.getElementById('viewerImage');
                if (singleImage) {
                    viewer = new Viewer(singleImage, {
                        inline: false,
                        toolbar: {
                            zoomIn: 1,
                            zoomOut: 1,
                            oneToOne: 1,
                            reset: 1,
                            rotateLeft: 1,
                            rotateRight: 1,
                            flipHorizontal: 1,
                            flipVertical: 1,
                        },
                        title: false,
                        navbar: false,
                        button: true,
                        backdrop: true,
                        keyboard: true,
                        transition: true,
                    });
                }
            } else {
                // Multiple images - gallery viewer
                const imageViewerContainer = document.getElementById('imageViewer');
                if (imageViewerContainer) {
                    viewer = new Viewer(imageViewerContainer, {
                        inline: false,
                        toolbar: {
                            zoomIn: 1,
                            zoomOut: 1,
                            oneToOne: 1,
                            reset: 1,
                            prev: 1,
                            play: 1,
                            next: 1,
                            rotateLeft: 1,
                            rotateRight: 1,
                        },
                        title: true,
                        navbar: true,
                        button: true,
                        backdrop: true,
                        keyboard: true,
                        transition: true,
                    });
                }
                
                // Main image click to open viewer
                $('#mainImage').click(function() {
                    const index = parseInt($(this).attr('data-index') || 0);
                    viewer.view(index);
                });
                
                // Thumbnail navigation
                $('.thumbnail-item').click(function() {
                    const index = parseInt($(this).attr('data-index'));
                    currentImageIndex = index;
                    updateMainImage(index);
                });
                
                // Arrow navigation
                $('#prevImage').click(function() {
                    currentImageIndex = (currentImageIndex - 1 + imageCount) % imageCount;
                    updateMainImage(currentImageIndex);
                });
                
                $('#nextImage').click(function() {
                    currentImageIndex = (currentImageIndex + 1) % imageCount;
                    updateMainImage(currentImageIndex);
                });
                
                function updateMainImage(index) {
                    const $thumbnail = $('.thumbnail-item').eq(index);
                    const imageSrc = $thumbnail.data('image');
                    $('#mainImage').attr('src', imageSrc).attr('data-index', index);
                    $('.thumbnail-item').removeClass('active');
                    $thumbnail.addClass('active');
                    $('#currentImageIndex').text(index + 1);
                }
            }
                </text>
            }
            
            // Size selection
            $('.size-option').click(function() {
                if ($(this).hasClass('out-of-stock')) return;
                
                $('.size-option').removeClass('selected');
                $(this).addClass('selected');
                
                selectedVariantId = $(this).data('variant-id');
                selectedColorId = $(this).data('color-id');
                selectedSizeId = $(this).data('size-id');
                const stock = $(this).data('stock');
                const size = $(this).data('size');
                
                // Update stock info
                $('#stockInfo').html(`<i class="fas fa-box"></i> ${stock} @Localizer["Product_InStock"]`);
                $('#quantity').attr('max', stock);
                
                // Update SKU
                $('#productSKU').text(`PRODUCT-${size}-@Model.Id`);
                
                // Enable add to cart button
                $('#addToCartBtn').prop('disabled', false);
            });
            
            // Quantity controls
            $('#qtyMinus').click(function() {
                const input = $('#quantity');
                const val = parseInt(input.val()) || 1;
                if (val > 1) {
                    input.val(val - 1);
                }
            });
            
            $('#qtyPlus').click(function() {
                const input = $('#quantity');
                const val = parseInt(input.val()) || 1;
                const max = parseInt(input.attr('max')) || 99;
                if (val < max) {
                    input.val(val + 1);
                }
            });
            
            // Manual quantity input validation
            $('#quantity').on('input', function() {
                const val = parseInt($(this).val()) || 1;
                const max = parseInt($(this).attr('max')) || 99;
                const min = parseInt($(this).attr('min')) || 1;
                
                if (val > max) $(this).val(max);
                if (val < min) $(this).val(min);
            });
            
            // Add to Cart
            $('#addToCartBtn').click(function() {
                if (!selectedVariantId) {
                    alert('@Localizer["Product_SelectSizeFirst"]');
                    return;
                }
                
                const quantity = parseInt($('#quantity').val()) || 1;
                const btn = $(this);
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> @Localizer["Product_Adding"]');
                
                // Check if user is authenticated
                const isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");
                
                if (!isAuthenticated) {
                    // Save to localStorage for guest users
                    let guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                    
                    // Check if item already exists
                    const existingItemIndex = guestCart.findIndex(item => 
                        item.productId === @Model.Id && 
                        item.colorId === selectedColorId && 
                        item.sizeId === selectedSizeId
                    );
                    
                    if (existingItemIndex >= 0) {
                        guestCart[existingItemIndex].quantity += quantity;
                    } else {
                        guestCart.push({
                            productId: @Model.Id,
                            colorId: selectedColorId,
                            sizeId: selectedSizeId,
                            quantity: quantity
                        });
                    }
                    
                    localStorage.setItem('guestCart', JSON.stringify(guestCart));
                    
                    // Update cart badge
                    const totalItems = guestCart.reduce((sum, item) => sum + item.quantity, 0);
                    $('.cart-badge').text(totalItems).show();
                    
                    // Show success
                    btn.html('<i class="fas fa-check"></i> @Localizer["Product_Added"]');
                    setTimeout(() => {
                        btn.prop('disabled', false).html('<i class="fas fa-shopping-cart"></i> @Localizer["Product_AddToCart"]');
                    }, 2000);
                    return;
                }
                
                // Authenticated user - add via API
                $.ajax({
                    url: '/Cart/api/add',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        productId: @Model.Id,
                        colorId: selectedColorId,
                        sizeId: selectedSizeId,
                        quantity: quantity
                    }),
                    success: function(response) {
                        if (response.success) {
                            // Update cart count
                            if (response.count) {
                                $('.cart-badge').text(response.count).show();
                            }
                            
                            // Show success animation
                            btn.html('<i class="fas fa-check"></i> @Localizer["Product_Added"]');
                            setTimeout(() => {
                                btn.prop('disabled', false).html('<i class="fas fa-shopping-cart"></i> @Localizer["Product_AddToCart"]');
                            }, 2000);
                        } else if (response.requiresLogin) {
                            // Redirect to login with return URL
                            window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                        } else {
                            alert(response.message || '@Localizer["Error_Generic"]');
                            btn.prop('disabled', false).html('<i class="fas fa-shopping-cart"></i> @Localizer["Product_AddToCart"]');
                        }
                    },
                    error: function(xhr) {
                        console.error('Error:', xhr);
                        if (xhr.status === 401) {
                            // Unauthorized - redirect to login
                            window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                        } else {
                            alert('@Localizer["Error_Generic"]');
                            btn.prop('disabled', false).html('<i class="fas fa-shopping-cart"></i> @Localizer["Product_AddToCart"]');
                        }
                    }
                });
            });
            
            // Add to Wishlist
            $('#addToWishlistBtn').click(function() {
                const btn = $(this);
                const icon = btn.find('i');
                
                $.ajax({
                    url: '/Wishlist/Toggle',
                    method: 'POST',
                    data: { productId: @Model.Id },
                    success: function(response) {
                        if (response.success) {
                            if (response.added) {
                                icon.removeClass('far').addClass('fas');
                                btn.addClass('active');
                            } else {
                                icon.removeClass('fas').addClass('far');
                                btn.removeClass('active');
                            }
                        }
                    },
                    error: function(xhr) {
                        if (xhr.status === 401) {
                            window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                        }
                    }
                });
            });

            // Review submission
            $('#reviewForm').submit(function(e) {
                e.preventDefault();
                
                const rating = $('input[name="rating"]:checked').val();
                const comment = $('#reviewComment').val();
                
                if (!rating) {
                    alert('@Localizer["Review_SelectRating"]');
                    return;
                }
                
                $.ajax({
                    url: '/Review/Create',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        productId: @Model.Id,
                        rating: parseFloat(rating),
                        comment: comment
                    }),
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('@Localizer["Review_Error"]');
                    }
                });
            });

            // Star rating hover effect
            $('.star-rating-input label').hover(
                function() {
                    const rating = $(this).prev('input').val();
                    $('.star-rating-input label').each(function(index) {
                        if (index >= (5 - rating)) {
                            $(this).addClass('hover');
                        }
                    });
                },
                function() {
                    $('.star-rating-input label').removeClass('hover');
                }
            );
        });
    </script>
}
