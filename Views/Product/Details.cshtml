@model Kokomija.Entity.Product
@inject Kokomija.Services.ILocalizationService L

@{
    var relatedProducts = ViewBag.RelatedProducts as List<Kokomija.Entity.Product> ?? new List<Kokomija.Entity.Product>();
    var productName = !string.IsNullOrEmpty(Model.NameKey) ? L[Model.NameKey] : Model.Name;
    var productDescription = !string.IsNullOrEmpty(Model.DescriptionKey) ? L[Model.DescriptionKey] : Model.Description;
}

<div class="product-detail-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="product-breadcrumb">
        <div class="container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">@L["Home"]</a></li>
                <li class="breadcrumb-item"><a asp-controller="Product" asp-action="Index">@L["Products"]</a></li>
                @if (Model.Category != null)
                {
                    <li class="breadcrumb-item">
                        <a asp-controller="Product" asp-action="Category" asp-route-slug="@Model.Category.Slug">
                            @(!string.IsNullOrEmpty(Model.Category.NameKey) ? L[Model.Category.NameKey] : Model.Category.Name)
                        </a>
                    </li>
                }
                <li class="breadcrumb-item active" aria-current="page">@productName</li>
            </ol>
        </div>
    </nav>

    <div class="container">
        <div class="row g-5">
            <!-- Image Gallery Section -->
            <div class="col-lg-7">
                <div class="product-gallery" id="productGallery">
                    @if (Model.Images != null && Model.Images.Any())
                    {
                        var imageCount = Model.Images.Count();
                        var orderedImages = Model.Images.OrderBy(i => i.DisplayOrder).ToList();
                        
                        @if (imageCount == 1)
                        {
                            <!-- Single Large Image -->
                            var singleImage = orderedImages.First();
                            var imgUrl = Url.Content($"~/img/ProductImage/{singleImage.ImageUrl}");
                            
                            <div class="single-image-container">
                                <img src="@imgUrl" 
                                     alt="@productName" 
                                     class="single-product-image" 
                                     id="viewerImage"
                                     onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                <div class="image-click-hint">
                                    <i class="fas fa-search-plus"></i> @L.GetString("ClickToEnlarge", "Product")
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Multiple Images with Thumbnails and Navigation -->
                            var mainImage = orderedImages.First();
                            var mainImageUrl = Url.Content($"~/img/ProductImage/{mainImage.ImageUrl}");
                            
                            <div class="main-image-container">
                                <div class="image-zoom-wrapper">
                                    <img src="@mainImageUrl" 
                                         alt="@productName" 
                                         class="main-product-image" 
                                         id="mainImage"
                                         data-index="0"
                                         onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                    <div class="image-click-hint">
                                        <i class="fas fa-search-plus"></i> @L.GetString("ClickToEnlarge", "Product")
                                    </div>
                                </div>
                                
                                <!-- Image Navigation Arrows -->
                                <button class="image-nav prev" id="prevImage" aria-label="@L["Previous"]">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="image-nav next" id="nextImage" aria-label="@L["Next"]">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                                
                                <!-- Image Counter -->
                                <div class="image-counter">
                                    <span id="currentImageIndex">1</span> / <span id="totalImages">@imageCount</span>
                                </div>
                            </div>

                            <!-- Thumbnail Gallery -->
                            <div class="thumbnail-gallery">
                                @for (int i = 0; i < orderedImages.Count; i++)
                                {
                                    var image = orderedImages[i];
                                    var imgUrl = Url.Content($"~/img/ProductImage/{image.ImageUrl}");
                                    
                                    <div class="thumbnail-item @(i == 0 ? "active" : "")" 
                                         data-index="@i"
                                         data-image="@imgUrl">
                                        <img src="@imgUrl" 
                                             alt="@productName" 
                                             onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.parentElement.classList.add('logo-fallback');" />
                                    </div>
                                }
                            </div>
                        }
                        
                        <!-- Hidden images for viewer -->
                        <div id="imageViewer" style="display: none;">
                            @foreach (var image in orderedImages)
                            {
                                var imgUrl = Url.Content($"~/img/ProductImage/{image.ImageUrl}");
                                <img src="@imgUrl" alt="@productName" />
                            }
                        </div>
                    }
                    else
                    {
                        <!-- No Images - Show Logo -->
                        <div class="single-image-container">
                            <img src="@Url.Content("~/img/logo_black.png")" 
                                 alt="Kokomija" 
                                 class="single-product-image logo-fallback" 
                                 id="viewerImage" />
                        </div>
                    }
                </div>

                <!-- Product Features (Below Gallery) -->
                <div class="product-features">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-shield-alt"></i>
                                <h6>@L.GetString("Quality", "Product")</h6>
                                <p>@L.GetString("QualityDesc", "Product")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-truck-fast"></i>
                                <h6>@L.GetString("FastShipping", "Product")</h6>
                                <p>@L.GetString("FastShippingDesc", "Product")</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-card">
                                <i class="fas fa-rotate-left"></i>
                                <h6>@L.GetString("Returns", "Product")</h6>
                                <p>@L.GetString("ReturnsDesc", "Product")</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Info Section -->
            <div class="col-lg-5">
                <div class="product-info">
                    <!-- Product Title -->
                    <h1 class="product-title">@productName</h1>

                    <!-- Rating and Reviews -->
                    <div class="product-rating">
                        <div class="stars">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <span class="rating-text">4.89 <span class="review-count">(56 @L.GetString("Reviews", "Product"))</span></span>
                    </div>

                    <!-- Price -->
                    <div class="product-price-section">
                        <div class="price-display">
                            @if (Model.PackSize > 1)
                            {
                                var pricePerPiece = Model.Price / Model.PackSize;
                                <span class="current-price" id="productPrice">@Model.Price.ToString("N2") zł</span>
                                <span class="price-per-piece">(@pricePerPiece.ToString("N2") zł / @L.GetString("Piece", "Product"))</span>
                            }
                            else
                            {
                                <span class="current-price" id="productPrice">@Model.Price.ToString("N2") zł</span>
                            }
                        </div>
                        @if (Model.Price > 60)
                        {
                            <div class="savings-badge">
                                <i class="fas fa-tag"></i>
                                @L.GetString("BestValue", "Product")
                            </div>
                        }
                    </div>

                    <!-- Pack Size Switcher -->
                    @{
                        var hasRelatedProducts = relatedProducts.Any();
                        var allPackOptions = new List<Kokomija.Entity.Product>();
                        
                        if (Model.ProductGroupId.HasValue)
                        {
                            // Build complete list of all packs including current
                            allPackOptions = relatedProducts.ToList();
                            allPackOptions.Add(Model);
                            allPackOptions = allPackOptions.OrderBy(p => p.PackSize).ToList();
                        }
                    }
                    
                    @if (allPackOptions.Any())
                    {
                        <div class="pack-switcher">
                            <label class="section-label">@L.GetString("PackSize", "Product")</label>
                            <div class="pack-options">
                                @foreach (var pack in allPackOptions)
                                {
                                    var isCurrentProduct = pack.Id == Model.Id;
                                    var packSize = pack.PackSize;
                                    var perPiecePrice = pack.Price / packSize;
                                    var isBestValue = packSize == allPackOptions.Max(p => p.PackSize);
                                    
                                    <a asp-controller="Product" asp-action="Details" asp-route-id="@pack.Id" 
                                       class="pack-option @(isCurrentProduct ? "active" : "") @(isBestValue ? "best-value" : "")">
                                        @if (isBestValue)
                                        {
                                            <span class="best-value-tag">@L.GetString("BestValue", "Product")</span>
                                        }
                                        <div class="pack-count">@packSize @L.GetString("Pack", "Product")</div>
                                        <div class="pack-price">@pack.Price.ToString("N2") zł</div>
                                        <div class="pack-unit-price">@perPiecePrice.ToString("N2") zł/@L.GetString("Piece", "Product")</div>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    <!-- Size Selection -->
                    @if (Model.Variants != null && Model.Variants.Any())
                    {
                        <div class="size-selection">
                            <label class="section-label">
                                @L.GetString("SelectSize", "Product")
                                <a href="#sizeGuide" class="size-guide-link">
                                    <i class="fas fa-ruler"></i> @L.GetString("SizeGuide", "Product")
                                </a>
                            </label>
                            <div class="size-options">
                                @foreach (var variant in Model.Variants.GroupBy(v => v.Size?.Name).OrderBy(g => g.Key))
                                {
                                    var size = variant.First().Size;
                                    var isAvailable = variant.First().StockQuantity > 0;
                                    var variantId = variant.First().Id;
                                    var colorId = variant.First().ColorId;
                                    var sizeId = variant.First().SizeId;
                                    
                                    <button class="size-option @(!isAvailable ? "out-of-stock" : "")" 
                                            data-variant-id="@variantId"
                                            data-color-id="@colorId"
                                            data-size-id="@sizeId"
                                            data-size="@size?.Name"
                                            data-stock="@variant.First().StockQuantity"
                                            @(!isAvailable ? "disabled" : "")>
                                        <span class="size-name">@size?.Name</span>
                                        @if (!isAvailable)
                                        {
                                            <span class="stock-status">@L.GetString("OutOfStock", "Product")</span>
                                        }
                                    </button>
                                }
                            </div>
                        </div>
                    }

                    <!-- Quantity Selector -->
                    <div class="quantity-selector">
                        <label class="section-label">@L.GetString("Quantity", "Product")</label>
                        <div class="quantity-controls">
                            <button type="button" class="qty-btn minus" id="qtyMinus">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="qty-input" id="quantity" value="1" min="1" max="99" readonly />
                            <button type="button" class="qty-btn plus" id="qtyPlus">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <span class="stock-info" id="stockInfo">
                            <i class="fas fa-box"></i> @L.GetString("InStock", "Product")
                        </span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="product-actions">
                        <button class="btn btn-primary btn-add-cart" id="addToCartBtn" @(Model.Variants == null || !Model.Variants.Any() ? "" : "disabled")>
                            <i class="fas fa-shopping-cart"></i>
                            @L.GetString("AddToCart", "Product")
                        </button>
                        <button class="btn btn-outline-secondary btn-wishlist" id="addToWishlistBtn">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>

                    <!-- Product Description -->
                    <div class="product-description">
                        <h5 class="description-title">@L["Product_Description"]</h5>
                        <p>@productDescription</p>
                    </div>

                    <!-- Product Specifications -->
                    <div class="product-specifications">
                        <h5 class="specs-title">@L["Product_Specifications"]</h5>
                        <ul class="specs-list">
                            <li>
                                <span class="spec-label">@L["Product_Material"]:</span>
                                <span class="spec-value">@L["Product_Material_Cotton"]</span>
                            </li>
                            <li>
                                <span class="spec-label">@L["Product_Care"]:</span>
                                <span class="spec-value">@L["Product_Care_Instructions"]</span>
                            </li>
                            <li>
                                <span class="spec-label">@L["Product_Brand"]:</span>
                                <span class="spec-value">Kokomija</span>
                            </li>
                            <li>
                                <span class="spec-label">SKU:</span>
                                <span class="spec-value" id="productSKU">-</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Trust Badges -->
                    <div class="trust-badges">
                        <div class="badge-item">
                            <i class="fas fa-lock"></i>
                            <span>@L["Product_SecurePayment"]</span>
                        </div>
                        <div class="badge-item">
                            <i class="fas fa-certificate"></i>
                            <span>@L["Product_Certified"]</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reviews Section -->
<div class="container my-5">
    <div class="reviews-section">
        <div class="reviews-header">
            <h2>@L.GetString("Title", "Review")</h2>
            @if (Model.Reviews?.Any() == true)
            {
                <div class="rating-summary">
                    <div class="average-rating">
                        <span class="rating-number">@Model.AverageRating.ToString("F1")</span>
                        <div class="stars">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= Math.Floor((double)Model.AverageRating))
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else if (i - 0.5 <= (double)Model.AverageRating)
                                {
                                    <i class="fas fa-star-half-alt"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <span class="review-count">@L.GetString("BasedOn", "Review") @Model.ReviewCount @L.GetString("Reviews", "Review")</span>
                    </div>
                </div>
            }
        </div>

        <!-- Reviews List -->
        <div class="reviews-list">
            @if (Model.Reviews?.Any() == true)
            {
                foreach (var review in Model.Reviews.Where(r => r.IsVisible).OrderByDescending(r => r.CreatedAt))
                {
                    <div class="review-card" data-review-id="@review.Id">
                        <div class="review-header">
                            <div class="user-info">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <span class="user-name">@review.User?.UserName</span>
                                    @if (review.IsVerifiedPurchase)
                                    {
                                        <span class="verified-badge">
                                            <i class="fas fa-check-circle"></i> @L.GetString("VerifiedPurchase", "Review")
                                        </span>
                                    }
                                </div>
                            </div>
                            <div class="review-date">@review.CreatedAt.ToString("dd MMM yyyy")</div>
                        </div>
                        <div class="review-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                @if (i <= review.Rating)
                                {
                                    <i class="fas fa-star"></i>
                                }
                                else
                                {
                                    <i class="far fa-star"></i>
                                }
                            }
                        </div>
                        <div class="review-comment">
                            @review.Comment
                        </div>
                        
                        @if (!string.IsNullOrEmpty(review.AdminReply))
                        {
                            <div class="admin-reply">
                                <div class="admin-reply-header">
                                    <i class="fas fa-reply"></i>
                                    <strong>@L.GetString("AdminReply", "Review")</strong>
                                    @if (review.AdminReplyAt.HasValue)
                                    {
                                        <span class="reply-date">@review.AdminReplyAt.Value.ToString("dd MMM yyyy")</span>
                                    }
                                </div>
                                <div class="admin-reply-content">
                                    @review.AdminReply
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="no-reviews">
                    <i class="fas fa-comment-slash"></i>
                    <h3>@L.GetString("NoReviews", "Review")</h3>
                    <p>@L.GetString("NoReviews_Message", "Review")</p>
                </div>
            }
        </div>

        <!-- Write Review Form -->
        @if (User.Identity?.IsAuthenticated == true)
        {
            <div class="write-review-section">
                <h3>@L.GetString("WriteReview", "Review")</h3>
                <p class="text-muted mb-3">
                    <i class="fas fa-info-circle"></i> @L.GetString("PurchaseRequired", "Review")
                </p>
                <form id="reviewForm">
                    @Html.AntiForgeryToken()
                    <div class="form-group">
                        <label>@L.GetString("YourRating", "Review")</label>
                        <div class="star-rating-input">
                            @for (int i = 5; i >= 1; i--)
                            {
                                <input type="radio" id="star@(i)" name="rating" value="@i" />
                                <label for="star@(i)"><i class="fas fa-star"></i></label>
                            }
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="reviewComment">@L.GetString("YourComment", "Review")</label>
                        <textarea id="reviewComment" name="comment" class="form-control" rows="4" 
                                  placeholder="@L.GetString("CommentPlaceholder", "Review")" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">@L.GetString("Submit", "Review")</button>
                </form>
            </div>
        }
        else
        {
            <div class="login-prompt">
                <i class="fas fa-sign-in-alt"></i>
                <p>@L.GetString("LoginRequired", "Review")</p>
                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path" class="btn btn-primary">@L["Account_Login"]</a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <!-- ViewerJS Library -->
    <link rel="stylesheet" href="~/lib/viewerjs/viewer.min.css" asp-append-version="true" />
    <script src="~/lib/viewerjs/viewer.min.js" asp-append-version="true"></script>
    
    <script>
        var selectedVariantId = null;
        var selectedColorId = null;
        var selectedSizeId = null;
        var hasVariants = @(Model.Variants != null && Model.Variants.Any() ? "true" : "false");
        var isAuthenticated = @(User.Identity?.IsAuthenticated == true ? "true" : "false");
        
        // Size button click
        document.addEventListener('click', function(e) {
            if (e.target.closest('.size-option')) {
                var btn = e.target.closest('.size-option');
                if (btn.disabled) return;
                
                document.querySelectorAll('.size-option').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                
                selectedVariantId = btn.getAttribute('data-variant-id');
                selectedColorId = btn.getAttribute('data-color-id');
                selectedSizeId = btn.getAttribute('data-size-id');
                var stock = btn.getAttribute('data-stock');
                
                document.getElementById('quantity').max = stock;
                document.getElementById('quantity').readOnly = false;
                document.getElementById('quantity').value = 1;
                document.getElementById('addToCartBtn').disabled = false;
            }
        });
        
        // Quantity minus
        document.getElementById('qtyMinus').onclick = function() {
            var input = document.getElementById('quantity');
            var val = parseInt(input.value) || 1;
            if (val > 1) input.value = val - 1;
        };
        
        // Quantity plus
        document.getElementById('qtyPlus').onclick = function() {
            var input = document.getElementById('quantity');
            var val = parseInt(input.value) || 1;
            var max = parseInt(input.max) || 99;
            if (val < max) input.value = val + 1;
        };
        
        // Add to cart
        document.getElementById('addToCartBtn').onclick = function() {
            if (hasVariants && !selectedVariantId) {
                alert('Please select a size first');
                return;
            }
            
            var quantity = parseInt(document.getElementById('quantity').value) || 1;
            var btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            if (!isAuthenticated) {
                var guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                var itemColorId = hasVariants ? selectedColorId : null;
                var itemSizeId = hasVariants ? selectedSizeId : null;
                
                var existingIndex = -1;
                for (var i = 0; i < guestCart.length; i++) {
                    if (guestCart[i].productId === @Model.Id && 
                        guestCart[i].colorId === itemColorId && 
                        guestCart[i].sizeId === itemSizeId) {
                        existingIndex = i;
                        break;
                    }
                }
                
                if (existingIndex >= 0) {
                    guestCart[existingIndex].quantity += quantity;
                } else {
                    guestCart.push({
                        productId: @Model.Id,
                        colorId: itemColorId,
                        sizeId: itemSizeId,
                        quantity: quantity
                    });
                }
                
                localStorage.setItem('guestCart', JSON.stringify(guestCart));
                
                var totalItems = 0;
                for (var i = 0; i < guestCart.length; i++) {
                    totalItems += guestCart[i].quantity;
                }
                var badge = document.querySelector('.cart-badge');
                if (badge) {
                    badge.textContent = totalItems;
                    badge.style.display = 'block';
                }
                
                // Trigger cart update event
                window.dispatchEvent(new Event('cartUpdated'));
                
                btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                setTimeout(function() {
                    btn.disabled = hasVariants && !selectedVariantId;
                    btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                }, 2000);
                return;
            }
            
            fetch('/Cart/api/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    productId: @Model.Id,
                    colorId: hasVariants ? selectedColorId : null,
                    sizeId: hasVariants ? selectedSizeId : null,
                    quantity: quantity
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    var badge = document.querySelector('.cart-badge');
                    if (badge && data.count) {
                        badge.textContent = data.count;
                        badge.style.display = 'block';
                    }
                    
                    // Trigger cart update event
                    window.dispatchEvent(new Event('cartUpdated'));
                    
                    btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                    setTimeout(function() {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                    }, 2000);
                } else {
                    alert(data.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                }
            })
            .catch(err => {
                console.error(err);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
            });
        };
        
        // Wishlist
        document.getElementById('addToWishlistBtn').onclick = function() {
            if (!isAuthenticated) {
                window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            var btn = this;
            fetch('/Wishlist/Toggle', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=@Model.Id'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    var icon = btn.querySelector('i');
                    if (data.added) {
                        icon.classList.remove('far');
                        icon.classList.add('fas');
                    } else {
                        icon.classList.remove('fas');
                        icon.classList.add('far');
                    }
                }
            });
        };
    </script>
}


