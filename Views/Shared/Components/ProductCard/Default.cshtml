@model Kokomija.Models.ViewModels.ProductCardViewModel
@inject Kokomija.Services.ILocalizationService L

<div class="product-card" data-product-id="@Model.Id">
    <div class="product-card-inner">
        <!-- Image Gallery with Swiper & Overlay Content -->
        <div class="product-image-wrapper">
            <a asp-controller="Product" asp-action="Details" asp-route-id="@Model.Id" class="image-link">
                @if (Model.Images.Any())
                {
                    <div class="swiper product-swiper-@Model.Id">
                        <div class="swiper-wrapper">
                            @foreach (var image in Model.Images)
                            {
                                <div class="swiper-slide">
                                    <img src="/img/ProductImage/@image.ImageUrl" 
                                         alt="@image.AltText" 
                                         class="product-image"
                                         onerror="this.onerror=null; this.src='/img/logo_black.png';">
                                </div>
                            }
                        </div>
                        @if (Model.Images.Count > 1)
                        {
                            <div class="swiper-pagination"></div>
                        }
                    </div>
                }
                else
                {
                    <img src="/img/logo_black.png" alt="@Model.Name" class="product-image">
                }
            </a>
            
            <!-- Top Overlay: Badges & Quick Actions -->
            <div class="top-overlay">
                <div class="product-badges">
                    @if (Model.IsNew)
                    {
                        <span class="badge badge-new">@L.GetString("New", "Common")</span>
                    }
                    @if (Model.IsOnSale)
                    {
                        <span class="badge badge-sale">@L.GetString("Sale", "Common")</span>
                    }
                </div>
                <div class="quick-actions">
                    <button type="button" class="quick-action-btn wishlist-btn" title="Add to Wishlist" aria-label="Add to Wishlist">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Compact Product Info -->
        <div class="product-info">
            <h3 class="product-title">
                <a asp-controller="Product" asp-action="Details" asp-route-id="@Model.Id" class="text-decoration-none">
                    @Model.Name
                </a>
            </h3>

            <!-- Price Display with Discount -->
            <div class="product-price-section">
                @if (Model.DiscountedPrice.HasValue)
                {
                    <div class="price-with-discount">
                        <span class="price-current">
                            @Model.DiscountedPrice.Value.ToString("C", new System.Globalization.CultureInfo("pl-PL"))
                        </span>
                        <span class="price-original">
                            @Model.BasePrice.ToString("C", new System.Globalization.CultureInfo("pl-PL"))
                        </span>
                        <span class="discount-badge">
                            -@(Math.Round((1 - (Model.DiscountedPrice.Value / Model.BasePrice)) * 100))%
                        </span>
                    </div>
                }
                else
                {
                    <span class="price-current">
                        @Model.BasePrice.ToString("C", new System.Globalization.CultureInfo("pl-PL"))
                    </span>
                }
            </div>

            <!-- Color Selection -->
            @if (Model.Colors.Any())
            {
                <div class="selection-section">
                    <label class="selection-label">@L["Product_Color"]:</label>
                    <div class="color-options-inline">
                        @foreach (var color in Model.Colors)
                        {
                            <button type="button" 
                                    class="color-option-btn" 
                                    data-color-id="@color.Id"
                                    data-color-name="@color.DisplayName"
                                    style="background-color: @color.HexCode;"
                                    title="@color.DisplayName">
                                <span class="color-check">
                                    <i class="fas fa-check"></i>
                                </span>
                            </button>
                        }
                    </div>
                </div>
            }

            <!-- Size Selection -->
            @if (Model.Sizes.Any())
            {
                <div class="selection-section">
                    <label class="selection-label">@L["Product_Size"]:</label>
                    <div class="size-options-inline">
                        @foreach (var size in Model.Sizes)
                        {
                            <button type="button" 
                                    class="size-option-btn" 
                                    data-size-id="@size.Id"
                                    data-size-name="@size.Name">
                                @size.Name
                            </button>
                        }
                    </div>
                </div>
            }

            <!-- Add to Cart Button -->
            <div class="card-actions">
                @if (Model.HasStock)
                {
                    <button type="button" class="btn btn-primary w-100 add-to-cart-btn" data-product-id="@Model.Id" disabled>
                        <i class="fas fa-shopping-cart me-2"></i>@L.GetString(key: "AddToCart", resourceName: "Common")
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-secondary w-100" disabled>
                        @L.GetString("OutOfStock", "Product")
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<style>
    /* ===== Product Card Container ===== */
    .product-card {
        height: 100%;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-card:hover {
        transform: translateY(-4px);
    }

    .product-card-inner {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.3s ease;
        position: relative;
    }

    [data-theme="dark"] .product-card-inner {
        background-color: #1e293b;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .product-card:hover .product-card-inner {
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    [data-theme="dark"] .product-card:hover .product-card-inner {
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* ===== Image Wrapper with Overlays ===== */
    .product-image-wrapper {
        position: relative;
        background: #f8f9fa;
        overflow: hidden;
        aspect-ratio: 3/4;
        min-height: 350px;
    }

    .image-link {
        display: block;
        width: 100%;
        height: 100%;
    }

    .product-swiper-@Model.Id {
        width: 100%;
        height: 100%;
    }

    .product-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .product-card:hover .product-image {
        transform: scale(1.08);
    }

    /* ===== Top Overlay (Badges & Quick Actions) ===== */
    .top-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 10;
        pointer-events: none;
    }

    .top-overlay > * {
        pointer-events: auto;
    }

    .product-badges {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .product-badges .badge {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        backdrop-filter: blur(8px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .badge-new {
        background: rgba(16, 185, 129, 0.95);
        color: white;
    }

    .badge-sale {
        background: rgba(239, 68, 68, 0.95);
        color: white;
    }

    .quick-actions {
        display: flex;
        gap: 8px;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease;
    }

    .product-card:hover .quick-actions {
        opacity: 1;
        transform: translateY(0);
    }

    .quick-action-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        backdrop-filter: blur(8px);
    }

    .quick-action-btn:hover {
        background: white;
        transform: scale(1.1);
        color: #ef4444;
    }

    .quick-action-btn i {
        font-size: 16px;
    }

    /* ===== Compact Product Info ===== */
    .product-info {
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .product-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin: 0;
        line-height: 1.4;
        min-height: 2.6rem;
        max-height: 2.6rem;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .product-title a {
        color: #1f2937;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    [data-theme="dark"] .product-title a {
        color: #e2e8f0;
    }

    .product-title a:hover {
        color: #3b82f6;
    }

    /* ===== Price Section ===== */
    .product-price-section {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .price-with-discount {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .price-current {
        font-size: 1.25rem;
        color: #1f2937;
        font-weight: 700;
    }

    [data-theme="dark"] .price-current {
        color: #e2e8f0;
    }

    .price-original {
        font-size: 0.9rem;
        color: #9ca3af;
        text-decoration: line-through;
    }

    [data-theme="dark"] .price-original {
        color: #64748b;
    }

    .discount-badge {
        background: #ef4444;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 4px;
    }

    /* ===== Selection Sections ===== */
    .selection-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .selection-label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #4b5563;
        margin: 0;
    }

    [data-theme="dark"] .selection-label {
        color: #94a3b8;
    }

    /* Color Options Inline */
    .color-options-inline {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .color-option-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
        padding: 0;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .color-option-btn:hover {
        transform: scale(1.15);
        box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    .color-option-btn.active {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .color-check {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .color-option-btn.active .color-check {
        opacity: 1;
    }

    /* Size Options Inline */
    .size-options-inline {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .size-option-btn {
        min-width: 45px;
        padding: 8px 12px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        color: #4b5563;
        transition: all 0.2s ease;
        font-size: 0.85rem;
    }

    [data-theme="dark"] .size-option-btn {
        background: #0f172a;
        border-color: #334155;
        color: #94a3b8;
    }

    .size-option-btn:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-2px);
    }

    [data-theme="dark"] .size-option-btn:hover {
        background: #1e293b;
    }

    .size-option-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    /* ===== Card Actions ===== */
    .card-actions {
        margin-top: 4px;
    }

    .add-to-cart-btn {
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.85rem;
        padding: 12px;
        transition: all 0.2s ease;
    }

    .add-to-cart-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .add-to-cart-btn:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* ===== Swiper Customization ===== */
    .swiper-pagination {
        bottom: 60px !important;
    }

    .swiper-pagination-bullet {
        background: white;
        opacity: 0.6;
        width: 8px;
        height: 8px;
        margin: 0 4px !important;
    }

    .swiper-pagination-bullet-active {
        opacity: 1;
        width: 24px;
        border-radius: 4px;
    }

    /* ===== Responsive ===== */
    @@media (max-width: 768px) {
        .product-image-wrapper {
            aspect-ratio: 1/1;
            min-height: 280px;
        }

        .product-info {
            padding: 14px;
        }

        .product-title {
            font-size: 0.9rem;
        }

        .price-current {
            font-size: 1.1rem;
        }

        .color-option-btn {
            width: 28px;
            height: 28px;
        }

        .size-option-btn {
            min-width: 40px;
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .add-to-cart-btn {
            font-size: 0.8rem;
            padding: 10px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const productId = @Model.Id;
        const card = document.querySelector(`.product-card[data-product-id="${productId}"]`);
        
        if (!card) return;

        const wishlistBtn = card.querySelector('.wishlist-btn');
        const addToCartBtn = card.querySelector('.add-to-cart-btn');
        const colorOptions = card.querySelectorAll('.color-option-btn');
        const sizeOptions = card.querySelectorAll('.size-option-btn');

        // Initialize Swiper for this product
        const swiperEl = card.querySelector('.product-swiper-@Model.Id');
        if (swiperEl) {
            const swiper = new Swiper('.product-swiper-@Model.Id', {
                loop: @(Model.Images.Count > 1 ? "true" : "false"),
                pagination: {
                    el: '.product-swiper-@Model.Id .swiper-pagination',
                    clickable: true,
                },
                autoplay: @(Model.Images.Count > 1 ? "{delay: 4000, disableOnInteraction: false}" : "false"),
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                },
                speed: 800,
            });
        }

        // GSAP Animation on scroll
        if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
            gsap.from(card, {
                scrollTrigger: {
                    trigger: card,
                    start: 'top 85%',
                    toggleActions: 'play none none reverse'
                },
                y: 40,
                opacity: 0,
                duration: 0.5,
                ease: 'power2.out'
            });
        }

        // Wishlist button
        if (wishlistBtn) {
            wishlistBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const icon = this.querySelector('i');
                if (icon.classList.contains('far')) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    if (typeof gsap !== 'undefined') {
                        gsap.from(icon, {
                            scale: 0,
                            duration: 0.4,
                            ease: 'back.out(4)'
                        });
                    }
                    // TODO: Call wishlist API to add
                    addToWishlist(productId);
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    // TODO: Call wishlist API to remove
                    removeFromWishlist(productId);
                }
            });
        }

        // Color selection
        colorOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                colorOptions.forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                checkSelectionComplete();
            });
        });

        // Size selection
        sizeOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                sizeOptions.forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                checkSelectionComplete();
            });
        });

        // Check if selection is complete and enable/disable add to cart button
        function checkSelectionComplete() {
            const hasColorSelected = card.querySelector('.color-option-btn.active');
            const hasSizeSelected = card.querySelector('.size-option-btn.active');
            
            const needsColor = @(Model.Colors.Any() ? "true" : "false");
            const needsSize = @(Model.Sizes.Any() ? "true" : "false");
            
            const colorReady = !needsColor || hasColorSelected;
            const sizeReady = !needsSize || hasSizeSelected;
            
            if (addToCartBtn) {
                addToCartBtn.disabled = !(colorReady && sizeReady);
            }
        }

        // Add to cart functionality
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                
                const colorId = card.querySelector('.color-option-btn.active')?.dataset.colorId;
                const sizeId = card.querySelector('.size-option-btn.active')?.dataset.sizeId;
                
                const cartData = {
                    productId: productId,
                    colorId: colorId ? parseInt(colorId) : null,
                    sizeId: sizeId ? parseInt(sizeId) : null,
                    quantity: 1
                };

                try {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>@L["Common_Adding"]...';
                    this.disabled = true;

                    // Check if user is logged in
                    const isLoggedIn = @(User.Identity?.IsAuthenticated == true ? "true" : "false");
                    
                    if (isLoggedIn) {
                        // Save to server for authenticated users
                        const response = await fetch('/Cart/api/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cartData)
                        });

                        const result = await response.json();
                        
                        if (!response.ok || !result.success) {
                            throw new Error(result.message || 'Failed to add to cart');
                        }
                    } else {
                        // Save to localStorage for guest users
                        let guestCart = JSON.parse(localStorage.getItem('guestCart') || '[]');
                        
                        // Check if item already exists
                        const existingItemIndex = guestCart.findIndex(item => 
                            item.productId === cartData.productId && 
                            item.colorId === cartData.colorId && 
                            item.sizeId === cartData.sizeId
                        );
                        
                        if (existingItemIndex > -1) {
                            guestCart[existingItemIndex].quantity += 1;
                        } else {
                            guestCart.push(cartData);
                        }
                        
                        localStorage.setItem('guestCart', JSON.stringify(guestCart));
                    }

                    this.innerHTML = '<i class="fas fa-check me-2"></i>@L["Common_Added"]!';
                    this.classList.remove('btn-primary');
                    this.classList.add('btn-success');

                    // Update cart count and preview
                    if (window.cartManager) {
                        window.cartManager.updateCartCount();
                        window.cartManager.updateCartPreview();
                    }

                    // Reset button after 2 seconds
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-primary');
                        this.disabled = false;
                        
                        // Reset selections
                        colorOptions.forEach(o => o.classList.remove('active'));
                        sizeOptions.forEach(o => o.classList.remove('active'));
                        checkSelectionComplete();
                    }, 2000);
                } catch (error) {
                    console.error('Error adding to cart:', error);
                    alert('@L["Error_AddToCart"]');
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            });
        }

        // Initial check
        checkSelectionComplete();

        // Wishlist API functions (placeholder)
        async function addToWishlist(productId) {
            try {
                const response = await fetch('/api/wishlist/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId: productId })
                });
                
                if (!response.ok) {
                    console.error('Failed to add to wishlist');
                }
            } catch (error) {
                console.error('Error adding to wishlist:', error);
            }
        }

        async function removeFromWishlist(productId) {
            try {
                const response = await fetch('/api/wishlist/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId: productId })
                });
                
                if (!response.ok) {
                    console.error('Failed to remove from wishlist');
                }
            } catch (error) {
                console.error('Error removing from wishlist:', error);
            }
        }
    });
</script>

