@model Kokomija.Models.ViewModels.Admin.CategoryCreateDto
@inject Kokomija.Services.ILocalizationService L
@inject Microsoft.Extensions.Localization.IStringLocalizer<Kokomija.Resources.CommonResources.CommonResources> Category

@{
    ViewData["Title"] = Category["Admin_Category_CreateNew"];
    var categories = ViewBag.Categories as List<Kokomija.Entity.Category> ?? new List<Kokomija.Entity.Category>();
}

<div class="admin-dashboard">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1>
                                <i class="bi bi-folder-plus"></i>
                                @Category["Admin_Category_CreateNew"]
                            </h1>
                            <p class="mb-0">Create a new category with multilingual support</p>
                        </div>
                        <div>
                            <a asp-action="Settings" class="btn btn-light">
                                <i class="bi bi-arrow-left"></i>
                                @Category["Admin_Category_Cancel"]
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm border-0 rounded-3">
                    <div class="card-body">
                        <form asp-action="CategoryCreate" method="post" id="categoryForm">
                            <input type="hidden" asp-for="ImageTempFileName" id="imageTempFileName" />
                            <input type="hidden" asp-for="IconImageTempFileName" id="iconImageTempFileName" />
                            <input type="hidden" asp-for="ExistingIconImagePath" id="existingIconImagePath" />

                            @* Translations Section *@
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-translate"></i>
                                        @Category["Admin_Category_Translations"]
                                    </h5>
                                </div>

                                @for (int i = 0; i < Model.Translations.Count; i++)
                                {
                                    var cultureCode = Model.Translations[i].CultureCode;
                                    var languageName = cultureCode == "en-US" ? "English" : "Polski";
                                    var flagIcon = cultureCode == "en-US" ? "ðŸ‡ºðŸ‡¸" : "ðŸ‡µðŸ‡±";

                                    <div class="col-md-6 mb-3">
                                        <div class="translation-card p-3 border rounded">
                                            <h6 class="mb-3">@flagIcon @languageName</h6>
                                            <input type="hidden" asp-for="Translations[i].CultureCode" />

                                            <div class="mb-3">
                                                <label asp-for="Translations[i].Name" class="form-label">
                                                    @Category["Admin_Category_Name"] <span class="text-danger">*</span>
                                                </label>
                                                <input asp-for="Translations[i].Name" class="form-control" required />
                                            </div>

                                            <div class="mb-3">
                                                <label asp-for="Translations[i].Slug" class="form-label">
                                                    @Category["Admin_Category_Slug"] <span class="text-danger">*</span>
                                                </label>
                                                <input asp-for="Translations[i].Slug" class="form-control" required />
                                                <small class="text-muted">URL-friendly: lowercase, hyphens only</small>
                                            </div>

                                            <div class="mb-3">
                                                <label asp-for="Translations[i].Description" class="form-label">@Category["Admin_Category_Description"]</label>
                                                <textarea asp-for="Translations[i].Description" class="form-control" rows="3"></textarea>
                                            </div>

                                            <div class="mb-3">
                                                <label asp-for="Translations[i].MetaDescription" class="form-label">@Category["Admin_Category_MetaDescription"]</label>
                                                <textarea asp-for="Translations[i].MetaDescription" class="form-control" rows="2" maxlength="160"></textarea>
                                                <small class="text-muted">For SEO (160 chars max)</small>
                                            </div>

                                            <div class="mb-0">
                                                <label asp-for="Translations[i].MetaKeywords" class="form-label">@Category["Admin_Category_MetaKeywords"]</label>
                                                <input asp-for="Translations[i].MetaKeywords" class="form-control" />
                                                <small class="text-muted">Comma-separated keywords</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            @* Settings Section *@
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-gear"></i>
                                        Settings
                                    </h5>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label asp-for="ParentCategoryId" class="form-label">@Category["Admin_Category_ParentCategory"]</label>
                                    <select asp-for="ParentCategoryId" class="form-select" id="parentCategorySelect">
                                        <option value="">@Category["Admin_Category_NoParent"]</option>
                                        @foreach (var cat in categories)
                                        {
                                            <option value="@cat.Id">@cat.Name</option>
                                        }
                                    </select>
                                    <small class="text-muted">Leave empty for main category</small>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label asp-for="DisplayOrder" class="form-label">@Category["Admin_Category_DisplayOrder"]</label>
                                    <input asp-for="DisplayOrder" class="form-control" type="number" min="0" />
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label class="form-label d-block">Status</label>
                                    <div class="form-check form-switch d-inline-block me-3">
                                        <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                        <label asp-for="IsActive" class="form-check-label">@Category["Admin_Category_IsActive"]</label>
                                    </div>
                                    <div class="form-check form-switch d-inline-block">
                                        <input asp-for="ShowInNavbar" class="form-check-input" type="checkbox" />
                                        <label asp-for="ShowInNavbar" class="form-check-label">@Category["Admin_Category_ShowInNavbar"]</label>
                                    </div>
                                </div>
                            </div>

                            @* Image/Icon Section *@
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="border-bottom pb-2 mb-3">
                                        <i class="bi bi-image"></i>
                                        Visual Elements
                                    </h5>
                                </div>

                                <div class="col-md-6 mb-3" id="imageUploadSection">
                                    <label class="form-label fw-bold">@Category["Admin_Category_Image"]</label>
                                    <p class="text-muted small">@Category["Admin_Category_ImageInfo"]</p>
                                    
                                    <div class="image-upload-container" id="imageDropzone">
                                        <i class="bi bi-cloud-arrow-up fs-1 text-muted"></i>
                                        <p class="mt-2 text-muted">@Category["Admin_Category_DragDrop"]</p>
                                        <small class="text-muted">1200x800px recommended</small>
                                    </div>
                                    <div id="imagePreview" class="mt-3 d-none">
                                        <img src="" class="img-fluid rounded" alt="Preview" style="max-height: 300px;" />
                                        <button type="button" class="btn btn-sm btn-danger mt-2 remove-image">
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </div>
                                    <input type="file" id="imageInput" class="d-none" accept="image/*" />
                                </div>

                                <div class="col-md-6 mb-3" id="iconPickerSection" style="display: none;">
                                    <label class="form-label fw-bold">@Category["Admin_Category_Icon"]</label>
                                    <p class="text-muted small">@Category["Admin_Category_IconInfo"]</p>
                                    
                                    <!-- Icon Type Toggle -->
                                    <div class="btn-group w-100 mb-3" role="group">
                                        <input type="radio" class="btn-check" name="iconType" id="iconTypeFontAwesome" value="fontawesome" checked autocomplete="off">
                                        <label class="btn btn-outline-primary" for="iconTypeFontAwesome">
                                            <i class="bi bi-grid-3x3"></i> Font Awesome
                                        </label>
                                        <input type="radio" class="btn-check" name="iconType" id="iconTypeExisting" value="existing" autocomplete="off">
                                        <label class="btn btn-outline-primary" for="iconTypeExisting">
                                            <i class="bi bi-collection"></i> My Icons
                                        </label>
                                        <input type="radio" class="btn-check" name="iconType" id="iconTypeUpload" value="upload" autocomplete="off">
                                        <label class="btn btn-outline-primary" for="iconTypeUpload">
                                            <i class="bi bi-cloud-upload"></i> Upload New
                                        </label>
                                    </div>

                                    <!-- Font Awesome Icon Picker -->
                                    <div id="fontAwesomeIconSection">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i id="selectedIconPreview" class="fa-solid fa-question"></i></span>
                                            <input asp-for="IconCssClass" class="form-control" id="iconCssClassInput" placeholder="fa-solid fa-shirt" />
                                            <button type="button" class="btn btn-outline-secondary" id="openIconPicker">
                                                <i class="bi bi-grid-3x3"></i> Browse
                                            </button>
                                        </div>

                                        <div id="iconPickerModal" class="icon-picker-modal" style="display: none;">
                                            <div class="icon-picker-content">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="mb-0">Select Font Awesome Icon</h6>
                                                    <button type="button" class="btn-close" id="closeIconPicker"></button>
                                                </div>
                                                <input type="text" class="form-control mb-3" id="iconSearch" placeholder="@Category["Admin_Category_SearchIcon"]" />
                                                <div class="icon-grid" id="iconGrid"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Upload Icon Section -->
                                    <div id="uploadIconSection" style="display: none;">
                                        <div class="icon-image-upload-container" id="iconImageDropzone">
                                            <i class="bi bi-cloud-arrow-up fs-3 text-muted"></i>
                                            <p class="mt-2 mb-1 text-muted">Upload custom icon</p>
                                            <small class="text-muted">PNG, SVG, or ICO (64x64px recommended)</small>
                                        </div>
                                        <div id="iconImagePreview" class="mt-3 d-none">
                                            <img src="" class="img-fluid rounded" alt="Icon Preview" style="max-height: 100px;" />
                                            <button type="button" class="btn btn-sm btn-danger mt-2 remove-icon-image">
                                                <i class="bi bi-trash"></i> Remove
                                            </button>
                                        </div>
                                        <input type="file" id="iconImageInput" class="d-none" accept="image/*" />
                                    </div>

                                    <!-- Existing Icons Gallery Section -->
                                    <div id="existingIconsSection" style="display: none;">
                                        <div id="existingIconsLoading" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary"></div>
                                            <span class="ms-2 text-muted">Loading your icons...</span>
                                        </div>
                                        <div id="existingIconsGrid" class="existing-icons-grid"></div>
                                        <div id="existingIconsEmpty" class="text-center py-3 d-none">
                                            <i class="bi bi-collection" style="font-size: 2rem; color: #ccc;"></i>
                                            <p class="text-muted mt-2 mb-0">No custom icons uploaded yet.</p>
                                            <small class="text-muted">Upload your first icon using the "Upload New" tab.</small>
                                        </div>
                                        <div id="selectedExistingIcon" class="mt-3 d-none">
                                            <div class="d-flex align-items-center gap-2 p-2 border rounded bg-success-subtle">
                                                <img src="" class="rounded" style="max-height: 48px;" alt="Selected" />
                                                <div>
                                                    <strong class="text-success"><i class="bi bi-check-circle"></i> Selected</strong>
                                                    <small class="d-block text-muted" id="selectedIconUsedBy"></small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger ms-auto clear-existing-icon">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            @* Form Actions *@
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex gap-2 justify-content-end">
                                        <a asp-action="Settings" class="btn btn-secondary">
                                            <i class="bi bi-x-circle"></i> Cancel
                                        </a>
                                        <button type="submit" class="btn btn-primary" id="submitBtn">
                                            <i class="bi bi-check-circle"></i> @Category["Admin_Category_Save"]
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
.image-upload-container {
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}
.image-upload-container:hover { border-color: #0d6efd; background: #f8f9fa; }
.image-upload-container.drag-over { border-color: #0d6efd; background: #e7f1ff; }

.translation-card { background: #f8f9fa; }

.icon-picker-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1050;
    display: flex;
    align-items: center;
    justify-content: center;
}
.icon-picker-content {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}
.icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 0.5rem;
    max-height: 400px;
    overflow-y: auto;
}
.icon-item {
    padding: 1rem;
    text-align: center;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}
.icon-item:hover { background: #e7f1ff; border-color: #0d6efd; }
.icon-item i { font-size: 1.5rem; }

.icon-image-upload-container {
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}
.icon-image-upload-container:hover { border-color: #0d6efd; background: #f8f9fa; }
.icon-image-upload-container.drag-over { border-color: #0d6efd; background: #e7f1ff; }

.existing-icons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.5rem;
    max-height: 300px;
    overflow-y: auto;
    padding: 2px;
}
.existing-icon-item {
    padding: 0.75rem 0.5rem;
    text-align: center;
    border: 2px solid #dee2e6;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.existing-icon-item:hover {
    border-color: #0d6efd;
    background: #e7f1ff;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.existing-icon-item.selected {
    border-color: #198754;
    background: rgba(25, 135, 84, 0.1);
}
.existing-icon-item.selected::after {
    content: '\F26E';
    font-family: 'bootstrap-icons';
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 0.75rem;
    color: #198754;
    background: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.existing-icon-item img {
    max-height: 48px;
    max-width: 48px;
    object-fit: contain;
}
.existing-icon-item .icon-usage {
    font-size: 0.65rem;
    color: #6c757d;
    margin-top: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Dark Theme Support */
[data-bs-theme="dark"] .image-upload-container,
.dark-theme .image-upload-container {
    border-color: #495057;
    background-color: transparent;
}

[data-bs-theme="dark"] .image-upload-container:hover,
.dark-theme .image-upload-container:hover {
    border-color: #0d6efd;
    background: rgba(13, 110, 253, 0.1);
}

[data-bs-theme="dark"] .image-upload-container.drag-over,
.dark-theme .image-upload-container.drag-over {
    border-color: #0d6efd;
    background: rgba(13, 110, 253, 0.2);
}

[data-bs-theme="dark"] .translation-card,
.dark-theme .translation-card {
    background: rgba(255, 255, 255, 0.05);
    border-color: #495057 !important;
}

[data-bs-theme="dark"] .icon-picker-modal,
.dark-theme .icon-picker-modal {
    background: rgba(0, 0, 0, 0.7);
}

[data-bs-theme="dark"] .icon-picker-content,
.dark-theme .icon-picker-content {
    background: var(--bs-body-bg);
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .icon-item,
.dark-theme .icon-item {
    border-color: #495057;
    background: transparent;
}

[data-bs-theme="dark"] .icon-item:hover,
.dark-theme .icon-item:hover {
    background: rgba(13, 110, 253, 0.2);
    border-color: #0d6efd;
}

[data-bs-theme="dark"] .form-control,
[data-bs-theme="dark"] .form-select,
.dark-theme .form-control,
.dark-theme .form-select {
    background-color: rgba(255, 255, 255, 0.05);
    border-color: #495057;
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .form-control:focus,
[data-bs-theme="dark"] .form-select:focus,
.dark-theme .form-control:focus,
.dark-theme .form-select:focus {
    background-color: rgba(255, 255, 255, 0.08);
    border-color: #0d6efd;
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .card,
.dark-theme .card {
    background-color: var(--bs-body-bg);
    border-color: #495057;
}

[data-bs-theme="dark"] .btn-light,
.dark-theme .btn-light {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: #495057;
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .btn-light:hover,
.dark-theme .btn-light:hover {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: #6c757d;
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .input-group-text,
.dark-theme .input-group-text {
    background-color: rgba(255, 255, 255, 0.05);
    border-color: #495057;
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .btn-outline-secondary,
.dark-theme .btn-outline-secondary {
    color: var(--bs-body-color);
    border-color: #495057;
}

[data-bs-theme="dark"] .btn-outline-secondary:hover,
.dark-theme .btn-outline-secondary:hover {
    background-color: rgba(255, 255, 255, 0.1);
    border-color: #6c757d;
    color: var(--bs-body-color);
}

[data-bs-theme="dark"] .icon-image-upload-container,
.dark-theme .icon-image-upload-container {
    border-color: #495057;
    background-color: transparent;
}

[data-bs-theme="dark"] .icon-image-upload-container:hover,
.dark-theme .icon-image-upload-container:hover {
    border-color: #0d6efd;
    background: rgba(13, 110, 253, 0.1);
}

[data-bs-theme="dark"] .icon-image-upload-container.drag-over,
.dark-theme .icon-image-upload-container.drag-over {
    border-color: #0d6efd;
    background: rgba(13, 110, 253, 0.2);
}

[data-bs-theme="dark"] .existing-icon-item,
.dark-theme .existing-icon-item {
    border-color: #495057;
    background: transparent;
}

[data-bs-theme="dark"] .existing-icon-item:hover,
.dark-theme .existing-icon-item:hover {
    background: rgba(13, 110, 253, 0.15);
    border-color: #0d6efd;
}

[data-bs-theme="dark"] .existing-icon-item.selected,
.dark-theme .existing-icon-item.selected {
    border-color: #198754;
    background: rgba(25, 135, 84, 0.15);
}

[data-bs-theme="dark"] .existing-icon-item.selected::after,
.dark-theme .existing-icon-item.selected::after {
    background: #212529;
    color: #75b798;
}

[data-bs-theme="dark"] .bg-success-subtle,
.dark-theme .bg-success-subtle {
    background-color: rgba(25, 135, 84, 0.15) !important;
}

[data-bs-theme="dark"] .btn-check:checked + .btn-outline-primary,
.dark-theme .btn-check:checked + .btn-outline-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
}

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" />

<script>
$(document).ready(function () {
    toastr.options = { "closeButton": true, "progressBar": true, "positionClass": "toast-top-right", "timeOut": "3000" };

    let tempFileName = null;
    let iconTempFileName = null;
    const popularIcons = ['shirt', 'shoe-prints', 'ring', 'watch', 'bag-shopping', 'hat-cowboy', 'glasses', 'umbrella', 'socks', 'crown', 'gem', 'heart', 'star', 'fire', 'bolt', 'snowflake', 'sun', 'moon', 'cloud', 'leaf'];

    // Icon type toggle
    $('input[name="iconType"]').on('change', function() {
        const iconType = $(this).val();
        $('#fontAwesomeIconSection').hide();
        $('#uploadIconSection').hide();
        $('#existingIconsSection').hide();
        
        if (iconType === 'fontawesome') {
            $('#fontAwesomeIconSection').show();
            $('#iconCssClassInput').prop('disabled', false);
            // Clear existing icon selection
            $('#existingIconImagePath').val('');
        } else if (iconType === 'existing') {
            $('#existingIconsSection').show();
            $('#iconCssClassInput').prop('disabled', true).val('');
            loadExistingIcons();
        } else {
            $('#uploadIconSection').show();
            $('#iconCssClassInput').prop('disabled', true).val('');
            // Clear existing icon selection
            $('#existingIconImagePath').val('');
        }
    });

    // Parent category change
    $('#parentCategorySelect').on('change', function() {
        const isSubcategory = $(this).val() !== '';
        $('#imageUploadSection').toggle(!isSubcategory);
        $('#iconPickerSection').toggle(isSubcategory);
    });

    // Image upload
    const dropzone = $('#imageDropzone');
    const input = $('#imageInput');
    const preview = $('#imagePreview');

    dropzone.on('click', () => input.click());
    dropzone.on('dragover', (e) => { e.preventDefault(); dropzone.addClass('drag-over'); });
    dropzone.on('dragleave', () => dropzone.removeClass('drag-over'));
    dropzone.on('drop', (e) => {
        e.preventDefault();
        dropzone.removeClass('drag-over');
        if (e.originalEvent.dataTransfer.files.length > 0) uploadImage(e.originalEvent.dataTransfer.files[0]);
    });
    input.on('change', function() { if (this.files.length > 0) uploadImage(this.files[0]); });

    function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file);

        dropzone.html('<div class="spinner-border text-primary"></div><p class="mt-2">Uploading...</p>');

        $.ajax({
            url: '@Url.Action("CategoryUploadImage", "Admin")',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    tempFileName = response.tempFileName;
                    $('#imageTempFileName').val(response.tempFileName);
                    preview.find('img').attr('src', response.tempPath);
                    dropzone.addClass('d-none');
                    preview.removeClass('d-none');
                    toastr.success('Image uploaded successfully!');
                } else {
                    toastr.error(response.message || 'Upload failed');
                    resetDropzone();
                }
            },
            error: () => { toastr.error('Upload failed'); resetDropzone(); }
        });
    }

    $('.remove-image').on('click', function() {
        if (tempFileName) {
            $.ajax({
                url: '@Url.Action("CategoryCancelUpload", "Admin")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tempFileNames: [tempFileName] }),
                success: () => { tempFileName = null; $('#imageTempFileName').val(''); resetDropzone(); }
            });
        }
    });

    function resetDropzone() {
        dropzone.html('<i class="bi bi-cloud-arrow-up fs-1 text-muted"></i><p class="mt-2 text-muted">@Category["Admin_Category_DragDrop"]</p><small class="text-muted">1200x800px recommended</small>');
        dropzone.removeClass('d-none');
        preview.addClass('d-none');
    }

    // Icon picker
    $('#openIconPicker').on('click', () => {
        $('#iconPickerModal').fadeIn();
        loadIcons();
    });
    $('#closeIconPicker').on('click', () => $('#iconPickerModal').fadeOut());

    function loadIcons() {
        const grid = $('#iconGrid');
        grid.empty();
        popularIcons.forEach(icon => {
            const cssClass = `fa-solid fa-${icon}`;
            grid.append(`<div class="icon-item" data-icon="${cssClass}"><i class="${cssClass}"></i></div>`);
        });
    }

    $(document).on('click', '.icon-item', function() {
        const iconClass = $(this).data('icon');
        $('#iconCssClassInput').val(iconClass);
        $('#selectedIconPreview').attr('class', iconClass);
        $('#iconPickerModal').fadeOut();
    });

    $('#iconSearch').on('input', function() {
        const search = $(this).val().toLowerCase();
        $('.icon-item').each(function() {
            const iconClass = $(this).data('icon');
            $(this).toggle(iconClass.includes(search));
        });
    });

    // Icon image upload
    const iconDropzone = $('#iconImageDropzone');
    const iconInput = $('#iconImageInput');
    const iconPreview = $('#iconImagePreview');

    iconDropzone.on('click', () => iconInput.click());
    iconDropzone.on('dragover', (e) => { e.preventDefault(); iconDropzone.addClass('drag-over'); });
    iconDropzone.on('dragleave', () => iconDropzone.removeClass('drag-over'));
    iconDropzone.on('drop', (e) => {
        e.preventDefault();
        iconDropzone.removeClass('drag-over');
        if (e.originalEvent.dataTransfer.files.length > 0) uploadIconImage(e.originalEvent.dataTransfer.files[0]);
    });
    iconInput.on('change', function() { if (this.files.length > 0) uploadIconImage(this.files[0]); });

    function uploadIconImage(file) {
        const formData = new FormData();
        formData.append('file', file);

        iconDropzone.html('<div class="spinner-border spinner-border-sm text-primary"></div><p class="mt-2 small">Uploading...</p>');

        $.ajax({
            url: '@Url.Action("CategoryUploadImage", "Admin")',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    iconTempFileName = response.tempFileName;
                    $('#iconImageTempFileName').val(response.tempFileName);
                    iconPreview.find('img').attr('src', response.tempPath);
                    iconDropzone.addClass('d-none');
                    iconPreview.removeClass('d-none');
                    toastr.success('Icon uploaded successfully!');
                } else {
                    toastr.error(response.message || 'Upload failed');
                    resetIconDropzone();
                }
            },
            error: () => { toastr.error('Upload failed'); resetIconDropzone(); }
        });
    }

    $('.remove-icon-image').on('click', function() {
        if (iconTempFileName) {
            $.ajax({
                url: '@Url.Action("CategoryCancelUpload", "Admin")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ tempFileNames: [iconTempFileName] }),
                success: () => { iconTempFileName = null; $('#iconImageTempFileName').val(''); resetIconDropzone(); }
            });
        }
    });

    function resetIconDropzone() {
        iconDropzone.html('<i class="bi bi-cloud-arrow-up fs-3 text-muted"></i><p class="mt-2 mb-1 text-muted">Upload custom icon</p><small class="text-muted">PNG, SVG, or ICO (64x64px recommended)</small>');
        iconDropzone.removeClass('d-none');
        iconPreview.addClass('d-none');
    }

    // Existing icons gallery
    let existingIconsLoaded = false;
    function loadExistingIcons() {
        if (existingIconsLoaded) return;
        
        $('#existingIconsLoading').show();
        $('#existingIconsGrid').empty();
        $('#existingIconsEmpty').addClass('d-none');

        $.get('@Url.Action("GetExistingCategoryIcons", "Admin")', function(data) {
            $('#existingIconsLoading').hide();
            
            if (!data.success || !data.icons || data.icons.length === 0) {
                $('#existingIconsEmpty').removeClass('d-none');
                existingIconsLoaded = true;
                return;
            }

            data.icons.forEach(function(icon) {
                const usedByText = icon.usedBy.join(', ');
                const item = $(`
                    <div class="existing-icon-item" data-path="${icon.path}" data-used-by="${usedByText}" title="Used by: ${usedByText}">
                        <img src="${icon.path}" alt="Icon" />
                        <div class="icon-usage">${icon.usedBy[0]}${icon.count > 1 ? ' +' + (icon.count - 1) : ''}</div>
                    </div>
                `);
                $('#existingIconsGrid').append(item);
            });

            existingIconsLoaded = true;
        }).fail(function() {
            $('#existingIconsLoading').hide();
            toastr.error('Failed to load existing icons');
        });
    }

    // Click existing icon to select
    $(document).on('click', '.existing-icon-item', function() {
        const path = $(this).data('path');
        const usedBy = $(this).data('used-by');
        
        // Toggle selection
        $('.existing-icon-item').removeClass('selected');
        $(this).addClass('selected');
        
        // Set hidden field
        $('#existingIconImagePath').val(path);
        // Clear upload fields since we're reusing
        $('#iconImageTempFileName').val('');
        iconTempFileName = null;
        
        // Show selection confirmation
        $('#selectedExistingIcon').removeClass('d-none');
        $('#selectedExistingIcon img').attr('src', path);
        $('#selectedIconUsedBy').text('Used by: ' + usedBy);
    });

    // Clear existing icon selection
    $(document).on('click', '.clear-existing-icon', function() {
        $('.existing-icon-item').removeClass('selected');
        $('#existingIconImagePath').val('');
        $('#selectedExistingIcon').addClass('d-none');
    });

    // Form submit
    $('#categoryForm').on('submit', function(e) {
        $('#submitBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Saving...');
    });

    // Cleanup on page leave
    window.addEventListener('beforeunload', function() {
        const filesToClean = [];
        if (tempFileName) filesToClean.push(tempFileName);
        if (iconTempFileName) filesToClean.push(iconTempFileName);
        if (filesToClean.length > 0) {
            navigator.sendBeacon('@Url.Action("CategoryCancelUpload", "Admin")', JSON.stringify({ tempFileNames: filesToClean }));
        }
    });
});
</script>
}
