@model Kokomija.Models.ViewModels.Admin.ProductCreateDto
@{
    ViewData["Title"] = "Create New Product";
}

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- Welcome Card -->
        <div class="welcome-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-box-seam me-2"></i>Create New Product
                    </h2>
                    <p class="text-white-50 mb-0">Add a new product with complete details and translations</p>
                </div>
                <a asp-action="Products" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Products
                </a>
            </div>
        </div>

        <form asp-action="ProductCreate" method="post" id="productForm">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
            
            <div class="row">
                <!-- Left Column: Basic Info -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information
                            </h5>

                            <!-- Translation Tabs -->
                            <div class="translation-tabs">
                                <ul class="nav nav-tabs mb-3" id="translationTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="en-tab" data-bs-toggle="tab" data-bs-target="#en" type="button" role="tab">
                                            <i class="bi bi-flag-usa"></i> English
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="pl-tab" data-bs-toggle="tab" data-bs-target="#pl" type="button" role="tab">
                                            <i class="bi bi-flag"></i> Polski
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="translationTabContent">
                            <!-- English Translation -->
                            <div class="tab-pane fade show active" id="en" role="tabpanel">
                                <input type="hidden" name="Translations[0].CultureCode" value="en-US" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Product Name (English) *</label>
                                    <input name="Translations[0].Name" class="form-control" placeholder="Enter product name in English" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Description (English) *</label>
                                    <textarea name="Translations[0].Description" class="form-control" rows="5" placeholder="Detailed product description in English" required></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (URL-friendly)</label>
                                        <input name="Translations[0].Slug" class="form-control" placeholder="product-name-slug" />
                                        <small class="text-muted">Leave empty to auto-generate from name</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Description</label>
                                        <input name="Translations[0].MetaDescription" class="form-control" placeholder="SEO meta description" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Meta Keywords</label>
                                    <input name="Translations[0].MetaKeywords" class="form-control" placeholder="keyword1, keyword2, keyword3" />
                                </div>
                            </div>

                            <!-- Polish Translation -->
                            <div class="tab-pane fade" id="pl" role="tabpanel">
                                <input type="hidden" name="Translations[1].CultureCode" value="pl-PL" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Nazwa Produktu (Polski) *</label>
                                    <input name="Translations[1].Name" class="form-control" placeholder="Wprowadź nazwę produktu po polsku" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Opis (Polski) *</label>
                                    <textarea name="Translations[1].Description" class="form-control" rows="5" placeholder="Szczegółowy opis produktu po polsku" required></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (przyjazny URL)</label>
                                        <input name="Translations[1].Slug" class="form-control" placeholder="nazwa-produktu-slug" />
                                        <small class="text-muted">Pozostaw puste, aby automatycznie wygenerować z nazwy</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Opis</label>
                                        <input name="Translations[1].MetaDescription" class="form-control" placeholder="SEO meta opis" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Słowa Kluczowe Meta</label>
                                    <input name="Translations[1].MetaKeywords" class="form-control" placeholder="słowo1, słowo2, słowo3" />
                                </div>
                            </div>
                            </div>

                            <!-- Default Fallback Values (hidden, for backwards compatibility) -->
                            <input type="hidden" asp-for="Name" id="defaultName" />
                            <input type="hidden" asp-for="Description" id="defaultDescription" />
                        </div>
                    </div>

                    <!-- Pricing & Category -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-currency-dollar"></i> Pricing & Category
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="BasePrice" class="form-label">Base Price (zł) *</label>
                                    <input asp-for="BasePrice" type="number" step="0.01" class="form-control" placeholder="0.00" />
                                    <span asp-validation-for="BasePrice" class="text-danger"></span>
                                    <small class="text-muted">Stripe price will be created automatically</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="PackSize" class="form-label">Pack Size *</label>
                                    <input asp-for="PackSize" type="number" class="form-control" placeholder="1" />
                                    <span asp-validation-for="PackSize" class="text-danger"></span>
                                </div>
                                <div class="col-12 mb-3">
                                    <label asp-for="CategoryId" class="form-label">Category *</label>
                                    <select asp-for="CategoryId" asp-items="Model.Categories" class="form-select">
                                        <option value="">-- Select Category --</option>
                                    </select>
                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Images -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-images"></i> Product Images
                            </h5>
                            <div class="mb-3">
                                <label class="form-label">Upload Images (Max 5MB each, JPG/PNG/WEBP)</label>
                                <input type="file" id="imageUpload" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple />
                                <small class="text-muted">You can upload multiple images. First image will be the main product image.</small>
                            </div>
                            
                            <div id="imagePreview" class="row g-3 mt-2"></div>
                            
                            <!-- Hidden input to store temp file names -->
                            <input type="hidden" id="tempImageFileNames" name="TempImageFileNames" />
                        </div>
                    </div>

                    <!-- Variants Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-grid-3x3-gap"></i> Product Variants
                            </h5>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Create variants for different size/color combinations. Each variant can have its own price and stock level.
                            </div>

                            <div class="mb-3">
                                <button type="button" class="btn btn-success" id="addVariantBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add Variant
                                </button>
                            </div>

                            <div id="variantsContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Attributes & Status -->
                <div class="col-lg-4">
                    <!-- Sizes & Colors -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-palette"></i> Attributes
                            </h5>
                        <div class="mb-3">
                            <label class="form-label">Available Sizes</label>
                            <div class="size-checkboxes">
                                @foreach (var size in Model.AvailableSizes)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input size-checkbox" type="checkbox" name="SelectedSizeIds" value="@size.Value" id="size_@size.Value" />
                                        <label class="form-check-label" for="size_@size.Value">
                                            @size.Text
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Available Colors</label>
                            <div class="color-checkboxes">
                                @foreach (var color in Model.AvailableColors)
                                {
                                    <div class="form-check">
                                        <input class="form-check-input color-checkbox" type="checkbox" name="SelectedColorIds" value="@color.Value" id="color_@color.Value" />
                                        <label class="form-check-label" for="color_@color.Value">
                                            @color.Text
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-toggle-on"></i> Status
                            </h5>
                        <div class="form-check form-switch">
                            <input asp-for="IsActive" class="form-check-input" type="checkbox" id="isActiveSwitch" checked />
                            <label class="form-check-label" for="isActiveSwitch">
                                Active (visible to customers)
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 bg-body-tertiary p-3 rounded-3 mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-check-circle"></i> Create Product
            </button>
            <a asp-action="Products" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
        </div>
    </form>
</div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <style>
        .image-preview-item {
            position: relative;
        }
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .image-remove-btn:hover {
            background: rgb(220, 53, 69);
            transform: scale(1.1);
        }
        .variant-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .variant-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
    </style>

    <script>
        let tempImageFileNames = [];
        let variantIndex = 0;

        // Image Upload
        document.getElementById('imageUpload').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Max size is 5MB.`);
                    continue;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('@Url.Action("ProductUploadImage", "Admin")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        tempImageFileNames.push(result.tempFileName);
                        addImagePreview(result.tempUrl, result.tempFileName);
                        updateHiddenInput();
                    } else {
                        alert(`Error uploading ${file.name}: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Error uploading ${file.name}`);
                }
            }
            
            e.target.value = '';
        });

        function addImagePreview(url, fileName) {
            const previewHtml = `
                <div class="col-md-3 image-preview-item" data-filename="${fileName}">
                    <img src="${url}" alt="Product Image" />
                    <button type="button" class="image-remove-btn" onclick="removeImage('${fileName}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            document.getElementById('imagePreview').insertAdjacentHTML('beforeend', previewHtml);
        }

        async function removeImage(fileName) {
            if (!confirm('Remove this image?')) return;

            try {
                const response = await fetch('@Url.Action("ProductCancelUpload", "Admin")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ tempFileNames: [fileName] })
                });

                const result = await response.json();
                
                if (result.success) {
                    tempImageFileNames = tempImageFileNames.filter(f => f !== fileName);
                    document.querySelector(`.image-preview-item[data-filename="${fileName}"]`).remove();
                    updateHiddenInput();
                }
            } catch (error) {
                console.error('Error removing image:', error);
            }
        }

        function updateHiddenInput() {
            document.getElementById('tempImageFileNames').value = tempImageFileNames.join(',');
        }

        // Variant Management
        document.getElementById('addVariantBtn').addEventListener('click', function() {
            const sizes = @Html.Raw(Json.Serialize(Model.AvailableSizes));
            const colors = @Html.Raw(Json.Serialize(Model.AvailableColors));
            
            const variantHtml = `
                <div class="variant-card" data-variant-index="${variantIndex}">
                    <div class="variant-header">
                        <h6 class="mb-0">Variant #${variantIndex + 1}</h6>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeVariant(${variantIndex})">
                            <i class="bi bi-trash"></i> Remove
                        </button>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Size</label>
                            <select name="Variants[${variantIndex}].SizeId" class="form-select form-select-sm">
                                <option value="">-- Optional --</option>
                                ${sizes.map(s => `<option value="${s.value}">${s.text}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label">Color</label>
                            <select name="Variants[${variantIndex}].ColorId" class="form-select form-select-sm">
                                <option value="">-- Optional --</option>
                                ${colors.map(c => `<option value="${c.value}">${c.text}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">SKU *</label>
                            <input name="Variants[${variantIndex}].SKU" type="text" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Price (₺) *</label>
                            <input name="Variants[${variantIndex}].Price" type="number" step="0.01" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label">Stock *</label>
                            <input name="Variants[${variantIndex}].StockQuantity" type="number" class="form-control form-control-sm" required />
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('variantsContainer').insertAdjacentHTML('beforeend', variantHtml);
            variantIndex++;
        });

        function removeVariant(index) {
            document.querySelector(`.variant-card[data-variant-index="${index}"]`).remove();
        }

        // Form submit - cleanup on cancel
        window.addEventListener('beforeunload', async function(e) {
            if (tempImageFileNames.length > 0 && !document.getElementById('productForm').submitted) {
                await fetch('@Url.Action("ProductCancelUpload", "Admin")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({ tempFileNames: tempImageFileNames }),
                    keepalive: true
                });
            }
        });

        document.getElementById('productForm').addEventListener('submit', function() {
            this.submitted = true;
            
            // Sync default Name/Description from English translation for backwards compatibility
            const enName = document.querySelector('input[name="Translations[0].Name"]').value;
            const enDesc = document.querySelector('textarea[name="Translations[0].Description"]').value;
            document.getElementById('defaultName').value = enName;
            document.getElementById('defaultDescription').value = enDesc;
        });
    </script>
}
