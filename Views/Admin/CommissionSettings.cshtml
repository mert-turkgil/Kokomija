@model Kokomija.Models.ViewModels.CommissionSettingsViewModel
@{
    ViewData["Title"] = "Commission Settings";
}

<div class="admin-dashboard">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1>
                                <i class="bi bi-gear"></i>
                                Commission Settings & Developer Earnings
                            </h1>
                            <p class="mb-0 text-danger"><i class="bi bi-shield-lock"></i> ROOT ONLY - Platform Configuration</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i>
                                Back to Dashboard
                            </a>
                            <a asp-action="DeveloperEarnings" class="btn btn-info">
                                <i class="bi bi-cash-stack"></i>
                                View All Earnings
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Developer Earnings Summary -->
        @if (Model.EarningsSummary != null)
        {
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="mb-3"><i class="bi bi-graph-up"></i> Developer Commission Earnings</h5>
                </div>
                <div class="col-md-2">
                    <div class="stat-card-small bg-light">
                        <div class="stat-icon-small bg-primary">
                            <i class="bi bi-calendar-day"></i>
                        </div>
                        <div>
                            <h6>@Model.EarningsSummary.TodayEarnings.ToString("C")</h6>
                            <small>Today</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card-small bg-light">
                        <div class="stat-icon-small bg-success">
                            <i class="bi bi-calendar-week"></i>
                        </div>
                        <div>
                            <h6>@Model.EarningsSummary.WeekEarnings.ToString("C")</h6>
                            <small>This Week</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card-small bg-light">
                        <div class="stat-icon-small bg-info">
                            <i class="bi bi-calendar-month"></i>
                        </div>
                        <div>
                            <h6>@Model.EarningsSummary.MonthEarnings.ToString("C")</h6>
                            <small>This Month</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card-small bg-light">
                        <div class="stat-icon-small bg-warning">
                            <i class="bi bi-calendar-range"></i>
                        </div>
                        <div>
                            <h6>@Model.EarningsSummary.YearEarnings.ToString("C")</h6>
                            <small>This Year</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card-small bg-gradient-primary text-white">
                        <div class="stat-icon-small bg-white text-primary">
                            <i class="bi bi-infinity"></i>
                        </div>
                        <div>
                            <h6>@Model.EarningsSummary.AllTimeEarnings.ToString("C")</h6>
                            <small>All Time</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stat-card-small bg-gradient-success text-white">
                        <div class="stat-icon-small bg-white text-success">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div>
                            <h6>@Model.EarningsSummary.PendingPayout.ToString("C")</h6>
                            <small>Pending Payout</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="bi bi-cart-check"></i> Total Orders: <strong>@Model.EarningsSummary.TotalOrders</strong></h6>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="bi bi-calculator"></i> Avg Commission/Order: <strong>@Model.EarningsSummary.AverageCommissionPerOrder.ToString("C")</strong></h6>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Stripe Connect Account Card -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-stripe"></i> Stripe Connect Account (Developer Payouts)
                        </h5>
                        
                        @if (Model.ConnectAccount != null)
                        {
                            @if (Model.ConnectAccount.Status == "Error")
                            {
                                <div class="alert alert-danger">
                                    <i class="bi bi-exclamation-octagon"></i>
                                    <strong>Error:</strong> @Model.ConnectAccount.ErrorMessage
                                    <br><small>Account ID: @Model.ConnectAccount.AccountId</small>
                                </div>
                            }
                            else
                            {
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-dark border-@(Model.ConnectAccount.PayoutsEnabled ? "success" : "warning")">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <div class="rounded-circle bg-@(Model.ConnectAccount.PayoutsEnabled ? "success" : "warning") p-3 me-3">
                                                        <i class="bi bi-@(Model.ConnectAccount.PayoutsEnabled ? "check-circle" : "clock-history") fs-4 text-white"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="mb-0">@(Model.ConnectAccount.BusinessName ?? "Developer Account")</h5>
                                                        <small class="text-muted">@Model.ConnectAccount.Email</small>
                                                    </div>
                                                </div>
                                                
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <span class="badge bg-@(Model.ConnectAccount.PayoutsEnabled ? "success" : "secondary") fs-6">
                                                            <i class="bi bi-@(Model.ConnectAccount.PayoutsEnabled ? "check" : "x")"></i>
                                                            Payouts
                                                        </span>
                                                    </div>
                                                    <div class="col-4">
                                                        <span class="badge bg-@(Model.ConnectAccount.ChargesEnabled ? "success" : "secondary") fs-6">
                                                            <i class="bi bi-@(Model.ConnectAccount.ChargesEnabled ? "check" : "x")"></i>
                                                            Charges
                                                        </span>
                                                    </div>
                                                    <div class="col-4">
                                                        <span class="badge bg-@(Model.ConnectAccount.IsVerified ? "success" : "warning") fs-6">
                                                            <i class="bi bi-@(Model.ConnectAccount.IsVerified ? "patch-check" : "hourglass-split")"></i>
                                                            Verified
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm">
                                            <tbody>
                                                <tr>
                                                    <th><i class="bi bi-key"></i> Account ID</th>
                                                    <td><code>@Model.ConnectAccount.AccountId</code></td>
                                                </tr>
                                                <tr>
                                                    <th><i class="bi bi-globe"></i> Country</th>
                                                    <td>@(Model.ConnectAccount.Country?.ToUpper() ?? "N/A")</td>
                                                </tr>
                                                <tr>
                                                    <th><i class="bi bi-currency-exchange"></i> Currency</th>
                                                    <td>@(Model.ConnectAccount.Currency ?? "N/A")</td>
                                                </tr>
                                                <tr>
                                                    <th><i class="bi bi-building"></i> Account Type</th>
                                                    <td><span class="badge bg-info">@(Model.ConnectAccount.BusinessType ?? "Standard")</span></td>
                                                </tr>
                                                <tr>
                                                    <th><i class="bi bi-activity"></i> Status</th>
                                                    <td>
                                                        <span class="badge bg-@(Model.ConnectAccount.Status == "Active" ? "success" : Model.ConnectAccount.Status == "Pending Verification" ? "warning" : "secondary")">
                                                            @Model.ConnectAccount.Status
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                @if (!Model.ConnectAccount.PayoutsEnabled)
                                {
                                    <div class="alert alert-warning mt-3">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        <strong>Payouts Not Enabled:</strong> The developer needs to complete account verification in Stripe Dashboard before payouts can be processed.
                                    </div>
                                }
                                
                                <!-- Manual Payout Section -->
                                @if (Model.ConnectAccount.PayoutsEnabled && Model.EarningsSummary?.PendingPayout > 0)
                                {
                                    <div class="card bg-gradient-success text-white mt-3">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1"><i class="bi bi-wallet2"></i> Pending Payout</h6>
                                                    <h3 class="mb-0">@Model.EarningsSummary.PendingPayout.ToString("C")</h3>
                                                    <small>Ready to transfer to developer</small>
                                                </div>
                                                <button type="button" class="btn btn-light btn-lg" onclick="processPayout()">
                                                    <i class="bi bi-send"></i> Process Payout Now
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>No Connect Account Configured</strong>
                                <p class="mb-2">To enable automatic developer payouts, add a Stripe Connect account ID to your configuration:</p>
                                <code>"Stripe:ConnectedAccountId": "acct_XXXXXXXXXX"</code>
                                <hr>
                                <small>
                                    <strong>How to get a Connect Account:</strong>
                                    <ol class="mb-0 mt-2">
                                        <li>Go to <a href="https://dashboard.stripe.com/connect/accounts" target="_blank">Stripe Dashboard → Connect → Accounts</a></li>
                                        <li>Create a new Standard or Express account for the developer</li>
                                        <li>Copy the account ID (starts with <code>acct_</code>)</li>
                                        <li>Add it to <code>appsettings.json</code> or <code>appsettings.Development.json</code></li>
                                    </ol>
                                </small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Commission Settings Card -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-percent"></i> Commission Configuration
                        </h5>
                        @if (Model.Settings != null)
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Warning:</strong> Changing commission rates affects future earnings calculations.
                                Existing earnings records remain unchanged.
                            </div>

                            <form id="commissionSettingsForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="developerCommissionRate" class="form-label">
                                            Developer Commission Rate (%)
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Your cut from each order"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="developerCommissionRate" step="0.01" min="0" max="100" value="@Model.Settings.DeveloperCommissionRate" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="platformCommissionRate" class="form-label">
                                            Platform Commission Rate (%)
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Admin's marketplace commission"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="platformCommissionRate" step="0.01" min="0" max="100" value="@Model.Settings.PlatformCommissionRate" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="stripeCommissionRate" class="form-label">
                                            Stripe Commission Rate (%)
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Stripe's percentage fee (reference only)"></i>
                                        </label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="stripeCommissionRate" step="0.01" min="0" max="100" value="@Model.Settings.StripeCommissionRate" required>
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="stripeFixedFee" class="form-label">
                                            Stripe Fixed Fee
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Stripe's fixed fee per transaction"></i>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="stripeFixedFee" step="0.01" min="0" value="@Model.Settings.StripeFixedFee" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="minimumPayoutAmount" class="form-label">
                                            Minimum Payout Amount
                                            <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Minimum balance required for automatic payout"></i>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="minimumPayoutAmount" step="1" min="0" value="@Model.Settings.MinimumPayoutAmount" required>
                                        </div>
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label for="payoutFrequency" class="form-label">
                                            Payout Frequency
                                        </label>
                                        <select class="form-select" id="payoutFrequency">
                                            <option value="Daily" selected="@(Model.Settings.PayoutFrequency == "Daily")">Daily</option>
                                            <option value="Weekly" selected="@(Model.Settings.PayoutFrequency == "Weekly")">Weekly</option>
                                            <option value="BiWeekly" selected="@(Model.Settings.PayoutFrequency == "BiWeekly")">Bi-Weekly</option>
                                            <option value="Monthly" selected="@(Model.Settings.PayoutFrequency == "Monthly")">Monthly</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="autoPayoutEnabled" @(Model.Settings.AutoPayoutEnabled ? "checked" : "")>
                                    <label class="form-check-label" for="autoPayoutEnabled">
                                        Enable Automatic Payouts
                                    </label>
                                </div>

                                @if (Model.EarningsSummary?.NextPayoutDate != null && Model.Settings.AutoPayoutEnabled)
                                {
                                    <div class="alert alert-info">
                                        <i class="bi bi-calendar-event"></i>
                                        <strong>Next Payout:</strong> @Model.EarningsSummary.NextPayoutDate.Value.ToString("MMMM dd, yyyy")
                                    </div>
                                }

                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            Last modified: @Model.Settings.LastModifiedAt.ToString("yyyy-MM-dd HH:mm") 
                                            @if (!string.IsNullOrEmpty(Model.Settings.LastModifiedBy))
                                            {
                                                <span>by @Model.Settings.LastModifiedBy</span>
                                            }
                                        </small>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="saveCommissionSettings()">
                                        <i class="bi bi-save"></i> Save Commission Settings
                                    </button>
                                </div>
                            </form>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-circle"></i>
                                Commission settings not configured. Please set up initial configuration.
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Site Emergency Controls -->
            <div class="col-md-4">
                <div class="card border-danger">
                    <div class="card-body">
                        <h5 class="border-bottom border-danger pb-2 mb-3 text-danger">
                            <i class="bi bi-shield-exclamation"></i> Site Emergency Controls
                        </h5>
                        @if (Model.ActiveSiteClosure != null && Model.ActiveSiteClosure.IsActive)
                        {
                            <div class="alert alert-danger">
                                <h6><i class="bi bi-exclamation-triangle"></i> SITE IS CURRENTLY BLOCKED</h6>
                                <p class="mb-2"><strong>Reason:</strong> @Model.ActiveSiteClosure.Reason</p>
                                @if (Model.ActiveSiteClosure.StartDate.HasValue)
                                {
                                    <p class="mb-2"><strong>Since:</strong> @Model.ActiveSiteClosure.StartDate.Value.ToString("yyyy-MM-dd HH:mm")</p>
                                }
                                @if (Model.ActiveSiteClosure.EndDate.HasValue)
                                {
                                    <p class="mb-0"><strong>Scheduled Reopen:</strong> @Model.ActiveSiteClosure.EndDate.Value.ToString("yyyy-MM-dd HH:mm")</p>
                                }
                            </div>
                            <button type="button" class="btn btn-success w-100" onclick="unblockSite(@Model.ActiveSiteClosure.Id)">
                                <i class="bi bi-unlock"></i> Unblock Site
                            </button>
                        }
                        else
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle"></i> Site is currently active
                            </div>
                            <button type="button" class="btn btn-danger w-100" onclick="showBlockSiteModal()">
                                <i class="bi bi-lock"></i> Emergency Block Site
                            </button>
                        }

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Emergency block prevents all non-ROOT users from accessing the site.
                                Use only for critical maintenance or security issues.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Earnings -->
        @if (Model.RecentEarnings.Any())
        {
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-clock-history"></i> Recent Developer Earnings
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order</th>
                                            <th>Gross Amount</th>
                                            <th>Stripe Fee</th>
                                            <th>Dev Commission</th>
                                            <th>Net Amount</th>
                                            <th>Date</th>
                                            <th>Payout Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var earning in Model.RecentEarnings)
                                        {
                                            <tr>
                                                <td><code>@earning.OrderNumber</code></td>
                                                <td><strong>@earning.GrossAmount.ToString("C")</strong></td>
                                                <td class="text-danger">-@earning.StripeProcessingFee.ToString("C")</td>
                                                <td class="text-success">+@earning.DeveloperCommission.ToString("C")</td>
                                                <td>@earning.NetAmount.ToString("C")</td>
                                                <td><small>@earning.EarnedAt.ToString("yyyy-MM-dd HH:mm")</small></td>
                                                <td>
                                                    @if (earning.PayoutStatus == "Pending")
                                                    {
                                                        <span class="badge bg-warning">Pending</span>
                                                    }
                                                    else if (earning.PayoutStatus == "Processed")
                                                    {
                                                        <span class="badge bg-success">Processed</span>
                                                    }
                                                    else if (earning.PayoutStatus == "Failed")
                                                    {
                                                        <span class="badge bg-danger">Failed</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Block Site Modal -->
<div class="modal fade" id="blockSiteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Emergency Site Block</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This will block all non-ROOT users from accessing the site immediately.
                </div>
                <form id="blockSiteForm">
                    <div class="mb-3">
                        <label for="blockReason" class="form-label">Reason <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="blockReason" rows="3" placeholder="e.g., Emergency security patch, Database maintenance" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="scheduledReopen" class="form-label">Scheduled Reopen Date (Optional)</label>
                        <input type="datetime-local" class="form-control" id="scheduledReopen">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmBlockSite()">
                    <i class="bi bi-lock"></i> Block Site Now
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        async function saveCommissionSettings() {
            const data = {
                developerCommissionRate: parseFloat(document.getElementById('developerCommissionRate').value),
                platformCommissionRate: parseFloat(document.getElementById('platformCommissionRate').value),
                stripeCommissionRate: parseFloat(document.getElementById('stripeCommissionRate').value),
                stripeFixedFee: parseFloat(document.getElementById('stripeFixedFee').value),
                minimumPayoutAmount: parseFloat(document.getElementById('minimumPayoutAmount').value),
                payoutFrequency: document.getElementById('payoutFrequency').value,
                autoPayoutEnabled: document.getElementById('autoPayoutEnabled').checked
            };

            try {
                const response = await fetch('/Admin/UpdateCommissionSettings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Commission settings updated successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while saving commission settings.');
            }
        }

        function showBlockSiteModal() {
            new bootstrap.Modal(document.getElementById('blockSiteModal')).show();
        }

        async function confirmBlockSite() {
            const reason = document.getElementById('blockReason').value;
            const scheduledReopen = document.getElementById('scheduledReopen').value;

            if (!reason) {
                alert('Please provide a reason for blocking the site.');
                return;
            }

            if (!confirm('Are you absolutely sure you want to block the site? This will prevent all non-ROOT users from accessing it.')) {
                return;
            }

            const data = {
                reason: reason,
                message: reason,
                endDate: scheduledReopen ? new Date(scheduledReopen).toISOString() : null
            };

            try {
                const response = await fetch('/Admin/BlockSite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('blockSiteModal')).hide();
                    alert('Site blocked successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while blocking the site.');
            }
        }

        async function unblockSite(id) {
            if (!confirm('Are you sure you want to unblock the site?')) {
                return;
            }

            try {
                const response = await fetch(`/Admin/UnblockSite?id=${id}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Site unblocked successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while unblocking the site.');
            }
        }

        async function processPayout() {
            if (!confirm('Are you sure you want to process the payout now? This will transfer all pending developer commissions to the connected Stripe account.')) {
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';

            try {
                const response = await fetch('/Admin/ProcessDeveloperPayout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Payout processed successfully!\n\nTransfer ID: ' + (result.payoutId || 'N/A') + '\nAmount: ' + (result.amount || 'N/A'));
                    location.reload();
                } else {
                    alert('Payout failed: ' + result.message);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while processing the payout.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
}
