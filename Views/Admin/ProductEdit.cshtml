@model Kokomija.Models.ViewModels.Admin.ProductUpdateDto
@using Kokomija.Models.ViewModels.Admin
@{
    ViewData["Title"] = "Edit Product";
}

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- Welcome Card -->
        <div class="welcome-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-pencil-square me-2"></i>Edit Product
                    </h2>
                    <p class="text-white-50 mb-0">Update product information, pricing, and inventory</p>
                </div>
                <a asp-action="Products" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Products
                </a>
            </div>
        </div>

        <form asp-action="ProductEdit" method="post" id="productForm">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="StripeProductId" />
            <input type="hidden" asp-for="StripePriceId" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
            
            <div class="row">
                <!-- Left Column: Basic Info & Images -->
                <div class="col-lg-8">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information & Translations
                            </h5>

                            <!-- Translation Tabs -->
                            <div class="translation-tabs">
                                <ul class="nav nav-tabs mb-3" id="translationTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="en-tab" data-bs-toggle="tab" data-bs-target="#en" type="button" role="tab">
                                            <i class="bi bi-flag-usa"></i> English
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="pl-tab" data-bs-toggle="tab" data-bs-target="#pl" type="button" role="tab">
                                            <i class="bi bi-flag"></i> Polski
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="translationTabContent">
                            <!-- English Translation -->
                            <div class="tab-pane fade show active" id="en" role="tabpanel">
                                @{
                                    var enTranslation = Model.Translations.FirstOrDefault(t => t.CultureCode == "en-US");
                                    var enIndex = Model.Translations.IndexOf(enTranslation ?? new ProductTranslationDto { CultureCode = "en-US" });
                                    if (enIndex == -1) enIndex = 0;
                                }
                                <input type="hidden" name="Translations[@enIndex].Id" value="@(enTranslation?.Id)" />
                                <input type="hidden" name="Translations[@enIndex].CultureCode" value="en-US" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Product Name (English) *</label>
                                    <input name="Translations[@enIndex].Name" class="form-control" value="@(enTranslation?.Name ?? Model.Name)" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Description (English) *</label>
                                    <textarea name="Translations[@enIndex].Description" class="form-control" rows="5" required>@(enTranslation?.Description ?? Model.Description)</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (URL-friendly)</label>
                                        <input name="Translations[@enIndex].Slug" class="form-control" value="@(enTranslation?.Slug)" placeholder="product-name-slug" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Description</label>
                                        <input name="Translations[@enIndex].MetaDescription" class="form-control" value="@(enTranslation?.MetaDescription)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Meta Keywords</label>
                                    <input name="Translations[@enIndex].MetaKeywords" class="form-control" value="@(enTranslation?.MetaKeywords)" />
                                </div>
                            </div>

                            <!-- Polish Translation -->
                            <div class="tab-pane fade" id="pl" role="tabpanel">
                                @{
                                    var plTranslation = Model.Translations.FirstOrDefault(t => t.CultureCode == "pl-PL");
                                    var plIndex = Model.Translations.IndexOf(plTranslation ?? new ProductTranslationDto { CultureCode = "pl-PL" });
                                    if (plIndex == -1) plIndex = 1;
                                }
                                <input type="hidden" name="Translations[@plIndex].Id" value="@(plTranslation?.Id)" />
                                <input type="hidden" name="Translations[@plIndex].CultureCode" value="pl-PL" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Nazwa Produktu (Polski) *</label>
                                    <input name="Translations[@plIndex].Name" class="form-control" value="@(plTranslation?.Name ?? Model.Name)" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Opis (Polski) *</label>
                                    <textarea name="Translations[@plIndex].Description" class="form-control" rows="5" required>@(plTranslation?.Description ?? Model.Description)</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (przyjazny URL)</label>
                                        <input name="Translations[@plIndex].Slug" class="form-control" value="@(plTranslation?.Slug)" placeholder="nazwa-produktu-slug" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Opis</label>
                                        <input name="Translations[@plIndex].MetaDescription" class="form-control" value="@(plTranslation?.MetaDescription)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Słowa Kluczowe Meta</label>
                                    <input name="Translations[@plIndex].MetaKeywords" class="form-control" value="@(plTranslation?.MetaKeywords)" />
                                </div>
                            </div>
                            </div>

                            <!-- Default Fallback Values (hidden) -->
                            <input type="hidden" asp-for="Name" id="defaultName" />
                            <input type="hidden" asp-for="Description" id="defaultDescription" />
                        </div>
                    </div>

                    <!-- Pricing & Category -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-currency-dollar"></i> Pricing & Category
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label asp-for="Price" class="form-label">Price (zł) *</label>
                                    <input asp-for="Price" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="Price" class="text-danger"></span>
                                    <small class="text-muted">Changing price will create new Stripe price</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="PackSize" class="form-label">Pack Size *</label>
                                    <input asp-for="PackSize" type="number" class="form-control" />
                                    <span asp-validation-for="PackSize" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="CategoryId" class="form-label">Category *</label>
                                    <select asp-for="CategoryId" asp-items="ViewBag.Categories" class="form-select">
                                        <option value="">-- Select Category --</option>
                                    </select>
                                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price History -->
                    @if (Model.PriceHistory != null && Model.PriceHistory.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-clock-history"></i> Price History
                                </h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Old Price</th>
                                            <th>New Price</th>
                                            <th>Change</th>
                                            <th>Reason</th>
                                            <th>Changed By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var history in Model.PriceHistory.OrderByDescending(h => h.ChangedAt))
                                        {
                                            var priceChange = history.NewPrice - history.OldPrice;
                                            var changePercent = history.OldPrice > 0 ? (priceChange / history.OldPrice * 100) : 0;
                                            <tr>
                                                <td><small>@history.ChangedAt.ToString("yyyy-MM-dd HH:mm")</small></td>
                                                <td>@history.OldPrice.ToString("C2")</td>
                                                <td>@history.NewPrice.ToString("C2")</td>
                                                <td>
                                                    @if (priceChange > 0)
                                                    {
                                                        <span class="badge bg-success">+@priceChange.ToString("C2") (+@changePercent.ToString("F1")%)</span>
                                                    }
                                                    else if (priceChange < 0)
                                                    {
                                                        <span class="badge bg-danger">@priceChange.ToString("C2") (@changePercent.ToString("F1")%)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">No change</span>
                                                    }
                                                </td>
                                                <td><small>@(history.Reason ?? "Manual Update")</small></td>
                                                <td><small>@(history.ChangedBy ?? "System")</small></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                    <!-- Product Images -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-images"></i> Product Images
                            </h5>
                            <!-- Existing Images -->
                            @if (Model.ExistingImageUrls.Any())
                            {
                                <div class="mb-3">
                                    <label class="form-label">Current Images</label>
                                    <div class="row g-3" id="existingImages">
                                        @foreach (var imageUrl in Model.ExistingImageUrls)
                                        {
                                            <div class="col-md-3 image-preview-item" data-url="@imageUrl">
                                                <img src="@imageUrl" alt="Product Image" />
                                                <button type="button" class="image-remove-btn" onclick="markForDeletion('@imageUrl')">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <div class="mb-3">
                                <label class="form-label">Upload New Images (Max 5MB each)</label>
                                <input type="file" id="imageUpload" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple />
                            </div>
                            
                            <div id="newImagePreview" class="row g-3 mt-2"></div>
                            
                            <!-- Hidden inputs -->
                            <input type="hidden" id="newImageFileNames" name="NewImageTempFileNames" />
                            <input type="hidden" id="imagesToDelete" name="ImagesToDelete" />
                        </div>
                    </div>

                    <!-- Review Management -->
                    @if (Model.Reviews.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-star"></i> Customer Reviews (@Model.Reviews.Count)
                                </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>User</th>
                                            <th>Rating</th>
                                            <th>Comment</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var review in Model.Reviews)
                                        {
                                            <tr id="review-@review.Id">
                                                <td>
                                                    <div>
                                                        <strong>@review.UserName</strong>
                                                        @if (review.UserIsBanned)
                                                        {
                                                            <span class="badge bg-danger ms-1">Banned</span>
                                                        }
                                                        @if (review.IsVerifiedPurchase)
                                                        {
                                                            <span class="badge bg-success ms-1">Verified</span>
                                                        }
                                                    </div>
                                                    <small class="text-muted">@review.UserEmail</small>
                                                </td>
                                                <td>
                                                    <div class="rating-stars">
                                                        @for (int i = 0; i < (int)review.Rating; i++)
                                                        {
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        }
                                                        @if (review.Rating % 1 != 0)
                                                        {
                                                            <i class="bi bi-star-half text-warning"></i>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="review-comment">@review.Comment</div>
                                                </td>
                                                <td>
                                                    @if (review.IsVisible)
                                                    {
                                                        <span class="badge bg-success">Visible</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Hidden</span>
                                                    }
                                                </td>
                                                <td>
                                                    <small>@review.CreatedAt.ToString("MMM dd, yyyy")</small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-primary" onclick="toggleReviewVisibility(@review.Id)" title="Toggle Visibility">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <a asp-action="UserManagement" asp-route-userId="@review.UserId" class="btn btn-outline-warning" title="Manage User">
                                                            <i class="bi bi-person"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-outline-danger" onclick="deleteReview(@review.Id)" title="Delete Review">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        </div>
                                    </div>
                                </div>
                    }
                </div>

                <!-- Right Column: Status & Actions -->
                <div class="col-lg-4">
                    <!-- Status -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-toggle-on"></i> Status
                            </h5>
                            <div class="form-check form-switch mb-3">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                <label class="form-check-label" asp-for="IsActive">
                                    Active (visible to customers)
                                </label>
                            </div>
                            
                            <div class="alert alert-info">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>Stripe Product ID:</strong><br/>
                                    <code>@Model.StripeProductId</code>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Product Info
                            </h6>
                            <small class="text-muted">
                                <div class="mb-2">
                                    <i class="bi bi-grid-3x3-gap me-1"></i>
                                    <strong>Variants:</strong> @Model.Variants.Count
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-star me-1"></i>
                                    <strong>Reviews:</strong> @Model.Reviews.Count
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-images me-1"></i>
                                    <strong>Images:</strong> @Model.ExistingImageUrls.Count
                                </div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 bg-body-tertiary p-3 rounded-3 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> Update Product
                </button>
                <a asp-action="Products" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <style>
        .image-preview-item {
            position: relative;
        }
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .review-comment {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>

    <script>
        let newImageFileNames = [];
        let imagesToDelete = [];

        // Mark existing image for deletion
        function markForDeletion(imageUrl) {
            if (!confirm('Remove this image?')) return;
            
            imagesToDelete.push(imageUrl);
            document.querySelector(`.image-preview-item[data-url="${imageUrl}"]`).remove();
            updateHiddenInputs();
        }

        // Upload new images
        document.getElementById('imageUpload').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Max size is 5MB.`);
                    continue;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('@Url.Action("ProductUploadImage", "Admin")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        newImageFileNames.push(result.tempFileName);
                        addNewImagePreview(result.tempUrl, result.tempFileName);
                        updateHiddenInputs();
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            
            e.target.value = '';
        });

        function addNewImagePreview(url, fileName) {
            const html = `
                <div class="col-md-3 image-preview-item" data-filename="${fileName}">
                    <img src="${url}" alt="New Image" />
                    <button type="button" class="image-remove-btn" onclick="removeNewImage('${fileName}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            document.getElementById('newImagePreview').insertAdjacentHTML('beforeend', html);
        }

        async function removeNewImage(fileName) {
            if (!confirm('Remove this image?')) return;

            try {
                await fetch('@Url.Action("ProductCancelUpload", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tempFileNames: [fileName] })
                });

                newImageFileNames = newImageFileNames.filter(f => f !== fileName);
                document.querySelector(`#newImagePreview .image-preview-item[data-filename="${fileName}"]`).remove();
                updateHiddenInputs();
            } catch (error) {
                console.error('Error removing image:', error);
            }
        }

        function updateHiddenInputs() {
            document.getElementById('newImageFileNames').value = newImageFileNames.join(',');
            document.getElementById('imagesToDelete').value = imagesToDelete.join(',');
        }

        // Review management functions
        async function toggleReviewVisibility(reviewId) {
            try {
                const response = await fetch('@Url.Action("ReviewToggleVisibility", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: reviewId })
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error toggling visibility:', error);
            }
        }

        async function deleteReview(reviewId) {
            if (!confirm('Delete this review permanently?')) return;

            try {
                const response = await fetch('@Url.Action("ReviewDelete", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: reviewId })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById(`review-${reviewId}`).remove();
                }
            } catch (error) {
                console.error('Error deleting review:', error);
            }
        }

        // Sync default Name/Description from English translation for backwards compatibility
        document.getElementById('productForm').addEventListener('submit', function() {
            const enName = document.querySelector('input[name="Translations[0].Name"]');
            const enDesc = document.querySelector('textarea[name="Translations[0].Description"]');
            if (enName && enDesc) {
                document.getElementById('defaultName').value = enName.value;
                document.getElementById('defaultDescription').value = enDesc.value;
            }
        });
    </script>
}
