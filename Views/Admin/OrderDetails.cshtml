@model Kokomija.Models.ViewModels.Admin.OrderDetailsViewModel
@{
    ViewData["Title"] = $"Order {Model.OrderNumber}";
}

<div class="admin-dashboard">
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="welcome-card">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-receipt"></i>
                    Order #@Model.OrderNumber
                    @if (Model.IsDemoOrder)
                    {
                        <span class="badge bg-warning text-dark ms-2" style="font-size: 0.5em; vertical-align: middle;">
                            <i class="bi bi-cone-striped"></i> DEMO
                        </span>
                    }
                </h1>
                <p class="mb-3 opacity-75">Created on @Model.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</p>
                <div class="d-flex gap-2 flex-wrap">
                    <span class="status-badge status-@Model.OrderStatus.ToLower()">
                        <i class="bi bi-box"></i>
                        @Model.OrderStatus.ToUpper()
                    </span>
                    <span class="status-badge status-@Model.PaymentStatus.ToLower()">
                        <i class="bi bi-credit-card"></i>
                        Payment: @Model.PaymentStatus.ToUpper()
                    </span>
                    @if (Model.IsDemoOrder)
                    {
                        <span class="badge bg-info">
                            <i class="bi bi-info-circle"></i> Demo data - Stripe operations simulated
                        </span>
                    }
                </div>
            </div>
            <div>
                <a asp-action="Orders" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Orders
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Order Items -->
            <div class="card border-0 shadow-sm rounded-3 mb-4">
                <h4 class="mb-4">
                    <i class="bi bi-box-seam"></i>
                    Order Items (@Model.OrderItems.Count items)
                </h4>
                
                @foreach (var item in Model.OrderItems)
                {
                    <div class="product-item">
                        @if (item.ProductImageUrl != null)
                        {
                            <img src="@item.ProductImageUrl" alt="@item.ProductName" class="product-image">
                        }
                        else
                        {
                            <div class="product-image bg-light d-flex align-items-center justify-content-center">
                                <i class="bi bi-image text-muted"></i>
                            </div>
                        }
                        <div class="flex-grow-1">
                            <h6 class="mb-1">@item.ProductName</h6>
                            <div class="text-muted small">
                                @if (!string.IsNullOrEmpty(item.Color))
                                {
                                    <span class="ms-2">Color: @item.Color</span>
                                }
                                @if (!string.IsNullOrEmpty(item.Size))
                                {
                                    <span class="ms-2">Size: @item.Size</span>
                                }
                            </div>
                            <div class="mt-1">
                                <strong>@item.UnitPrice.ToString("N2") @Model.Currency</strong>
                                <span class="text-muted ms-2">Ã— @item.Quantity</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <strong class="h5 mb-0">@item.TotalPrice.ToString("N2") @Model.Currency</strong>
                        </div>
                    </div>
                }
                
                <!-- Order Totals -->
                <div class="border-top pt-3 mt-3">
                    <div class="info-row">
                        <span class="info-label">Subtotal</span>
                        <span class="info-value">@Model.SubtotalAmount.ToString("N2") @Model.Currency</span>
                    </div>
                    @if (Model.DiscountAmount > 0)
                    {
                        <div class="info-row">
                            <span class="info-label">
                                Discount
                                @if (!string.IsNullOrEmpty(Model.CouponCode))
                                {
                                    <span class="text-muted">(Code: @Model.CouponCode)</span>
                                }
                            </span>
                            <span class="info-value text-success">-@Model.DiscountAmount.ToString("N2") @Model.Currency</span>
                        </div>
                    }
                    <div class="info-row">
                        <span class="info-label">Shipping Cost</span>
                        <span class="info-value">@Model.ShippingCost.ToString("N2") @Model.Currency</span>
                    </div>
                    @if (Model.TaxAmount > 0)
                    {
                        <div class="info-row">
                            <span class="info-label">Tax (@Model.TaxRate%)</span>
                            <span class="info-value">@Model.TaxAmount.ToString("N2") @Model.Currency</span>
                        </div>
                    }
                    @if (Model.CommissionAmount > 0)
                    {
                        <div class="info-row">
                            <span class="info-label">Commission</span>
                            <span class="info-value">@Model.CommissionAmount.ToString("N2") @Model.Currency</span>
                        </div>
                    }
                    <div class="info-row border-top pt-3 mt-2">
                        <span class="info-label h5 mb-0">Total Amount</span>
                        <span class="info-value h5 mb-0">@Model.TotalAmount.ToString("N2") @Model.Currency</span>
                    </div>
                </div>
            </div>

            <!-- Shipment Information -->
            @if (Model.Shipment != null)
            {
                <div class="order-detail-card">
                    <h4 class="mb-4">
                        <i class="bi bi-truck"></i>
                        Shipment Information
                    </h4>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="info-row">
                                <span class="info-label">Provider</span>
                                <span class="info-value">@Model.Shipment.ProviderName</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Service</span>
                                <span class="info-value">@Model.Shipment.RateName</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Tracking Number</span>
                                <span class="info-value">
                                    <code>@Model.Shipment.TrackingNumber</code>
                                    @if (!string.IsNullOrEmpty(Model.Shipment.TrackingUrl))
                                    {
                                        <a href="@Model.Shipment.TrackingUrl" target="_blank" class="ms-2">
                                            <i class="bi bi-box-arrow-up-right"></i>
                                        </a>
                                    }
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-row">
                                <span class="info-label">Status</span>
                                <span class="badge-status badge-@Model.Shipment.Status.ToString().ToLower()">
                                    @Model.Shipment.Status
                                </span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Estimated Delivery</span>
                                <span class="info-value">
                                    @Model.Shipment.EstimatedDeliveryDate?.ToString("MMM dd, yyyy") ?? "N/A"
                                </span>
                            </div>
                            @if (Model.Shipment.ActualDeliveryDate.HasValue)
                            {
                                <div class="info-row">
                                    <span class="info-label">Delivered On</span>
                                    <span class="info-value text-success">
                                        @Model.Shipment.ActualDeliveryDate.Value.ToString("MMM dd, yyyy HH:mm")
                                    </span>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Tracking Timeline -->
                    @if (Model.Shipment.TrackingEvents.Any())
                    {
                        <h5 class="mt-4 mb-3">Tracking History</h5>
                        <div class="timeline">
                            @foreach (var evt in Model.Shipment.TrackingEvents.OrderByDescending(e => e.EventDate))
                            {
                                <div class="timeline-item @(evt.Status.ToLower().Contains("delivered") ? "completed" : "")">
                                    <div>
                                        <strong>@evt.Status</strong>
                                        @if (!string.IsNullOrEmpty(evt.Location))
                                        {
                                            <span class="text-muted ms-2">- @evt.Location</span>
                                        }
                                    </div>
                                    <div class="text-muted small">
                                        @evt.EventDate.ToString("MMM dd, yyyy HH:mm")
                                    </div>
                                    @if (!string.IsNullOrEmpty(evt.Description))
                                    {
                                        <div class="small mt-1">@evt.Description</div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Return Requests -->
            @if (Model.ReturnRequests.Any())
            {
                <div class="order-detail-card">
                    <h4 class="mb-4">
                        <i class="bi bi-arrow-return-left"></i>
                        Return Requests (@Model.ReturnRequests.Count)
                    </h4>
                    
                    @foreach (var returnRequest in Model.ReturnRequests)
                    {
                        <div class="border rounded p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <strong>Return Request #@returnRequest.Id</strong>
                                    <span class="badge bg-secondary ms-2">@returnRequest.Status</span>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">@returnRequest.RequestedAmount.ToString("N2") @Model.Currency</div>
                                    <small class="text-muted">Requested</small>
                                </div>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Reason</span>
                                <span class="info-value">@returnRequest.Reason</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Requested On</span>
                                <span class="info-value">@returnRequest.RequestedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            @if (returnRequest.ReviewedAt.HasValue)
                            {
                                <div class="info-row">
                                    <span class="info-label">Reviewed On</span>
                                    <span class="info-value">
                                        @returnRequest.ReviewedAt.Value.ToString("MMM dd, yyyy HH:mm")
                                        @if (!string.IsNullOrEmpty(returnRequest.ReviewerName))
                                        {
                                            <span class="text-muted">by @returnRequest.ReviewerName</span>
                                        }
                                    </span>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Customer Information -->
            <div class="order-detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-person"></i>
                    Customer Information
                </h5>
                
                <div class="info-row">
                    <span class="info-label">Name</span>
                    <span class="info-value">
                        @Model.CustomerName
                        @if (!string.IsNullOrEmpty(Model.UserVipTier) && Model.UserVipTier != "None")
                        {
                            <span class="vip-badge vip-@Model.UserVipTier.ToLower() ms-1">@Model.UserVipTier</span>
                        }
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email</span>
                    <span class="info-value">@Model.CustomerEmail</span>
                </div>
                @if (!string.IsNullOrEmpty(Model.CustomerPhone))
                {
                    <div class="info-row">
                        <span class="info-label">Phone</span>
                        <span class="info-value">@Model.CustomerPhone</span>
                    </div>
                }
                @if (Model.UserTotalSpent.HasValue)
                {
                    <div class="info-row">
                        <span class="info-label">Total Spent</span>
                        <span class="info-value">@Model.UserTotalSpent.Value.ToString("N2") @Model.Currency</span>
                    </div>
                }
            </div>

            <!-- Shipping Address -->
            <div class="order-detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-geo-alt"></i>
                    Shipping Address
                </h5>
                
                <address>
                    @Model.ShippingAddress?.Address<br>
                    @Model.ShippingAddress?.City, @Model.ShippingAddress?.State @Model.ShippingAddress?.PostalCode<br>
                    @Model.ShippingAddress?.Country
                </address>
            </div>

            <!-- Billing Address -->
            <div class="order-detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-credit-card"></i>
                    Billing Address
                </h5>
                
                <address>
                    @Model.BillingAddress?.Address<br>
                    @Model.BillingAddress?.City, @Model.BillingAddress?.State @Model.BillingAddress?.PostalCode<br>
                    @Model.BillingAddress?.Country
                </address>
            </div>

            <!-- Payment Information -->
            <div class="order-detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-wallet2"></i>
                    Payment Information
                    @if (Model.IsDemoOrder)
                    {
                        <span class="badge bg-warning text-dark ms-2" style="font-size: 0.7em;">DEMO</span>
                    }
                </h5>
                
                @if (Model.IsDemoOrder)
                {
                    <div class="alert alert-info py-2 mb-3">
                        <small><i class="bi bi-info-circle"></i> This is demo data. Stripe IDs are simulated and not linked to real transactions.</small>
                    </div>
                }
                
                <div class="info-row">
                    <span class="info-label">Status</span>
                    <span class="badge-status badge-@Model.PaymentStatus.ToLower()">
                        @Model.PaymentStatus.ToUpper()
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(Model.StripePaymentIntentId))
                {
                    <div class="info-row">
                        <span class="info-label">Payment Intent</span>
                        <span class="info-value">
                            <small><code class="@(Model.IsDemoOrder ? "text-muted" : "")">@Model.StripePaymentIntentId</code></small>
                        </span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.StripeChargeId))
                {
                    <div class="info-row">
                        <span class="info-label">Charge ID</span>
                        <span class="info-value">
                            <small><code class="@(Model.IsDemoOrder ? "text-muted" : "")">@Model.StripeChargeId</code></small>
                        </span>
                    </div>
                }
                @if (Model.PaidAt.HasValue)
                {
                    <div class="info-row">
                        <span class="info-label">Paid At</span>
                        <span class="info-value">@Model.PaidAt.Value.ToString("MMM dd, yyyy HH:mm")</span>
                    </div>
                }
            </div>

            <!-- Developer Earnings -->
            @if (Model.DeveloperEarnings != null)
            {
                <div class="order-detail-card">
                    <h5 class="mb-3">
                        <i class="bi bi-cash-stack"></i>
                        Developer Earnings
                    </h5>
                    
                    <div class="info-row">
                        <span class="info-label">Gross Amount</span>
                        <span class="info-value">@Model.DeveloperEarnings.GrossAmount.ToString("N2") PLN</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Commission</span>
                        <span class="info-value text-danger">-@Model.DeveloperEarnings.DeveloperCommission.ToString("N2") PLN</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Stripe Fee</span>
                        <span class="info-value text-danger">-@Model.DeveloperEarnings.StripeProcessingFee.ToString("N2") PLN</span>
                    </div>
                    <div class="info-row border-top pt-2 mt-2">
                        <span class="info-label"><strong>Net Earnings</strong></span>
                        <span class="info-value"><strong>@Model.DeveloperEarnings.NetAmount.ToString("N2") PLN</strong></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="badge bg-@(Model.DeveloperEarnings.PayoutStatus == Kokomija.Entity.PayoutStatus.Processed ? "success" : "warning")">
                            @Model.DeveloperEarnings.PayoutStatus.ToString().ToUpper()
                        </span>
                    </div>
                </div>
            }

            <!-- Quick Actions -->
            <div class="order-detail-card">
                <h5 class="mb-3">
                    <i class="bi bi-lightning"></i>
                    Quick Actions
                </h5>
                
                <div class="action-buttons">
                    @if (Model.OrderStatus != "cancelled" && Model.OrderStatus != "delivered")
                    {
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#updateStatusModal">
                            <i class="bi bi-arrow-repeat"></i> Update Status
                        </button>
                    }
                    
                    @if (Model.Shipment == null && Model.OrderStatus != "cancelled" && Model.PaymentStatus == "paid")
                    {
                        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#createShipmentModal">
                            <i class="bi bi-truck"></i> Create Shipment
                        </button>
                    }
                    
                    @if (Model.Shipment != null && Model.Shipment.Status != Kokomija.Entity.ShipmentStatus.Delivered)
                    {
                        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#addTrackingModal">
                            <i class="bi bi-pin-map"></i> Add Tracking Event
                        </button>
                    }
                    
                    <a href="mailto:@Model.CustomerEmail" class="btn btn-secondary btn-sm">
                        <i class="bi bi-envelope"></i> Email Customer
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" name="orderId" value="@Model.Id">
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select name="newStatus" class="form-select" required>
                            <option value="">Select Status...</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea name="notes" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateOrderStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Shipment Modal -->
<div class="modal fade" id="createShipmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Shipment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createShipmentForm">
                    <input type="hidden" name="orderId" value="@Model.Id">
                    <div class="mb-3">
                        <label class="form-label">Shipping Provider</label>
                        <select name="shippingProviderId" class="form-select" required>
                            <option value="">Select Provider...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Shipping Rate</label>
                        <select name="shippingRateId" class="form-select" required>
                            <option value="">Select Rate...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tracking Number</label>
                        <input type="text" name="trackingNumber" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" name="weight" class="form-control" step="0.01" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Estimated Delivery Date</label>
                        <input type="date" name="estimatedDeliveryDate" class="form-control">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createShipment()">Create Shipment</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Tracking Event Modal -->
<div class="modal fade" id="addTrackingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Tracking Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTrackingForm">
                    <input type="hidden" name="shipmentId" value="@Model.Shipment?.Id">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select" required>
                            <option value="">Select Status...</option>
                            <option value="Pending">Pending</option>
                            <option value="Processing">Processing</option>
                            <option value="Shipped">Shipped</option>
                            <option value="In Transit">In Transit</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Failed">Failed</option>
                            <option value="Returned">Returned</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <input type="text" name="location" class="form-control" placeholder="City, Country">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Event Date</label>
                        <input type="datetime-local" name="eventDate" class="form-control" value="@DateTime.UtcNow.ToString("yyyy-MM-ddTHH:mm")">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" onclick="addTrackingEvent()">Add Event</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Load shipping providers on page load
        $(document).ready(function() {
            loadShippingProviders();
        });

        function loadShippingProviders() {
            // This would normally load from API
            // For now, placeholder - you'd need to add an API endpoint
            console.log('Load shipping providers');
        }

        function updateOrderStatus() {
            const form = document.getElementById('updateStatusForm');
            const formData = new FormData(form);
            
            fetch('@Url.Action("UpdateOrderStatus", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: parseInt(formData.get('orderId')),
                    newStatus: formData.get('newStatus'),
                    notes: formData.get('notes')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status');
            });
        }

        function createShipment() {
            const form = document.getElementById('createShipmentForm');
            const formData = new FormData(form);
            
            fetch('@Url.Action("CreateOrderShipment", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    orderId: parseInt(formData.get('orderId')),
                    shippingProviderId: parseInt(formData.get('shippingProviderId')),
                    shippingRateId: parseInt(formData.get('shippingRateId')),
                    trackingNumber: formData.get('trackingNumber'),
                    weight: parseFloat(formData.get('weight')),
                    estimatedDeliveryDate: formData.get('estimatedDeliveryDate')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while creating the shipment');
            });
        }

        function addTrackingEvent() {
            const form = document.getElementById('addTrackingForm');
            const formData = new FormData(form);
            
            fetch('@Url.Action("AddOrderTrackingEvent", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    shipmentId: parseInt(formData.get('shipmentId')),
                    status: formData.get('status'),
                    location: formData.get('location'),
                    description: formData.get('description'),
                    eventDate: formData.get('eventDate')
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while adding the tracking event');
            });
        }
    </script>
}
</div>
