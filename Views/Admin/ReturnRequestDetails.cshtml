@model Kokomija.Models.ViewModels.ReturnRequest.ReturnRequestDetailsDto
@using Kokomija.Entity
@{
    ViewData["Title"] = "Return Request Details";
}

<div class="admin-dashboard">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1>
                                <i class="bi bi-arrow-return-left"></i>
                                Return Request #@Model.Id
                            </h1>
                            <p class="mb-0">
                                Order: <code>@Model.OrderNumber</code> | 
                                Status: 
                                @if (Model.Status == ReturnRequestStatus.Pending)
                                {
                                    <span class="badge bg-warning">Pending</span>
                                }
                                else if (Model.Status == ReturnRequestStatus.UnderReview)
                                {
                                    <span class="badge bg-info">Under Review</span>
                                }
                                else if (Model.Status == ReturnRequestStatus.Approved)
                                {
                                    <span class="badge bg-success">Approved</span>
                                }
                                else if (Model.Status == ReturnRequestStatus.Rejected)
                                {
                                    <span class="badge bg-danger">Rejected</span>
                                }
                                else if (Model.Status == ReturnRequestStatus.Completed)
                                {
                                    <span class="badge bg-primary">Completed</span>
                                }
                            </p>
                        </div>
                        <div class="d-flex gap-2">
                            <a asp-action="ReturnRequests" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i>
                                Back to List
                            </a>
                            @if (Model.Status == ReturnRequestStatus.Pending || Model.Status == ReturnRequestStatus.UnderReview)
                            {
                                <button type="button" class="btn btn-success" onclick="reviewReturn(@Model.Id, true)">
                                    <i class="bi bi-check-lg"></i> Approve
                                </button>
                                <button type="button" class="btn btn-danger" onclick="reviewReturn(@Model.Id, false)">
                                    <i class="bi bi-x-lg"></i> Reject
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Customer Information -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-person"></i> Customer Information
                        </h5>
                        <p><strong>Name:</strong> @Model.CustomerName</p>
                        <p><strong>Email:</strong> @Model.CustomerEmail</p>
                        <p><strong>Requested:</strong> @Model.RequestedAt.ToString("yyyy-MM-dd HH:mm")</p>
                    </div>
                </div>

                <!-- Financial Details -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-cash"></i> Financial Details
                        </h5>
                        <p><strong>Product Price:</strong> @Model.ProductPrice.ToString("C")</p>
                        <p><strong>Quantity:</strong> @Model.Quantity</p>
                        <p><strong>Requested Amount:</strong> <span class="text-primary">@Model.RequestedAmount.ToString("C")</span></p>
                        @if (Model.RefundedAmount.HasValue)
                        {
                            <hr>
                            <p><strong>Refunded Amount:</strong> <span class="text-success">@Model.RefundedAmount.Value.ToString("C")</span></p>
                            <p><strong>Refunded At:</strong> @Model.RefundedAt?.ToString("yyyy-MM-dd HH:mm")</p>
                            @if (!string.IsNullOrEmpty(Model.StripeRefundId))
                            {
                                <p><strong>Stripe Refund ID:</strong><br><small><code>@Model.StripeRefundId</code></small></p>
                            }
                        }
                    </div>
                </div>

                <!-- Review Information -->
                @if (Model.ReviewedAt.HasValue)
                {
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-clipboard-check"></i> Review Information
                            </h5>
                            <p><strong>Reviewed By:</strong> @Model.ReviewerName</p>
                            <p><strong>Reviewed At:</strong> @Model.ReviewedAt.Value.ToString("yyyy-MM-dd HH:mm")</p>
                            @if (!string.IsNullOrEmpty(Model.ReviewNotes))
                            {
                                <p><strong>Review Notes:</strong></p>
                                <div class="alert alert-info">@Model.ReviewNotes</div>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Return Details -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-box"></i> Product Information
                        </h5>
                        <div class="row">
                            @if (!string.IsNullOrEmpty(Model.ProductImageUrl))
                            {
                                <div class="col-md-3">
                                    <img src="@Model.ProductImageUrl" alt="@Model.ProductName" class="img-fluid rounded">
                                </div>
                            }
                            <div class="col-md-9">
                                <h5>@Model.ProductName</h5>
                                <p><strong>Quantity:</strong> @Model.Quantity</p>
                                <p><strong>Price:</strong> @Model.ProductPrice.ToString("C") each</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h5 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-chat-text"></i> Return Reason
                        </h5>
                        <p><strong>Reason:</strong> @Model.Reason</p>
                        <div class="alert alert-light">
                            <strong>Description:</strong><br>
                            @Model.Description
                        </div>
                    </div>
                </div>

                <!-- Uploaded Images -->
                @if (Model.ImageUrls != null && Model.ImageUrls.Any())
                {
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-images"></i> Evidence Images (@Model.ImageUrls.Count)
                            </h5>
                            <div class="row g-3">
                                @foreach (var imageUrl in Model.ImageUrls)
                                {
                                    <div class="col-md-4">
                                        <a href="@imageUrl" target="_blank">
                                            <img src="@imageUrl" alt="Return evidence" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover;">
                                        </a>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Status History -->
                @if (Model.StatusHistory != null && Model.StatusHistory.Any())
                {
                    <div class="card mt-3">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-clock-history"></i> Status History
                            </h5>
                            <div class="timeline">
                                @foreach (var history in Model.StatusHistory.OrderByDescending(h => h.ChangedAt))
                                {
                                    <div class="timeline-item mb-3">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                @if (history.Status == ReturnRequestStatus.Pending)
                                                {
                                                    <span class="badge bg-warning">Pending</span>
                                                }
                                                else if (history.Status == ReturnRequestStatus.UnderReview)
                                                {
                                                    <span class="badge bg-info">Under Review</span>
                                                }
                                                else if (history.Status == ReturnRequestStatus.Approved)
                                                {
                                                    <span class="badge bg-success">Approved</span>
                                                }
                                                else if (history.Status == ReturnRequestStatus.Rejected)
                                                {
                                                    <span class="badge bg-danger">Rejected</span>
                                                }
                                                else if (history.Status == ReturnRequestStatus.Completed)
                                                {
                                                    <span class="badge bg-primary">Completed</span>
                                                }
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between">
                                                    <strong>@history.ChangedBy</strong>
                                                    <small class="text-muted">@history.ChangedAt.ToString("yyyy-MM-dd HH:mm")</small>
                                                </div>
                                                @if (!string.IsNullOrEmpty(history.Notes))
                                                {
                                                    <p class="mb-0 text-muted">@history.Notes</p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalTitle">Review Return Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <input type="hidden" id="returnRequestId" value="@Model.Id" />
                    <input type="hidden" id="approvalDecision" />
                    
                    <div class="mb-3">
                        <label for="reviewNotes" class="form-label">Review Notes <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reviewNotes" rows="4" placeholder="Enter your review notes..." required></textarea>
                    </div>

                    <div class="mb-3" id="refundAmountContainer">
                        <label for="refundAmount" class="form-label">Refund Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="refundAmount" step="0.01" min="0" value="@Model.RequestedAmount" placeholder="@Model.RequestedAmount">
                        </div>
                        <div class="form-text">Requested amount: @Model.RequestedAmount.ToString("C")</div>
                    </div>

                    <div class="alert alert-info" id="approveAlert" style="display: none;">
                        <i class="bi bi-info-circle"></i>
                        A refund will be processed via Stripe after approval.
                    </div>

                    <div class="alert alert-warning" id="rejectAlert" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        The customer will be notified of the rejection.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitReview()">
                    <i class="bi bi-send"></i> Submit Review
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let isApproval = false;

        function reviewReturn(id, approve) {
            isApproval = approve;
            document.getElementById('approvalDecision').value = approve;
            document.getElementById('reviewNotes').value = '';

            if (approve) {
                document.getElementById('reviewModalTitle').textContent = 'Approve Return Request';
                document.getElementById('approveAlert').style.display = 'block';
                document.getElementById('rejectAlert').style.display = 'none';
                document.getElementById('refundAmountContainer').style.display = 'block';
            } else {
                document.getElementById('reviewModalTitle').textContent = 'Reject Return Request';
                document.getElementById('approveAlert').style.display = 'none';
                document.getElementById('rejectAlert').style.display = 'block';
                document.getElementById('refundAmountContainer').style.display = 'none';
            }

            new bootstrap.Modal(document.getElementById('reviewModal')).show();
        }

        async function submitReview() {
            const reviewNotes = document.getElementById('reviewNotes').value;
            const refundAmount = document.getElementById('refundAmount').value;
            const returnRequestId = document.getElementById('returnRequestId').value;

            if (!reviewNotes) {
                alert('Please enter review notes');
                return;
            }

            const data = {
                returnRequestId: parseInt(returnRequestId),
                approved: isApproval,
                reviewNotes: reviewNotes,
                refundAmount: refundAmount ? parseFloat(refundAmount) : null
            };

            try {
                const response = await fetch('/Admin/ReviewReturnRequest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
                    alert(result.message);
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while submitting the review');
            }
        }
    </script>
}
