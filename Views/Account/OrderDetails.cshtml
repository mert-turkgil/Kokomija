@model Kokomija.Models.ViewModels.Account.OrderViewModel
@inject Kokomija.Services.ILocalizationService Localizer

@{
    ViewData["Title"] = Localizer["Account_Order_Details"] + " #" + Model.OrderNumber;
}

<div class="container my-5">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">@Localizer["Home"]</a></li>
                    <li class="breadcrumb-item"><a asp-action="Index">@Localizer["Account_MyAccount"]</a></li>
                    <li class="breadcrumb-item active">@Localizer["Account_Order_Details"] #@Model.OrderNumber</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">@Localizer["Order_Items"]</h5>
                    <span class="badge bg-@(Model.OrderStatus == "Completed" || Model.OrderStatus == "Delivered" ? "success" : Model.OrderStatus == "Cancelled" ? "danger" : "warning")">
                        @Model.OrderStatus
                    </span>
                </div>
                <div class="card-body">
                    @foreach (var item in Model.Items)
                    {
                        <div class="row mb-3 pb-3 border-bottom">
                            <div class="col-md-2">
                                @if (!string.IsNullOrEmpty(item.ProductImage))
                                {
                                    <img src="@item.ProductImage" 
                                         alt="@item.ProductName" 
                                         class="img-fluid rounded" 
                                         onerror="this.onerror=null; this.src='@Url.Content("~/img/logo_black.png")'; this.classList.add('logo-fallback');" />
                                }
                                else
                                {
                                    <img src="@Url.Content("~/img/logo_black.png")" 
                                         alt="Kokomija" 
                                         class="img-fluid rounded logo-fallback" />
                                }
                            </div>
                            <div class="col-md-6">
                                <h6 class="mb-1">@item.ProductName</h6>
                                @if (!string.IsNullOrEmpty(item.ColorName))
                                {
                                    <small class="text-muted">@Localizer["Color"]: @item.ColorName</small><br />
                                }
                                @if (!string.IsNullOrEmpty(item.SizeName))
                                {
                                    <small class="text-muted">@Localizer["Size"]: @item.SizeName</small>
                                }
                            </div>
                            <div class="col-md-2 text-center">
                                <p class="mb-0"><strong>x@item.Quantity</strong></p>
                            </div>
                            <div class="col-md-2 text-end">
                                <p class="mb-0"><strong>@item.TotalPrice.ToString("C")</strong></p>
                                <small class="text-muted">@item.UnitPrice.ToString("C") @Localizer["Each"]</small>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">@Localizer["Order_Status"]</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">@Localizer["Order_Number"]:</dt>
                        <dd class="col-sm-6">#@Model.OrderNumber</dd>

                        <dt class="col-sm-6">@Localizer["Order_Date"]:</dt>
                        <dd class="col-sm-6">@Model.OrderDate.ToString("MMMM dd, yyyy")</dd>

                        <dt class="col-sm-6">@Localizer["Order_Status"]:</dt>
                        <dd class="col-sm-6">
                            <span class="badge bg-@(Model.OrderStatus == "Completed" || Model.OrderStatus == "Delivered" ? "success" : Model.OrderStatus == "Cancelled" ? "danger" : "warning")">
                                @Model.OrderStatus
                            </span>
                        </dd>

                        <dt class="col-sm-6">@Localizer["Payment_Status"]:</dt>
                        <dd class="col-sm-6">
                            <span class="badge bg-@(Model.PaymentStatus == "Paid" ? "success" : Model.PaymentStatus == "Failed" ? "danger" : "warning")">
                                @Model.PaymentStatus
                            </span>
                        </dd>
                    </dl>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">@Localizer["Order_Total"]</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>@Localizer["Subtotal"]:</span>
                        <strong>@Model.TotalAmount.ToString("C")</strong>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                @if (Model.CanCancel)
                {
                    <button type="button" class="btn btn-outline-danger" onclick="cancelOrder(@Model.Id)">
                        <i class="bi bi-x-circle me-2"></i>@Localizer["Account_CancelOrder"]
                    </button>
                }
                @if (Model.CanReturn)
                {
                    <a asp-action="ReturnRequest" asp-route-orderId="@Model.Id" class="btn btn-outline-warning">
                        <i class="bi bi-arrow-return-left me-2"></i>@Localizer["Account_RequestReturn"]
                    </a>
                }
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>@Localizer["Back_To_Account"]
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function cancelOrder(orderId) {
            if (!confirm('@Localizer["Confirm_Cancel_Order"]')) {
                return;
            }

            fetch('/Account/CancelOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: 'id=' + orderId
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert(data.message || '@Localizer["Error_Cancelling_Order"]');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('@Localizer["Error_Cancelling_Order"]');
            });
        }
    </script>
}
