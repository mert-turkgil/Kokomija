@model Kokomija.Models.ViewModels.Admin.ProductCreateDto
@{
    ViewData["Title"] = "Create New Product";
}
<div class="container-fluid">
    <div class="admin-dashboard">
        <!-- Header -->
        <div class="welcome-card mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <h2 class="mb-1"><i class="bi bi-box-seam me-2"></i>Create New Product</h2>
                    <p class="text-white-50 mb-0">Single-page product creation with Stripe integration</p>
                </div>
                <div class="d-flex gap-2">
                    <a asp-action="CreateWizard" class="btn btn-outline-light">
                        <i class="bi bi-magic me-1"></i> Use Wizard Instead
                    </a>
                    <a asp-action="Index" class="btn btn-light">
                        <i class="bi bi-arrow-left"></i> Back to Products
                    </a>
                </div>
            </div>
        </div>

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show">
                <i class="bi bi-exclamation-triangle me-2"></i>@TempData["Error"]
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <form asp-action="Create" method="post" id="productForm" novalidate>
            @Html.AntiForgeryToken()

            @if (!ViewData.ModelState.IsValid)
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i><strong>Please fix the following errors:</strong>
                    <div asp-validation-summary="All"></div>
                </div>
            }

            <div class="row">
                <!-- LEFT COLUMN -->
                <div class="col-lg-8">
                    <!-- 1. Translations -->
                    <div class="card mb-4">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0"><i class="bi bi-translate me-2"></i>Product Name & Description</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs mb-3" id="translationTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="en-tab" data-bs-toggle="tab" data-bs-target="#en" type="button" role="tab">
                                        <span class="me-1">ðŸ‡ºðŸ‡¸</span> English
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pl-tab" data-bs-toggle="tab" data-bs-target="#pl" type="button" role="tab">
                                        <span class="me-1">ðŸ‡µðŸ‡±</span> Polski
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="translationTabContent">
                                <!-- English -->
                                <div class="tab-pane fade show active" id="en" role="tabpanel">
                                    <input type="hidden" name="Translations[0].CultureCode" value="en-US" />
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Product Name (English) *</label>
                                        <input name="Translations[0].Name" id="nameEn" class="form-control form-control-lg" placeholder="Enter product name" required />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Description (English) *</label>
                                        <textarea name="Translations[0].Description" id="descEn" class="form-control" rows="5" placeholder="Detailed product description" required></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Slug (URL)</label>
                                            <input name="Translations[0].Slug" id="slugEn" class="form-control" placeholder="auto-generated" />
                                            <small class="text-muted">Leave empty to auto-generate</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Meta Description</label>
                                            <input name="Translations[0].MetaDescription" class="form-control" placeholder="SEO meta description" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Meta Keywords</label>
                                            <input name="Translations[0].MetaKeywords" class="form-control" placeholder="keyword1, keyword2" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Polish -->
                                <div class="tab-pane fade" id="pl" role="tabpanel">
                                    <input type="hidden" name="Translations[1].CultureCode" value="pl-PL" />
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Nazwa Produktu (Polski) *</label>
                                        <input name="Translations[1].Name" id="namePl" class="form-control form-control-lg" placeholder="WprowadÅº nazwÄ™ produktu" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Opis (Polski) *</label>
                                        <textarea name="Translations[1].Description" id="descPl" class="form-control" rows="5" placeholder="SzczegÃ³Å‚owy opis produktu"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Slug URL</label>
                                            <input name="Translations[1].Slug" class="form-control" placeholder="automatycznie" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Meta Opis</label>
                                            <input name="Translations[1].MetaDescription" class="form-control" placeholder="SEO meta opis" />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">SÅ‚owa Kluczowe</label>
                                            <input name="Translations[1].MetaKeywords" class="form-control" placeholder="sÅ‚owo1, sÅ‚owo2" />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Auto-Translate -->
                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded border mt-2">
                                <div>
                                    <i class="bi bi-stars text-primary me-2"></i>
                                    <span class="text-muted">Fill English first, then auto-translate to Polish</span>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="autoTranslateBtn" disabled>
                                    <i class="bi bi-translate me-1"></i> Auto-Translate
                                </button>
                            </div>

                            <!-- Hidden fallback fields -->
                            <input type="hidden" asp-for="Name" id="defaultName" />
                            <input type="hidden" asp-for="Description" id="defaultDescription" />
                        </div>
                    </div>

                    <!-- 2. PRICING -->
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Pricing</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <!-- Retail Price -->
                                <div class="col-md-6">
                                    <div class="p-3 rounded border h-100 pricing-b2c">
                                        <h6 class="mb-3"><i class="bi bi-person me-1"></i> Retail Price (B2C) <span class="text-danger">*</span></h6>
                                        <label asp-for="BasePrice" class="form-label fw-bold">Price for this product</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-success text-white">zÅ‚</span>
                                            <input asp-for="BasePrice" type="number" step="0.01" min="0.01"
                                                   class="form-control form-control-lg fw-bold" placeholder="49.99" id="retailPriceInput" />
                                        </div>
                                        <span asp-validation-for="BasePrice" class="text-danger"></span>
                                        <div class="mt-2 small text-muted" id="pricePerItemInfo"></div>
                                    </div>
                                </div>
                                <!-- Business Price -->
                                <div class="col-md-6">
                                    <div class="p-3 rounded border h-100 pricing-b2b">
                                        <h6 class="mb-3"><i class="bi bi-building me-1"></i> Business Price (B2B) <span class="badge bg-secondary">Optional</span></h6>
                                        <div class="alert alert-info border-0 py-2 px-3 mb-2" style="background: rgba(13,110,253,0.08); font-size: 0.82rem;">
                                            <i class="bi bi-lightning-fill text-primary me-1"></i>
                                            <strong>Auto-Accept:</strong> The B2B price becomes active immediately after saving. No approval needed.
                                        </div>
                                        <label asp-for="BusinessPrice" class="form-label fw-bold">Business wholesale price</label>
                                        <div class="input-group input-group-lg">
                                            <span class="input-group-text bg-primary text-white">zÅ‚</span>
                                            <input asp-for="BusinessPrice" type="number" step="0.01" min="0"
                                                   class="form-control form-control-lg fw-bold" placeholder="Leave empty = use retail" id="businessPriceInput" />
                                        </div>
                                        <span asp-validation-for="BusinessPrice" class="text-danger"></span>
                                        <small class="text-muted d-block mt-1">
                                            <i class="bi bi-briefcase me-1"></i>Special price for verified business customers. Leave empty to use retail price.
                                        </small>
                                        <div class="mt-2 small text-success fw-bold" id="businessSavingsInfo" style="display:none;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <label asp-for="MinBusinessQuantity" class="form-label">Min. Business Order Qty</label>
                                    <div class="input-group">
                                        <input asp-for="MinBusinessQuantity" type="number" min="0" class="form-control" placeholder="0" value="0" />
                                        <span class="input-group-text">units</span>
                                    </div>
                                    <small class="text-muted">0 = no minimum</small>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">B2B Visibility</label>
                                    <div class="form-check mt-2">
                                        <input asp-for="IsAvailableForBusiness" class="form-check-input" type="checkbox" checked />
                                        <label class="form-check-label" asp-for="IsAvailableForBusiness">
                                            <i class="bi bi-eye me-1"></i> Visible to B2B
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">B2B Only</label>
                                    <div class="form-check mt-2">
                                        <input asp-for="IsBusinessOnly" class="form-check-input" type="checkbox" />
                                        <label class="form-check-label" asp-for="IsBusinessOnly">
                                            <i class="bi bi-lock me-1"></i> B2B customers only
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Images -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-images me-2"></i>Product Images</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Required:</strong> Upload at least 1 image. Max 5MB each (JPG/PNG/WEBP).
                            </div>

                            <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center" style="cursor: pointer; transition: all 0.3s;">
                                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                                <p class="mb-2"><strong>Drag & Drop images here</strong></p>
                                <p class="text-muted mb-2">or</p>
                                <button type="button" class="btn btn-primary" id="selectFilesBtn">
                                    <i class="bi bi-folder2-open me-1"></i> Browse Files
                                </button>
                                <input type="file" id="imageUpload" class="d-none" accept=".jpg,.jpeg,.png,.webp" multiple />
                            </div>
                            <small class="text-muted">Click the star icon to set primary image.</small>

                            <div id="imagePreview" class="row g-3 mt-2"></div>

                            <!-- Hidden inputs for image binding -->
                            <div id="imageHiddenInputs"></div>
                            <input type="hidden" id="tempImageFileNamesRaw" name="TempImageFileNamesRaw" />
                        </div>
                    </div>

                    <!-- 4. Variants -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-grid-3x3-gap me-2"></i>Product Variants (Stock Management)</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Each variant = a sellable combination</strong> (e.g., Size 42 + Black color).
                                Variant price defaults to base price if left empty.
                            </div>

                            <div class="mb-3 d-flex gap-2">
                                <button type="button" class="btn btn-success" id="addVariantBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add Variant
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="generateVariantsBtn">
                                    <i class="bi bi-magic me-1"></i> Auto-Generate from Selections
                                </button>
                            </div>

                            <div id="variantsContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN -->
                <div class="col-lg-4">
                    <!-- Category & Pack Settings -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Category & Pack</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="PackSize" class="form-label fw-bold">Pack Size *</label>
                                <div class="input-group">
                                    <input asp-for="PackSize" type="number" min="1" max="100" class="form-control form-control-lg fw-bold" placeholder="1" value="1" id="packSizeInput" />
                                    <span class="input-group-text">items</span>
                                </div>
                                <span asp-validation-for="PackSize" class="text-danger"></span>
                                <small class="text-muted d-block mt-1">1 = Single item, 5 = 5-Pack, etc.</small>
                            </div>

                            <div class="mb-3">
                                <label asp-for="ProductGroupId" class="form-label">Product Group</label>
                                <select asp-for="ProductGroupId" class="form-select">
                                    <option value="">â€” No group â€”</option>
                                    @if (ViewBag.ProductGroups != null)
                                    {
                                        @foreach (var group in (List<Kokomija.Entity.ProductGroup>)ViewBag.ProductGroups)
                                        {
                                            <option value="@group.Id">@group.Name (@(group.Products?.Count ?? 0) products)</option>
                                        }
                                    }
                                </select>
                                <small class="text-muted">Group related products (Single, 5-Pack, 10-Pack)</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Category * <span class="text-danger">Required</span></label>
                                <button type="button" class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#categoryModal">
                                    <i class="bi bi-search me-1"></i> Select Category
                                </button>
                                <input type="hidden" asp-for="CategoryId" id="selectedCategoryId" required />
                                <div id="selectedCategoryDisplay" class="mt-2 text-muted">
                                    <i class="bi bi-info-circle me-1"></i>No category selected
                                </div>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="CouponId" class="form-label">Coupon</label>
                                <select asp-for="CouponId" class="form-select">
                                    <option value="">â€” No coupon â€”</option>
                                    @if (ViewBag.Coupons != null)
                                    {
                                        @foreach (var coupon in (List<Kokomija.Entity.Coupon>)ViewBag.Coupons)
                                        {
                                            var displayText = $"{coupon.Code} - ";
                                            displayText += coupon.DiscountType == "percentage"
                                                ? $"{coupon.DiscountValue}% off"
                                                : $"{coupon.DiscountValue} zÅ‚ off";
                                            <option value="@coupon.Id">@displayText</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Sizes & Colors -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-palette me-2"></i>Sizes & Colors</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Available Sizes</label>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var size in Model.AvailableSizes)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input size-checkbox" type="checkbox" name="SelectedSizeIds" value="@size.Value" id="size_@size.Value" />
                                            <label class="form-check-label" for="size_@size.Value">@size.Text</label>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">Available Colors</label>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var color in Model.AvailableColors)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input color-checkbox" type="checkbox" name="SelectedColorIds" value="@color.Value" id="color_@color.Value" />
                                            <label class="form-check-label" for="color_@color.Value">@color.Text</label>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Custom Colors</label>
                                <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#customColorModal">
                                    <i class="bi bi-plus-circle me-1"></i> Add Custom Color
                                </button>
                                <input type="hidden" asp-for="CustomColorHex" id="customColorHexInput" />
                                <input type="hidden" asp-for="CustomColorName" id="customColorNameInput" />
                                <div id="customColorsList" class="mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-toggle-on me-2"></i>Status</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" id="isActiveSwitch" checked />
                                <label class="form-check-label" for="isActiveSwitch">
                                    <strong>Active</strong> â€” visible to customers
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="d-flex gap-2 bg-body-tertiary p-3 rounded-3 mt-2 mb-5 sticky-bottom">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="bi bi-check-circle me-1"></i> Create Product
                </button>
                <a asp-action="Index" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle me-1"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-grid-3x3-gap me-2"></i>Select Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table id="categoryTable" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Order</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in (List<Kokomija.Entity.Category>)ViewBag.Categories)
                        {
                            var translation = category.Translations?.FirstOrDefault(t => t.CultureCode == "en-US")
                                ?? category.Translations?.FirstOrDefault();
                            var categoryName = translation?.Name ?? category.Name ?? "Unnamed";
                            <tr>
                                <td>@categoryName</td>
                                <td>
                                    @if (category.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                                <td>@category.DisplayOrder</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary select-category"
                                            data-category-id="@category.Id"
                                            data-category-name="@categoryName">Select</button>
                                </td>
                            </tr>
                            @if (category.SubCategories?.Any() == true)
                            {
                                @foreach (var sub in category.SubCategories.Where(s => s.IsActive))
                                {
                                    var subTranslation = sub.Translations?.FirstOrDefault(t => t.CultureCode == "en-US")
                                        ?? sub.Translations?.FirstOrDefault();
                                    var subName = subTranslation?.Name ?? sub.Name ?? "Unnamed";
                                    <tr>
                                        <td class="ps-4">â†³ @subName</td>
                                        <td><span class="badge bg-success">Active</span></td>
                                        <td>@sub.DisplayOrder</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary select-category"
                                                    data-category-id="@sub.Id"
                                                    data-category-name="@($"{categoryName} > {subName}")">Select</button>
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Custom Color Modal -->
<div class="modal fade" id="customColorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-palette me-2"></i>Add Custom Color</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Color Name *</label>
                    <input type="text" id="customColorNameField" class="form-control" placeholder="E.g., Rose Gold" />
                </div>
                <div class="mb-3">
                    <label class="form-label">Hex Code *</label>
                    <div class="input-group">
                        <span class="input-group-text">#</span>
                        <input type="text" id="customColorHexField" class="form-control" placeholder="FF69B4" maxlength="6" />
                        <input type="color" id="colorPicker" class="form-control form-control-color" value="#000000" />
                    </div>
                </div>
                <div id="customColorPreview" class="p-3 rounded text-center" style="border: 2px dashed #ddd;">
                    <strong>Preview</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addCustomColorBtn">Add Color</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .pricing-b2c {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        .pricing-b2b {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        [data-bs-theme="dark"] .pricing-b2c {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.15) 0%, rgba(76, 175, 80, 0.25) 100%);
        }
        [data-bs-theme="dark"] .pricing-b2b {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.15) 0%, rgba(33, 150, 243, 0.25) 100%);
        }
        .image-preview-item { position: relative; }
        .image-preview-item img {
            width: 100%; height: 150px; object-fit: cover; border-radius: 8px;
        }
        .image-remove-btn {
            position: absolute; top: 5px; right: 5px;
            background: rgba(220, 53, 69, 0.9); border: none; border-radius: 50%;
            color: white; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .variant-card {
            border: 1px solid var(--bs-border-color);
            border-radius: 8px; padding: 15px; margin-bottom: 15px;
            background: var(--bs-tertiary-bg);
        }
        .variant-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .sticky-bottom {
            position: sticky; bottom: 0; z-index: 10;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let tempImageFileNames = [];
        let variantIndex = 0;
        let primaryImageFileName = null;

        // ==========================================
        // IMAGE UPLOAD
        // ==========================================
        const dropZone = document.getElementById('dropZone');
        const imageUpload = document.getElementById('imageUpload');
        const selectFilesBtn = document.getElementById('selectFilesBtn');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => {
            dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
            document.body.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); });
        });

        ['dragenter', 'dragover'].forEach(ev => {
            dropZone.addEventListener(ev, () => {
                dropZone.style.borderColor = '#0d6efd';
                dropZone.style.backgroundColor = 'rgba(13, 110, 253, 0.05)';
            });
        });

        ['dragleave', 'drop'].forEach(ev => {
            dropZone.addEventListener(ev, () => {
                dropZone.style.borderColor = '';
                dropZone.style.backgroundColor = '';
            });
        });

        dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
        dropZone.addEventListener('click', () => imageUpload.click());
        selectFilesBtn.addEventListener('click', e => { e.stopPropagation(); imageUpload.click(); });
        imageUpload.addEventListener('change', async e => { await handleFiles(e.target.files); e.target.value = ''; });

        async function handleFiles(files) {
            for (const file of Array.from(files)) await uploadFile(file);
        }

        async function uploadFile(file) {
            if (file.size > 5 * 1024 * 1024) { alert('File ' + file.name + ' is too large. Max 5MB.'); return; }
            const formData = new FormData();
            formData.append('file', file);
            try {
                const res = await fetch('@Url.Action("UploadImage")', { method: 'POST', body: formData });
                const result = await res.json();
                if (result.success) {
                    tempImageFileNames.push(result.tempFileName);
                    if (tempImageFileNames.length === 1) primaryImageFileName = result.tempFileName;
                    addImagePreview(result.tempUrl, result.tempFileName);
                    updateImageHiddenInputs();
                } else {
                    alert('Upload error: ' + result.message);
                }
            } catch (err) { alert('Upload failed: ' + err.message); }
        }

        function addImagePreview(url, fileName) {
            const isPrimary = fileName === primaryImageFileName;
            const html = '<div class="col-md-3 image-preview-item" data-filename="' + fileName + '">' +
                '<div class="position-relative">' +
                '<img src="' + url + '" alt="Product Image" />' +
                '<button type="button" class="image-remove-btn" onclick="removeImage(\'' + fileName + '\')">' +
                '<i class="bi bi-x"></i></button>' +
                '<button type="button" class="btn btn-sm ' + (isPrimary ? 'btn-warning' : 'btn-outline-light') + ' position-absolute top-0 start-0 m-2" ' +
                'onclick="setPrimaryImage(\'' + fileName + '\')" title="Set as primary">' +
                '<i class="bi bi-star' + (isPrimary ? '-fill' : '') + '"></i></button>' +
                (isPrimary ? '<span class="badge bg-warning text-dark position-absolute bottom-0 start-50 translate-middle-x mb-2">Primary</span>' : '') +
                '</div></div>';
            document.getElementById('imagePreview').insertAdjacentHTML('beforeend', html);
        }

        function setPrimaryImage(fileName) {
            primaryImageFileName = fileName;
            tempImageFileNames = tempImageFileNames.filter(f => f !== fileName);
            tempImageFileNames.unshift(fileName);
            rebuildImagePreviews();
            updateImageHiddenInputs();
        }

        function rebuildImagePreviews() {
            const container = document.getElementById('imagePreview');
            const items = Array.from(container.querySelectorAll('.image-preview-item'));
            const imageData = items.map(item => ({ fileName: item.dataset.filename, url: item.querySelector('img').src }));
            container.innerHTML = '';
            tempImageFileNames.forEach(fn => {
                const data = imageData.find(d => d.fileName === fn);
                if (data) addImagePreview(data.url, fn);
            });
        }

        async function removeImage(fileName) {
            if (!confirm('Remove this image?')) return;
            try {
                await fetch('@Url.Action("CancelUpload")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value },
                    body: JSON.stringify({ tempFileNames: [fileName] })
                });
            } catch (e) { }
            tempImageFileNames = tempImageFileNames.filter(f => f !== fileName);
            if (fileName === primaryImageFileName) primaryImageFileName = tempImageFileNames.length > 0 ? tempImageFileNames[0] : null;
            const el = document.querySelector('.image-preview-item[data-filename="' + fileName + '"]');
            if (el) el.remove();
            updateImageHiddenInputs();
            if (tempImageFileNames.length > 0) rebuildImagePreviews();
        }

        function updateImageHiddenInputs() {
            const ordered = [primaryImageFileName, ...tempImageFileNames.filter(f => f !== primaryImageFileName)].filter(Boolean);
            document.getElementById('tempImageFileNamesRaw').value = ordered.join(',');
            const container = document.getElementById('imageHiddenInputs');
            container.innerHTML = '';
            ordered.forEach(fn => {
                const input = document.createElement('input');
                input.type = 'hidden'; input.name = 'TempImageFileNames'; input.value = fn;
                container.appendChild(input);
            });
        }

        // ==========================================
        // VARIANT MANAGEMENT
        // ==========================================
        document.getElementById('addVariantBtn').addEventListener('click', function () {
            const sizes = @Html.Raw(Json.Serialize(Model.AvailableSizes));
            const colors = @Html.Raw(Json.Serialize(Model.AvailableColors));
            const packQuantities = @Html.Raw(Json.Serialize(ViewBag.AvailablePackQuantities ?? new List<dynamic>()));

            const html = '<div class="variant-card" data-variant-index="' + variantIndex + '">' +
                '<div class="variant-header"><h6 class="mb-0">Variant #' + (variantIndex + 1) + '</h6>' +
                '<button type="button" class="btn btn-sm btn-danger" onclick="removeVariant(' + variantIndex + ')"><i class="bi bi-trash"></i> Remove</button></div>' +
                '<div class="row">' +
                '<div class="col-md-3 mb-2"><label class="form-label">SKU *</label>' +
                '<input name="Variants[' + variantIndex + '].SKU" type="text" class="form-control form-control-sm" required /></div>' +
                '<div class="col-md-3 mb-2"><label class="form-label">Size</label>' +
                '<select name="Variants[' + variantIndex + '].SizeId" class="form-select form-select-sm"><option value="">-- None --</option>' +
                sizes.map(s => '<option value="' + s.value + '">' + s.text + '</option>').join('') + '</select></div>' +
                '<div class="col-md-3 mb-2"><label class="form-label">Color</label>' +
                '<select name="Variants[' + variantIndex + '].ColorId" class="form-select form-select-sm"><option value="">-- None --</option>' +
                colors.map(c => '<option value="' + c.value + '">' + c.text + '</option>').join('') + '</select></div>' +
                '<div class="col-md-3 mb-2"><label class="form-label">Pack Qty</label>' +
                '<select name="Variants[' + variantIndex + '].PackQuantityId" class="form-select form-select-sm"><option value="">-- None --</option>' +
                packQuantities.map(p => '<option value="' + p.id + '">' + p.name + '</option>').join('') + '</select></div>' +
                '<div class="col-md-4 mb-2"><label class="form-label">Price (zÅ‚) <span class="text-muted small">empty = base</span></label>' +
                '<input name="Variants[' + variantIndex + '].Price" type="number" step="0.01" min="0.01" class="form-control form-control-sm" placeholder="Base price" /></div>' +
                '<div class="col-md-4 mb-2"><label class="form-label">Stock *</label>' +
                '<input name="Variants[' + variantIndex + '].StockQuantity" type="number" min="0" class="form-control form-control-sm" value="0" required /></div>' +
                '</div></div>';
            document.getElementById('variantsContainer').insertAdjacentHTML('beforeend', html);
            variantIndex++;
        });

        function removeVariant(index) {
            const el = document.querySelector('.variant-card[data-variant-index="' + index + '"]');
            if (el) el.remove();
        }

        document.getElementById('generateVariantsBtn').addEventListener('click', function () {
            const selectedSizes = Array.from(document.querySelectorAll('.size-checkbox:checked')).map(cb => ({
                id: cb.value, name: cb.nextElementSibling ? cb.nextElementSibling.textContent.trim() : ''
            }));
            const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked')).map(cb => ({
                id: cb.value, name: cb.nextElementSibling ? cb.nextElementSibling.textContent.trim() : ''
            }));

            if (selectedSizes.length === 0 && selectedColors.length === 0) {
                alert('Select at least one size or color first.');
                return;
            }

            if (document.querySelectorAll('.variant-card').length > 0) {
                if (!confirm('Replace existing variants?')) return;
                document.getElementById('variantsContainer').innerHTML = '';
                variantIndex = 0;
            }

            const sizes = @Html.Raw(Json.Serialize(Model.AvailableSizes));
            const colors = @Html.Raw(Json.Serialize(Model.AvailableColors));
            const sizesToUse = selectedSizes.length > 0 ? selectedSizes : [{ id: '', name: '' }];
            const colorsToUse = selectedColors.length > 0 ? selectedColors : [{ id: '', name: '' }];

            sizesToUse.forEach(size => {
                colorsToUse.forEach(color => {
                    let sku = 'SKU';
                    if (size.name) sku += '-' + size.name.replace(/\s+/g, '').substring(0, 6).toUpperCase();
                    if (color.name) sku += '-' + color.name.replace(/\s+/g, '').substring(0, 4).toUpperCase();
                    sku += '-' + String(variantIndex + 1).padStart(3, '0');

                    const html = '<div class="variant-card" data-variant-index="' + variantIndex + '">' +
                        '<div class="variant-header"><h6 class="mb-0">Variant #' + (variantIndex + 1) +
                        (size.name ? ' <span class="badge bg-secondary ms-1">' + size.name + '</span>' : '') +
                        (color.name ? ' <span class="badge bg-info ms-1">' + color.name + '</span>' : '') + '</h6>' +
                        '<button type="button" class="btn btn-sm btn-danger" onclick="removeVariant(' + variantIndex + ')"><i class="bi bi-trash"></i></button></div>' +
                        '<div class="row">' +
                        '<div class="col-md-3 mb-2"><label class="form-label">SKU *</label>' +
                        '<input name="Variants[' + variantIndex + '].SKU" type="text" class="form-control form-control-sm" value="' + sku + '" required /></div>' +
                        '<div class="col-md-3 mb-2"><label class="form-label">Size</label>' +
                        '<select name="Variants[' + variantIndex + '].SizeId" class="form-select form-select-sm"><option value="">-- None --</option>' +
                        sizes.map(s => '<option value="' + s.value + '"' + (s.value == size.id ? ' selected' : '') + '>' + s.text + '</option>').join('') + '</select></div>' +
                        '<div class="col-md-3 mb-2"><label class="form-label">Color</label>' +
                        '<select name="Variants[' + variantIndex + '].ColorId" class="form-select form-select-sm"><option value="">-- None --</option>' +
                        colors.map(c => '<option value="' + c.value + '"' + (c.value == color.id ? ' selected' : '') + '>' + c.text + '</option>').join('') + '</select></div>' +
                        '<div class="col-md-3 mb-2"><label class="form-label">Price (zÅ‚)</label>' +
                        '<input name="Variants[' + variantIndex + '].Price" type="number" step="0.01" min="0.01" class="form-control form-control-sm" placeholder="Base price" /></div>' +
                        '<div class="col-md-3 mb-2"><label class="form-label">Stock *</label>' +
                        '<input name="Variants[' + variantIndex + '].StockQuantity" type="number" min="0" class="form-control form-control-sm" value="0" required /></div>' +
                        '</div></div>';
                    document.getElementById('variantsContainer').insertAdjacentHTML('beforeend', html);
                    variantIndex++;
                });
            });
            alert('Generated ' + variantIndex + ' variant(s)! Set stock quantities.');
        });

        // ==========================================
        // PRICING UPDATES
        // ==========================================
        function updatePriceInfo() {
            const basePrice = parseFloat(document.getElementById('retailPriceInput').value) || 0;
            const packSize = parseInt(document.getElementById('packSizeInput').value) || 1;
            const businessPrice = parseFloat(document.getElementById('businessPriceInput').value) || 0;

            const infoEl = document.getElementById('pricePerItemInfo');
            if (infoEl) {
                infoEl.textContent = packSize > 1 ? ('Price per item: ' + (basePrice / packSize).toFixed(2) + ' zÅ‚ (' + packSize + '-pack)') : '';
            }

            const savingsEl = document.getElementById('businessSavingsInfo');
            if (savingsEl) {
                if (businessPrice > 0 && basePrice > 0 && businessPrice < basePrice) {
                    const pct = ((1 - businessPrice / basePrice) * 100).toFixed(0);
                    savingsEl.textContent = 'B2B customers save ' + pct + '% (' + (basePrice - businessPrice).toFixed(2) + ' zÅ‚)';
                    savingsEl.style.display = 'block';
                } else {
                    savingsEl.style.display = 'none';
                }
            }
        }

        document.getElementById('retailPriceInput').addEventListener('input', updatePriceInfo);
        document.getElementById('businessPriceInput').addEventListener('input', updatePriceInfo);
        document.getElementById('packSizeInput').addEventListener('input', updatePriceInfo);

        // ==========================================
        // FORM SUBMISSION
        // ==========================================
        document.getElementById('productForm').addEventListener('submit', function (e) {
            const enName = document.querySelector('input[name="Translations[0].Name"]').value || '';
            const enDesc = document.querySelector('textarea[name="Translations[0].Description"]').value || '';
            document.getElementById('defaultName').value = enName;
            document.getElementById('defaultDescription').value = enDesc;
            updateImageHiddenInputs();

            const price = parseFloat(document.getElementById('retailPriceInput').value) || 0;
            if (price <= 0) { e.preventDefault(); alert('Enter a valid retail price > 0.'); return false; }
            if (!document.getElementById('selectedCategoryId').value) { e.preventDefault(); alert('Select a category.'); return false; }

            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Creating...';
            document.getElementById('submitBtn').disabled = true;
        });

        // ==========================================
        // CATEGORY SELECTION
        // ==========================================
        $(document).ready(function () {
            if ($.fn.DataTable) {
                $('#categoryTable').DataTable({ responsive: true, pageLength: 10, order: [[2, 'asc']], language: { search: "Search:" } });
            }
            $(document).on('click', '.select-category', function () {
                var id = $(this).data('category-id');
                var name = $(this).data('category-name');
                $('#selectedCategoryId').val(id);
                $('#selectedCategoryDisplay').html('<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>' + name + '</span>');
                $('#categoryModal').modal('hide');
            });
        });

        // ==========================================
        // CUSTOM COLORS
        // ==========================================
        let customColorHexValues = [];
        let customColorNameValues = [];

        document.getElementById('colorPicker').addEventListener('input', function (e) {
            document.getElementById('customColorHexField').value = e.target.value.substring(1).toUpperCase();
            updateColorPreview(e.target.value.substring(1));
        });

        document.getElementById('customColorHexField').addEventListener('input', function (e) {
            const hex = e.target.value.replace('#', '');
            if (hex.length === 6 && /^[0-9A-Fa-f]{6}$/.test(hex)) {
                document.getElementById('colorPicker').value = '#' + hex;
                updateColorPreview(hex);
            }
        });

        function updateColorPreview(hex) {
            const p = document.getElementById('customColorPreview');
            p.style.backgroundColor = '#' + hex;
            const r = parseInt(hex.substr(0, 2), 16), g = parseInt(hex.substr(2, 2), 16), b = parseInt(hex.substr(4, 2), 16);
            p.style.color = (r * 299 + g * 587 + b * 114) / 1000 > 128 ? '#000' : '#fff';
        }

        document.getElementById('addCustomColorBtn').addEventListener('click', function () {
            const name = document.getElementById('customColorNameField').value.trim();
            const hex = document.getElementById('customColorHexField').value.trim().toUpperCase();
            if (!name || !hex) { alert('Provide both name and hex'); return; }
            if (!/^[0-9A-F]{6}$/.test(hex)) { alert('Invalid hex code'); return; }

            customColorHexValues.push(hex);
            customColorNameValues.push(name);
            document.getElementById('customColorHexInput').value = customColorHexValues.join(',');
            document.getElementById('customColorNameInput').value = customColorNameValues.join(',');

            const r = parseInt(hex.substr(0, 2), 16), g = parseInt(hex.substr(2, 2), 16), b = parseInt(hex.substr(4, 2), 16);
            const badge = document.createElement('span');
            badge.className = 'badge me-2 mb-2';
            badge.style.backgroundColor = '#' + hex;
            badge.style.color = (r * 299 + g * 587 + b * 114) / 1000 > 128 ? '#000' : '#fff';
            badge.textContent = name;
            document.getElementById('customColorsList').appendChild(badge);

            document.getElementById('customColorNameField').value = '';
            document.getElementById('customColorHexField').value = '';
            bootstrap.Modal.getInstance(document.getElementById('customColorModal')).hide();
        });

        // ==========================================
        // AUTO TRANSLATE
        // ==========================================
        document.querySelector('input[name="Translations[0].Name"]').addEventListener('input', function () {
            document.getElementById('autoTranslateBtn').disabled = !this.value.trim();
        });

        document.getElementById('autoTranslateBtn').addEventListener('click', async function () {
            const btn = this;
            const original = btn.innerHTML;
            const nameEn = document.querySelector('input[name="Translations[0].Name"]').value.trim();
            const descEn = (document.querySelector('textarea[name="Translations[0].Description"]').value || '').trim();
            const metaDescEn = (document.querySelector('input[name="Translations[0].MetaDescription"]').value || '').trim();
            const keywordsEn = (document.querySelector('input[name="Translations[0].MetaKeywords"]').value || '').trim();

            if (!nameEn) { alert('Enter English name first.'); return; }
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Translating...';

            try {
                const res = await fetch('@Url.Action("TranslateContent", "AdminProduct")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value },
                    body: JSON.stringify({ sourceLanguage: 'en', targetLanguage: 'pl', name: nameEn, description: descEn, metaDescription: metaDescEn, metaKeywords: keywordsEn })
                });
                const data = await res.json();
                if (data.success && data.translations) {
                    if (data.translations.name) document.querySelector('input[name="Translations[1].Name"]').value = data.translations.name;
                    if (data.translations.description) document.querySelector('textarea[name="Translations[1].Description"]').value = data.translations.description;
                    if (data.translations.slug) { const s = document.querySelector('input[name="Translations[1].Slug"]'); if (s) s.value = data.translations.slug; }
                    if (data.translations.metaDescription) document.querySelector('input[name="Translations[1].MetaDescription"]').value = data.translations.metaDescription;
                    if (data.translations.metaKeywords) document.querySelector('input[name="Translations[1].MetaKeywords"]').value = data.translations.metaKeywords;
                    new bootstrap.Tab(document.getElementById('pl-tab')).show();
                    alert('Translation completed!');
                } else { alert(data.message || 'Translation failed.'); }
            } catch (err) { alert('Translation service unavailable.'); }
            finally { btn.disabled = false; btn.innerHTML = original; }
        });

        // Auto-slug
        document.getElementById('nameEn').addEventListener('input', function () {
            document.getElementById('slugEn').placeholder = this.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '') || 'auto-generated';
        });
    </script>
}
