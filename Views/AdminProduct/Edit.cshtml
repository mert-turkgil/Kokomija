@model Kokomija.Models.ViewModels.Admin.ProductUpdateDto
@using Kokomija.Models.ViewModels.Admin
@{
    ViewData["Title"] = "Edit Product";
}

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- Welcome Card -->
        <div class="welcome-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-pencil-square me-2"></i>Edit Product
                    </h2>
                    <p class="text-white-50 mb-0">Update product information, pricing, and inventory</p>
                </div>
                <a asp-action="Index" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Products
                </a>
            </div>
        </div>

        <form asp-action="Edit" method="post" id="productForm">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="StripeProductId" />
            <input type="hidden" asp-for="StripePriceId" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
            
            <div class="row">
                <!-- Left Column: Basic Info & Images -->
                <div class="col-lg-8">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information & Translations
                            </h5>

                            <!-- Translation Tabs -->
                            <div class="translation-tabs">
                                <ul class="nav nav-tabs mb-3" id="translationTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="en-tab" data-bs-toggle="tab" data-bs-target="#en" type="button" role="tab">
                                            <i class="bi bi-flag-usa"></i> English
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="pl-tab" data-bs-toggle="tab" data-bs-target="#pl" type="button" role="tab">
                                            <i class="bi bi-flag"></i> Polski
                                        </button>
                                    </li>
                                </ul>

                            <div class="tab-content" id="translationTabContent">
                            <!-- English Translation -->
                            <div class="tab-pane fade show active" id="en" role="tabpanel">
                                @{
                                    var enTranslation = Model.Translations.FirstOrDefault(t => t.CultureCode == "en-US");
                                    var enIndex = Model.Translations.IndexOf(enTranslation ?? new ProductTranslationDto { CultureCode = "en-US" });
                                    if (enIndex == -1) enIndex = 0;
                                }
                                <input type="hidden" name="Translations[@enIndex].Id" value="@(enTranslation?.Id)" />
                                <input type="hidden" name="Translations[@enIndex].CultureCode" value="en-US" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Product Name (English) *</label>
                                    <input name="Translations[@enIndex].Name" class="form-control" value="@(enTranslation?.Name ?? Model.Name)" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Description (English) *</label>
                                    <textarea name="Translations[@enIndex].Description" class="form-control" rows="5" required>@(enTranslation?.Description ?? Model.Description)</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (URL-friendly)</label>
                                        <input name="Translations[@enIndex].Slug" class="form-control" value="@(enTranslation?.Slug)" placeholder="product-name-slug" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Description</label>
                                        <input name="Translations[@enIndex].MetaDescription" class="form-control" value="@(enTranslation?.MetaDescription)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Meta Keywords</label>
                                    <input name="Translations[@enIndex].MetaKeywords" class="form-control" value="@(enTranslation?.MetaKeywords)" />
                                </div>
                            </div>

                            <!-- Polish Translation -->
                            <div class="tab-pane fade" id="pl" role="tabpanel">
                                @{
                                    var plTranslation = Model.Translations.FirstOrDefault(t => t.CultureCode == "pl-PL");
                                    var plIndex = Model.Translations.IndexOf(plTranslation ?? new ProductTranslationDto { CultureCode = "pl-PL" });
                                    if (plIndex == -1) plIndex = 1;
                                }
                                <input type="hidden" name="Translations[@plIndex].Id" value="@(plTranslation?.Id)" />
                                <input type="hidden" name="Translations[@plIndex].CultureCode" value="pl-PL" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Nazwa Produktu (Polski) *</label>
                                    <input name="Translations[@plIndex].Name" class="form-control" value="@(plTranslation?.Name ?? Model.Name)" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Opis (Polski) *</label>
                                    <textarea name="Translations[@plIndex].Description" class="form-control" rows="5" required>@(plTranslation?.Description ?? Model.Description)</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (przyjazny URL)</label>
                                        <input name="Translations[@plIndex].Slug" class="form-control" value="@(plTranslation?.Slug)" placeholder="nazwa-produktu-slug" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Opis</label>
                                        <input name="Translations[@plIndex].MetaDescription" class="form-control" value="@(plTranslation?.MetaDescription)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Słowa Kluczowe Meta</label>
                                    <input name="Translations[@plIndex].MetaKeywords" class="form-control" value="@(plTranslation?.MetaKeywords)" />
                                </div>
                            </div>
                            </div>

                            <!-- Auto-Translate Button -->
                            <div class="mt-3 p-3 bg-light rounded border">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <i class="bi bi-stars text-primary me-2"></i>
                                        <span class="text-muted">Auto-translate English content to Polish</span>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" id="autoTranslateBtn">
                                        <i class="bi bi-translate me-1"></i> Auto-Translate to Polish
                                    </button>
                                </div>
                            </div>

                            <!-- Default Fallback Values (hidden) -->
                            <input type="hidden" asp-for="Name" id="defaultName" />
                            <input type="hidden" asp-for="Description" id="defaultDescription" />
                        </div>
                    </div>

                    <!-- Pricing & Category -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-currency-dollar"></i> Pricing, Pack Size & Category
                            </h5>
                            
                            <!-- Pack Size Information -->
                            <div class="alert alert-info mb-3">
                                <i class="bi bi-info-circle"></i>
                                <strong>Product Pack Size:</strong> This product is a 
                                <strong>@Model.PackSize @(Model.PackSize == 1 ? "Single Item" : "Pack")</strong>.
                                Each pack size is its own product with its own price and Stripe entry.
                            </div>
                            
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label asp-for="PackSize" class="form-label">Pack Size *</label>
                                    <input asp-for="PackSize" type="number" min="1" max="100" class="form-control form-control-lg fw-bold" />
                                    <span asp-validation-for="PackSize" class="text-danger"></span>
                                    <small class="text-muted d-block mt-1">
                                        <i class="bi bi-box2"></i> Number of items<br/>
                                        1 = Single, 5 = 5-Pack, etc.
                                    </small>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label asp-for="Price" class="form-label">Price (zł) *</label>
                                    <input asp-for="Price" type="number" step="0.01" class="form-control form-control-lg fw-bold" />
                                    <span asp-validation-for="Price" class="text-danger"></span>
                                    <small class="text-muted">Price for this pack size. Changing price creates new Stripe price.</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="ProductGroupId" class="form-label">Product Group (Optional)</label>
                                    <select asp-for="ProductGroupId" class="form-select form-select-lg">
                                        <option value="">Create new or no group</option>
                                        @foreach (var group in (List<Kokomija.Entity.ProductGroup>)ViewBag.ProductGroups)
                                        {
                                            if (Model.ProductGroupId == group.Id)
                                            {
                                                <option value="@group.Id" selected>@group.Name</option>
                                            }
                                            else
                                            {
                                                <option value="@group.Id">@group.Name</option>
                                            }
                                        }
                                    </select>
                                    <small class="text-muted">Group related products (Single, 5-Pack, 10-Pack of same item)</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Category *</label>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#categoryModalEdit">
                                    <i class="bi bi-search"></i> Select Category
                                </button>
                                <input type="hidden" asp-for="CategoryId" id="selectedCategoryIdEdit" required />
                                <div id="selectedCategoryDisplayEdit" class="mt-2">
                                    @if (Model.CategoryId > 0)
                                    {
                                        var category = ((List<Kokomija.Entity.Category>)ViewBag.Categories).FirstOrDefault(c => c.Id == Model.CategoryId);
                                        if (category != null)
                                        {
                                            var translation = category.Translations?.FirstOrDefault(t => t.CultureCode == "en-US") ?? category.Translations?.FirstOrDefault();
                                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> @(translation?.Name ?? "Unnamed")</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">No category selected</span>
                                    }
                                </div>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Associate Coupon (Optional)</label>
                                <select asp-for="CouponId" class="form-select">
                                    <option value="">No coupon - Regular pricing</option>
                                    @if (ViewBag.Coupons != null)
                                    {
                                        @foreach (var coupon in (List<Kokomija.Entity.Coupon>)ViewBag.Coupons)
                                        {
                                            var displayText = $"{coupon.Code} - ";
                                            if (coupon.DiscountType == "percentage")
                                            {
                                                displayText += $"{coupon.DiscountValue}% off";
                                            }
                                            else
                                            {
                                                displayText += $"{coupon.DiscountValue} zł off";
                                            }
                                            
                                            if (coupon.UserId != null)
                                            {
                                                displayText += " (User-specific)";
                                            }
                                            
                                            <option value="@coupon.Id">@displayText</option>
                                        }
                                    }
                                </select>
                                <small class="text-muted">Automatically apply discount to this product</small>
                            </div>
                        </div>
                    </div>

                    <!-- Business (B2B) Pricing Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-building"></i> Business (B2B) Pricing
                            </h5>
                            
                            <div class="alert alert-info border-0 mb-3" style="background: linear-gradient(135deg, rgba(13,110,253,0.08), rgba(102,126,234,0.08));">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-info-circle-fill text-primary me-2 mt-1"></i>
                                    <div>
                                        <strong>Auto-Accept Pricing</strong>
                                        <p class="mb-0 small text-body-secondary">When you set a business price and save, it becomes the active B2B price immediately. Business customers will see this price and can place orders at this rate. No additional approval is needed.</p>
                                    </div>
                                </div>
                            </div>
                            
                            @if (Model.BusinessPrice.HasValue && Model.BusinessPrice.Value > 0)
                            {
                                <div class="alert alert-success d-flex align-items-center mb-3 py-2">
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    <div>
                                        <strong>B2B Price Active:</strong> @Model.BusinessPrice.Value.ToString("C", new System.Globalization.CultureInfo("pl-PL"))
                                        @if (Model.MinBusinessQuantity > 0)
                                        {
                                            <span class="ms-2 badge bg-primary">Min. qty: @Model.MinBusinessQuantity</span>
                                        }
                                        <span class="d-block small text-body-secondary">Business customers can order this product at the B2B price.</span>
                                    </div>
                                </div>
                            }
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsBusinessOnly" class="form-check-input" type="checkbox" id="isBusinessOnlySwitch" />
                                        <label class="form-check-label" for="isBusinessOnlySwitch">
                                            <strong>Business Only</strong> - Only visible to verified business customers
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input asp-for="IsAvailableForBusiness" class="form-check-input" type="checkbox" id="isAvailableForBusinessSwitch" />
                                        <label class="form-check-label" for="isAvailableForBusinessSwitch">
                                            <strong>Available for Business</strong> - Show to business customers
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="BusinessPrice" class="form-label">Business Price (zł)</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                                        <input asp-for="BusinessPrice" type="number" step="0.01" min="0" class="form-control" placeholder="Leave empty to use retail price" />
                                    </div>
                                    <span asp-validation-for="BusinessPrice" class="text-danger"></span>
                                    <small class="text-muted">Special discounted price for B2B customers</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="MinBusinessQuantity" class="form-label">Minimum Business Quantity</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-boxes"></i></span>
                                        <input asp-for="MinBusinessQuantity" type="number" min="0" class="form-control" />
                                    </div>
                                    <span asp-validation-for="MinBusinessQuantity" class="text-danger"></span>
                                    <small class="text-muted">Minimum order quantity for B2B (0 = no minimum)</small>
                                </div>
                            </div>
                            
                            @if (!string.IsNullOrEmpty(Model.BusinessStripePriceId))
                            {
                                <div class="alert alert-success mb-0">
                                    <i class="bi bi-stripe me-2"></i>
                                    <small>Business Stripe Price ID: @Model.BusinessStripePriceId</small>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Price History -->
                    @if (Model.PriceHistory != null && Model.PriceHistory.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-clock-history"></i> Price History
                                </h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Old Price</th>
                                            <th>New Price</th>
                                            <th>Change</th>
                                            <th>Reason</th>
                                            <th>Changed By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var history in Model.PriceHistory.OrderByDescending(h => h.ChangedAt))
                                        {
                                            var priceChange = history.NewPrice - history.OldPrice;
                                            var changePercent = history.OldPrice > 0 ? (priceChange / history.OldPrice * 100) : 0;
                                            <tr>
                                                <td><small>@history.ChangedAt.ToString("yyyy-MM-dd HH:mm")</small></td>
                                                <td>@history.OldPrice.ToString("C2")</td>
                                                <td>@history.NewPrice.ToString("C2")</td>
                                                <td>
                                                    @if (priceChange > 0)
                                                    {
                                                        <span class="badge bg-success">+@priceChange.ToString("C2") (+@changePercent.ToString("F1")%)</span>
                                                    }
                                                    else if (priceChange < 0)
                                                    {
                                                        <span class="badge bg-danger">@priceChange.ToString("C2") (@changePercent.ToString("F1")%)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">No change</span>
                                                    }
                                                </td>
                                                <td><small>@(history.Reason ?? "Manual Update")</small></td>
                                                <td><small>@(history.ChangedBy ?? "System")</small></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                    <!-- Product Images -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-images"></i> Product Images
                            </h5>
                            <!-- Existing Images -->
                            @if (Model.ExistingImageUrls.Any())
                            {
                                <div class="mb-3">
                                    <label class="form-label">Current Images</label>
                                    <div class="row g-3" id="existingImages">
                                        @foreach (var imageUrl in Model.ExistingImageUrls)
                                        {
                                            <div class="col-md-3 image-preview-item" data-url="@imageUrl">
                                                <img src="@imageUrl" alt="Product Image" />
                                                <button type="button" class="image-remove-btn" onclick="markForDeletion('@imageUrl')">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <div class="mb-3">
                                <label class="form-label">Upload New Images (Max 5MB each)</label>
                                <div class="upload-zone" id="dropZone">
                                    <input type="file" id="imageUpload" class="d-none" accept=".jpg,.jpeg,.png,.webp" multiple />
                                    <div class="upload-icon">
                                        <i class="bi bi-cloud-arrow-up"></i>
                                    </div>
                                    <h5 class="mb-2">Drop images here or click to browse</h5>
                                    <p class="text-muted small mb-0">Supports JPG, PNG, WebP (Max 5MB)</p>
                                </div>
                            </div>
                            
                            <div id="newImagePreview" class="row g-3 mt-2"></div>
                            
                            <!-- Hidden inputs -->
                            <input type="hidden" id="newImageFileNames" name="NewImageTempFileNames" />
                            <input type="hidden" id="imagesToDelete" name="ImagesToDelete" />
                        </div>
                    </div>

                    <!-- Variants Management -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-grid-3x3-gap"></i> Product Variants (@Model.Variants.Count)
                            </h5>
                            @if (Model.Variants.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Size</th>
                                                <th>Color</th>
                                                <th>SKU</th>
                                                <th>Price</th>
                                                <th>Stock</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variantsTableBody">
                                            @for (int i = 0; i < Model.Variants.Count; i++)
                                            {
                                                var variant = Model.Variants[i];
                                                <tr data-variant-id="@variant.Id" data-variant-index="@i">
                                                    <input type="hidden" name="Variants[@i].Id" value="@variant.Id" />
                                                    <td>
                                                        <select name="Variants[@i].SizeId" class="form-select form-select-sm">
                                                            <option value="">-- None --</option>
                                                            @foreach (var size in (List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableSizes)
                                                            {
                                                                var sizeSelected = variant.SizeId?.ToString() == size.Value;
                                                                if (sizeSelected)
                                                                {
                                                                    <option value="@size.Value" selected>@size.Text</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@size.Value">@size.Text</option>
                                                                }
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select name="Variants[@i].ColorId" class="form-select form-select-sm">
                                                            <option value="">-- None --</option>
                                                            @foreach (var color in (List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableColors)
                                                            {
                                                                var colorSelected = variant.ColorId?.ToString() == color.Value;
                                                                if (colorSelected)
                                                                {
                                                                    <option value="@color.Value" selected>@color.Text</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@color.Value">@color.Text</option>
                                                                }
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Variants[@i].SKU" class="form-control form-control-sm" value="@variant.SKU" required style="width: 100px;" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="Variants[@i].Price" class="form-control form-control-sm" value="@variant.Price" step="0.01" required style="width: 80px;" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="Variants[@i].StockQuantity" class="form-control form-control-sm" value="@variant.StockQuantity" required style="width: 70px;" />
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariantRow(this)" title="Remove variant">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-success btn-sm" id="addVariantBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add Variant
                                </button>
                            }
                            else
                            {
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    No variants created. Add variants for different size/color combinations.
                                </div>
                                <button type="button" class="btn btn-success" id="addVariantBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add First Variant
                                </button>
                                <div id="variantsContainer"></div>
                            }
                        </div>
                    </div>

                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-star"></i> Customer Reviews (@Model.Reviews.Count)
                                </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>User</th>
                                            <th>Rating</th>
                                            <th>Comment</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var review in Model.Reviews)
                                        {
                                            <tr id="review-@review.Id">
                                                <td>
                                                    <div>
                                                        <strong>@review.UserName</strong>
                                                        @if (review.UserIsBanned)
                                                        {
                                                            <span class="badge bg-danger ms-1">Banned</span>
                                                        }
                                                        @if (review.IsVerifiedPurchase)
                                                        {
                                                            <span class="badge bg-success ms-1">Verified</span>
                                                        }
                                                    </div>
                                                    <small class="text-muted">@review.UserEmail</small>
                                                </td>
                                                <td>
                                                    <div class="rating-stars" id="rating-display-@review.Id">
                                                        @for (int i = 0; i < (int)review.Rating; i++)
                                                        {
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        }
                                                        @if (review.Rating % 1 != 0)
                                                        {
                                                            <i class="bi bi-star-half text-warning"></i>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="review-comment" id="comment-display-@review.Id">@review.Comment</div>
                                                </td>
                                                <td>
                                                    @if (review.IsVisible)
                                                    {
                                                        <span class="badge bg-success" id="visibility-badge-@review.Id">Visible</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary" id="visibility-badge-@review.Id">Hidden</span>
                                                    }
                                                </td>
                                                <td>
                                                    <small>@review.CreatedAt.ToString("MMM dd, yyyy")</small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-info" 
                                                                onclick="openEditReviewModal(@review.Id, @((int)review.Rating), '@System.Net.WebUtility.HtmlEncode(review.Comment?.Replace("'", "\\'") ?? "")')" 
                                                                title="Edit Review">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-primary" onclick="toggleReviewVisibility(@review.Id)" title="Toggle Visibility">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <a asp-controller="AdminUser" asp-action="Edit" asp-route-id="@review.UserId" class="btn btn-outline-warning" title="Manage User">
                                                            <i class="bi bi-person"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-outline-danger" onclick="deleteReview(@review.Id)" title="Delete Review">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            </div>
                        </div>
                </div>

                <!-- Right Column: Status & Actions -->
                <div class="col-lg-4">
                    <!-- Status -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-toggle-on"></i> Status
                            </h5>
                            <div class="form-check form-switch mb-3">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                <label class="form-check-label" asp-for="IsActive">
                                    Active (visible to customers)
                                </label>
                            </div>
                            
                            <div class="alert alert-info">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>Stripe Product ID:</strong><br/>
                                    <code>@Model.StripeProductId</code>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- B2B Business Settings -->
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-building"></i> Business (B2B) Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input asp-for="IsBusinessOnly" class="form-check-input" type="checkbox" id="isBusinessOnly" onchange="updateBusinessFields()" />
                                <label class="form-check-label" asp-for="IsBusinessOnly">
                                    <strong>Business Only</strong>
                                    <small class="d-block text-muted">Only visible to verified business customers</small>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input asp-for="IsAvailableForBusiness" class="form-check-input" type="checkbox" id="isAvailableForBusiness" />
                                <label class="form-check-label" asp-for="IsAvailableForBusiness">
                                    <strong>Available for Business</strong>
                                    <small class="d-block text-muted">Allow business customers to purchase</small>
                                </label>
                            </div>

                            <hr />

                            <div class="mb-3">
                                <label asp-for="MinBusinessQuantity" class="form-label">
                                    <i class="bi bi-box-seam"></i> Minimum Business Quantity
                                </label>
                                <input asp-for="MinBusinessQuantity" type="number" min="0" class="form-control" />
                                <small class="text-muted">Minimum order quantity for business customers (0 = no minimum)</small>
                                <span asp-validation-for="MinBusinessQuantity" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="BusinessPrice" class="form-label">
                                    <i class="bi bi-currency-dollar"></i> Business Price (zł)
                                </label>
                                <input asp-for="BusinessPrice" type="number" step="0.01" min="0" class="form-control" placeholder="Leave empty to use retail price" />
                                <small class="text-muted">Special wholesale price for business customers</small>
                                <span asp-validation-for="BusinessPrice" class="text-danger"></span>
                            </div>

                            @if (Model.BusinessPrice.HasValue && Model.BusinessPrice < Model.Price)
                            {
                                var savings = Model.Price - Model.BusinessPrice.Value;
                                var savingsPercent = (savings / Model.Price) * 100;
                                <div class="alert alert-success">
                                    <i class="bi bi-graph-down-arrow me-1"></i>
                                    <strong>Business Discount:</strong> @savingsPercent.ToString("F1")% off retail price
                                    <br/>
                                    <small>Retail: @Model.Price.ToString("C") → Business: @Model.BusinessPrice.Value.ToString("C")</small>
                                </div>
                            }

                            <div class="alert alert-info small">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>B2B Features:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Business customers must verify their NIP number</li>
                                    <li>Business-only products are hidden from regular customers</li>
                                    <li>Business price takes priority when customer is in business mode</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Coupons -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-ticket-perforated"></i> Product Coupons</h5>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createCouponModal">
                                <i class="bi bi-plus-lg"></i> Add
                            </button>
                        </div>
                        <div class="card-body p-0" id="couponsContainer">
                            @if (ViewBag.ProductCoupons != null && ((List<Kokomija.Entity.Coupon>)ViewBag.ProductCoupons).Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var coupon in (List<Kokomija.Entity.Coupon>)ViewBag.ProductCoupons)
                                    {
                                        <div class="list-group-item coupon-item" data-coupon-id="@coupon.Id">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center gap-2 mb-1">
                                                        <h6 class="mb-0 fw-bold">@coupon.Code</h6>
                                                        @if(coupon.IsActive)
                                                        {
                                                            <span class="badge bg-success">Active</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Inactive</span>
                                                        }
                                                    </div>
                                                    <small class="text-primary fw-semibold">
                                                        @if(coupon.DiscountType == "percentage") 
                                                        { 
                                                            <span>@coupon.DiscountValue.ToString("0")% Off</span> 
                                                        }
                                                        else 
                                                        { 
                                                            <span>@coupon.DiscountValue.ToString("C") Off</span> 
                                                        }
                                                    </small>
                                                    <div class="mt-1">
                                                        <small class="text-muted">
                                                            @if(coupon.ValidUntil.HasValue)
                                                            {
                                                                <i class="bi bi-calendar-event me-1"></i>
                                                                <span>Expires: @coupon.ValidUntil.Value.ToString("MMM dd, yyyy")</span>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-infinity me-1"></i>
                                                                <span>No expiration</span>
                                                            }
                                                        </small>
                                                        @if(coupon.UsageLimit.HasValue)
                                                        {
                                                            <br/>
                                                            <small class="text-muted">
                                                                <i class="bi bi-people me-1"></i>
                                                                <span>Used: @coupon.UsageCount / @coupon.UsageLimit</span>
                                                            </small>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            onclick="openEditCouponModal(@coupon.Id)" 
                                                            title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-info" 
                                                            onclick="toggleCoupon(@coupon.Id)" 
                                                            title="@(coupon.IsActive ? "Disable" : "Enable")">
                                                        <i class="bi bi-@(coupon.IsActive ? "pause" : "play")"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            onclick="deleteCoupon(@coupon.Id)" 
                                                            title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="p-4 text-center text-muted">
                                    <i class="bi bi-ticket-perforated fs-1 mb-2 d-block opacity-50"></i>
                                    <small>No coupons created for this product.</small>
                                    <br/>
                                    <small>Click "Add" to create a product-specific discount.</small>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Product Info
                            </h6>
                            <small class="text-muted">
                                <div class="mb-2">
                                    <i class="bi bi-grid-3x3-gap me-1"></i>
                                    <strong>Variants:</strong> @Model.Variants.Count
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-star me-1"></i>
                                    <strong>Reviews:</strong> @Model.Reviews.Count
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-images me-1"></i>
                                    <strong>Images:</strong> @Model.ExistingImageUrls.Count
                                </div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 bg-body-tertiary p-3 rounded-3 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> Update Product
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Category Selection Modal -->
<div class="modal fade" id="categoryModalEdit" tabindex="-1" aria-labelledby="categoryModalEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalEditLabel">
                    <i class="bi bi-grid-3x3-gap"></i> Select Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table id="categoryTableEdit" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Display Order</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in (List<Kokomija.Entity.Category>)ViewBag.Categories)
                        {
                            var translation = category.Translations?.FirstOrDefault(t => t.CultureCode == "en-US") 
                                ?? category.Translations?.FirstOrDefault();
                            var categoryName = translation?.Name ?? category.Name ?? "Unnamed";
                            <tr>
                                <td>@categoryName</td>
                                <td>
                                    @if (category.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                                <td>@category.DisplayOrder</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary select-category-edit" 
                                            data-category-id="@category.Id" 
                                            data-category-name="@categoryName">
                                        Select
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Coupon Modal -->
<div class="modal fade" id="createCouponModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Product Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createCouponForm">
                    <input type="hidden" name="ProductId" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" class="form-control" name="Code" required style="text-transform: uppercase;">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="DiscountType">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed_amount">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Value</label>
                            <input type="number" class="form-control" name="DiscountValue" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valid Until (Optional)</label>
                        <input type="date" class="form-control" name="ValidUntil">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Usage Limit (Optional)</label>
                        <input type="number" class="form-control" name="UsageLimit" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCoupon()">Create Coupon</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCouponForm">
                    <input type="hidden" name="Id" id="editCouponId" />
                    <div class="mb-3">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" class="form-control" id="editCouponCode" readonly disabled>
                        <small class="text-muted">Code cannot be changed after creation.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount</label>
                        <input type="text" class="form-control" id="editCouponDiscount" readonly disabled>
                        <small class="text-muted">Discount cannot be changed (Stripe limitation). Delete and recreate if needed.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" name="Description" id="editCouponDescription" placeholder="Internal notes about this coupon">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Minimum Order Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="MinimumOrderAmount" id="editMinOrderAmount" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <small class="text-muted">Leave empty for no minimum.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Maximum Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="MaximumDiscountAmount" id="editMaxDiscount" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <small class="text-muted">Cap for percentage discounts.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valid Until</label>
                        <input type="datetime-local" class="form-control" name="ValidUntil" id="editCouponValidUntil">
                        <small class="text-muted">Leave empty for no expiration.</small>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Total Usage Limit</label>
                            <input type="number" class="form-control" name="UsageLimit" id="editCouponUsageLimit" min="1" placeholder="Unlimited">
                            <small class="text-muted">Max total uses.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Per-User Limit</label>
                            <input type="number" class="form-control" name="UsageLimitPerUser" id="editUsageLimitPerUser" min="1" placeholder="Unlimited">
                            <small class="text-muted">Max uses per user.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editCouponActive" checked>
                            <label class="form-check-label" for="editCouponActive">
                                <strong>Active</strong> - Coupon can be used at checkout
                            </label>
                        </div>
                        <small class="text-muted">Deactivating will also disable the Stripe PromotionCode.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCoupon()">
                    <i class="bi bi-cloud-arrow-up"></i> Save & Sync with Stripe
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--bs-border-color);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--bs-body-bg);
            cursor: pointer;
            position: relative;
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--bs-primary);
            background: rgba(var(--bs-primary-rgb), 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--bs-primary);
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        
        /* Existing styles */
        .image-preview-item {
            position: relative;
        }
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .review-comment {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .variant-card {
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bs-tertiary-bg);
        }
        [data-bs-theme="dark"] .variant-card {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Edit Review Modal Styles */
        .star-rating-input {
            display: flex;
            gap: 0.5rem;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }
        .star-rating-input input {
            display: none;
        }
        .star-rating-input label {
            cursor: pointer;
            font-size: 2rem;
            color: #ccc;
            transition: color 0.2s;
        }
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label,
        .star-rating-input input:checked ~ label {
            color: #ffc107;
        }
    </style>
}

<!-- Edit Review Modal -->
<div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editReviewModalLabel">
                    <i class="bi bi-pencil-square me-2"></i>Edit Review
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editReviewId" />
                
                <div class="mb-4">
                    <label class="form-label fw-bold">Rating</label>
                    <div class="star-rating-input">
                        <input type="radio" id="star5" name="editRating" value="5" /><label for="star5" title="5 stars"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star4" name="editRating" value="4" /><label for="star4" title="4 stars"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star3" name="editRating" value="3" /><label for="star3" title="3 stars"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star2" name="editRating" value="2" /><label for="star2" title="2 stars"><i class="bi bi-star-fill"></i></label>
                        <input type="radio" id="star1" name="editRating" value="1" /><label for="star1" title="1 star"><i class="bi bi-star-fill"></i></label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="editReviewComment" class="form-label fw-bold">Comment</label>
                    <textarea class="form-control" id="editReviewComment" rows="4" placeholder="Enter review comment..."></textarea>
                </div>
                
                <div class="alert alert-warning mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <small>Editing customer reviews may affect trust. Use responsibly for moderation purposes only.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveReviewChanges()">
                    <i class="bi bi-check-lg me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let newImageFileNames = [];
        let imagesToDelete = [];

        async function createCoupon() {
            const form = document.getElementById('createCouponForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Convert types
            data.ProductId = parseInt(data.ProductId);
            data.DiscountValue = parseFloat(data.DiscountValue);
            if(data.UsageLimit) data.UsageLimit = parseInt(data.UsageLimit);
            if(!data.ValidUntil) data.ValidUntil = null;

            try {
                const response = await fetch('@Url.Action("CreateCoupon")', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() 
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if(result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error creating coupon');
            }
        }

        async function deleteCoupon(id) {
            if(!confirm('Delete this coupon? This will also remove it from Stripe.')) return;
            
            try {
                const response = await fetch(`@Url.Action("DeleteCoupon")?id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });
                
                const result = await response.json();
                if(result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error deleting coupon');
            }
        }

        async function toggleCoupon(id) {
            try {
                const response = await fetch(`@Url.Action("ToggleCoupon")?id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });
                
                const result = await response.json();
                if(result.success) {
                    alert('Coupon status updated. Synced with Stripe.');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error toggling coupon status');
            }
        }

        async function openEditCouponModal(id) {
            try {
                const response = await fetch(`@Url.Action("GetCoupon")?id=${id}`);
                const result = await response.json();
                
                if(result.success) {
                    const coupon = result.coupon;
                    
                    document.getElementById('editCouponId').value = coupon.id;
                    document.getElementById('editCouponCode').value = coupon.code;
                    
                    // Display discount (read-only)
                    const discountText = coupon.discountType === 'percentage' 
                        ? coupon.discountValue + '%' 
                        : '$' + coupon.discountValue.toFixed(2);
                    document.getElementById('editCouponDiscount').value = discountText;
                    
                    document.getElementById('editCouponDescription').value = coupon.description || '';
                    document.getElementById('editMinOrderAmount').value = coupon.minimumOrderAmount || '';
                    document.getElementById('editMaxDiscount').value = coupon.maximumDiscountAmount || '';
                    
                    // Handle datetime
                    if (coupon.validUntil) {
                        const date = new Date(coupon.validUntil);
                        date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                        document.getElementById('editCouponValidUntil').value = date.toISOString().slice(0, 16);
                    } else {
                        document.getElementById('editCouponValidUntil').value = '';
                    }
                    
                    document.getElementById('editCouponUsageLimit').value = coupon.usageLimit || '';
                    document.getElementById('editUsageLimitPerUser').value = coupon.usageLimitPerUser || '';
                    document.getElementById('editCouponActive').checked = coupon.isActive;
                    
                    const modal = new bootstrap.Modal(document.getElementById('editCouponModal'));
                    modal.show();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error loading coupon data');
            }
        }

        async function updateCoupon() {
            const data = {
                Id: parseInt(document.getElementById('editCouponId').value),
                Description: document.getElementById('editCouponDescription').value || null,
                MinimumOrderAmount: document.getElementById('editMinOrderAmount').value ? parseFloat(document.getElementById('editMinOrderAmount').value) : null,
                MaximumDiscountAmount: document.getElementById('editMaxDiscount').value ? parseFloat(document.getElementById('editMaxDiscount').value) : null,
                ValidUntil: document.getElementById('editCouponValidUntil').value ? new Date(document.getElementById('editCouponValidUntil').value).toISOString() : null,
                UsageLimit: document.getElementById('editCouponUsageLimit').value ? parseInt(document.getElementById('editCouponUsageLimit').value) : null,
                UsageLimitPerUser: document.getElementById('editUsageLimitPerUser').value ? parseInt(document.getElementById('editUsageLimitPerUser').value) : null,
                IsActive: document.getElementById('editCouponActive').checked
            };

            try {
                const response = await fetch('@Url.Action("UpdateCoupon")', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() 
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if(result.success) {
                    alert('Coupon updated successfully! Changes synced with Stripe.');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error updating coupon');
            }
        }

        // Mark existing image for deletion
        function markForDeletion(imageUrl) {
            if (!confirm('Remove this image?')) return;
            
            imagesToDelete.push(imageUrl);
            document.querySelector(`.image-preview-item[data-url="${imageUrl}"]`).remove();
            updateHiddenInputs();
        }

        // Upload new images
        // Upload new images logic
        const dropZone = document.getElementById('dropZone');
        const imageUpload = document.getElementById('imageUpload');

        // Drag & Drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
        });

        dropZone.addEventListener('drop', e => {
            handleFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => imageUpload.click());

        imageUpload.addEventListener('change', e => {
            handleFiles(e.target.files);
            e.target.value = '';
        });

        async function handleFiles(files) {
            files = Array.from(files);
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Max size is 5MB.`);
                    continue;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('@Url.Action("UploadImage")', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        newImageFileNames.push(result.tempFileName);
                        addNewImagePreview(result.tempUrl, result.tempFileName);
                        updateHiddenInputs();
                    } else {
                        alert('Failed to upload: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload error occurred');
                }
            }
        }

        function addNewImagePreview(url, fileName) {
            const html = `
                <div class="col-md-3 image-preview-item" data-filename="${fileName}">
                    <img src="${url}" alt="New Image" />
                    <button type="button" class="image-remove-btn" onclick="removeNewImage('${fileName}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            document.getElementById('newImagePreview').insertAdjacentHTML('beforeend', html);
        }

        async function removeNewImage(fileName) {
            if (!confirm('Remove this image?')) return;

            try {
                await fetch('@Url.Action("CancelUpload")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tempFileNames: [fileName] })
                });

                newImageFileNames = newImageFileNames.filter(f => f !== fileName);
                document.querySelector(`#newImagePreview .image-preview-item[data-filename="${fileName}"]`).remove();
                updateHiddenInputs();
            } catch (error) {
                console.error('Error removing image:', error);
            }
        }

        function updateHiddenInputs() {
            document.getElementById('newImageFileNames').value = newImageFileNames.join(',');
            document.getElementById('imagesToDelete').value = imagesToDelete.join(',');
        }

        // Review management functions
        async function toggleReviewVisibility(reviewId) {
            try {
                const response = await fetch(`@Url.Action("ReviewToggleVisibility", "AdminUser")?id=${reviewId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (result.message || 'Failed to toggle visibility'));
                }
            } catch (error) {
                console.error('Error toggling visibility:', error);
                alert('Error toggling review visibility');
            }
        }

        async function deleteReview(reviewId) {
            if (!confirm('Delete this review permanently?')) return;

            try {
                const response = await fetch(`@Url.Action("ReviewDelete", "AdminUser")?id=${reviewId}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById(`review-${reviewId}`).remove();
                    showToast('Review deleted successfully', 'success');
                } else {
                    alert('Error: ' + (result.message || 'Failed to delete review'));
                }
            } catch (error) {
                console.error('Error deleting review:', error);
                alert('Error deleting review');
            }
        }

        // Edit review functions
        function openEditReviewModal(reviewId, rating, comment) {
            document.getElementById('editReviewId').value = reviewId;
            document.getElementById('editReviewComment').value = comment;
            
            // Set the rating radio button
            const ratingInput = document.querySelector(`input[name="editRating"][value="${rating}"]`);
            if (ratingInput) {
                ratingInput.checked = true;
            }
            
            // Open modal
            const modal = new bootstrap.Modal(document.getElementById('editReviewModal'));
            modal.show();
        }

        async function saveReviewChanges() {
            const reviewId = document.getElementById('editReviewId').value;
            const comment = document.getElementById('editReviewComment').value;
            const ratingInput = document.querySelector('input[name="editRating"]:checked');
            
            if (!ratingInput) {
                alert('Please select a rating');
                return;
            }
            
            const rating = parseInt(ratingInput.value);
            
            try {
                const response = await fetch('@Url.Action("ReviewUpdate", "AdminUser")', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({ 
                        id: parseInt(reviewId), 
                        rating: rating, 
                        comment: comment 
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update the UI without reloading
                    const ratingDisplay = document.getElementById(`rating-display-${reviewId}`);
                    if (ratingDisplay) {
                        let starsHtml = '';
                        for (let i = 0; i < rating; i++) {
                            starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
                        }
                        ratingDisplay.innerHTML = starsHtml;
                    }
                    
                    const commentDisplay = document.getElementById(`comment-display-${reviewId}`);
                    if (commentDisplay) {
                        commentDisplay.textContent = comment;
                    }
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('editReviewModal')).hide();
                    
                    // Show success message
                    showToast('Review updated successfully', 'success');
                } else {
                    alert('Failed to update review: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating review:', error);
                alert('Error updating review');
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                toastContainer.style.zIndex = '1100';
                document.body.appendChild(toastContainer);
            }
            
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastEl = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        // Sync default Name/Description from English translation for backwards compatibility
        document.getElementById('productForm').addEventListener('submit', function() {
            const enName = document.querySelector('input[name="Translations[0].Name"]');
            const enDesc = document.querySelector('textarea[name="Translations[0].Description"]');
            if (enName && enDesc) {
                document.getElementById('defaultName').value = enName.value;
                document.getElementById('defaultDescription').value = enDesc.value;
            }
        });

        // === Translation Tab URL Sync ===
        // Update URL when switching translation tabs for direct linking
        document.querySelectorAll('#translationTabs .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                const tabId = e.target.getAttribute('id').replace('-tab', '');
                const url = new URL(window.location);
                url.searchParams.set('lang', tabId);
                window.history.pushState({}, '', url);
            });
        });

        // Restore tab from URL on page load
        (function() {
            const url = new URL(window.location);
            const lang = url.searchParams.get('lang');
            if (lang) {
                const tabEl = document.querySelector(`#${lang}-tab`);
                if (tabEl) {
                    const tab = new bootstrap.Tab(tabEl);
                    tab.show();
                }
            }
        })();

        // === Category DataTables for Edit ===
        $(document).ready(function() {
            const categoryTableEdit = $('#categoryTableEdit').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[2, 'asc']], // Sort by Display Order
                language: {
                    search: "Search categories:",
                    lengthMenu: "Show _MENU_ categories",
                    info: "Showing _START_ to _END_ of _TOTAL_ categories",
                    emptyTable: "No categories available"
                }
            });

            // Category selection handler for Edit
            $(document).on('click', '.select-category-edit', function() {
                const categoryId = $(this).data('category-id');
                const categoryName = $(this).data('category-name');
                
                $('#selectedCategoryIdEdit').val(categoryId);
                $('#selectedCategoryDisplayEdit').html(
                    `<span class="badge bg-success"><i class="bi bi-check-circle"></i> ${categoryName}</span>`
                );
                
                $('#categoryModalEdit').modal('hide');
            });
        });

        // === Variant Management ===
        let variantIndex = @Model.Variants.Count;
        const sizes = @Html.Raw(Json.Serialize(ViewBag.AvailableSizes));
        const colors = @Html.Raw(Json.Serialize(ViewBag.AvailableColors));
        const packQuantities = @Html.Raw(Json.Serialize(ViewBag.AvailablePackQuantities ?? new List<dynamic>()));

        document.getElementById('addVariantBtn')?.addEventListener('click', function() {
            const existingTable = document.getElementById('variantsTableBody');
            
            if (existingTable) {
                // Add new row to existing table
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-variant-index', variantIndex);
                newRow.innerHTML = `
                    <input type="hidden" name="Variants[${variantIndex}].Id" value="" />
                    <td>
                        <select name="Variants[${variantIndex}].SizeId" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            ${sizes.map(s => `<option value="${s.value}">${s.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select name="Variants[${variantIndex}].ColorId" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            ${colors.map(c => `<option value="${c.value}">${c.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select name="Variants[${variantIndex}].PackQuantityId" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            ${packQuantities.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="Variants[${variantIndex}].SKU" class="form-control form-control-sm" required style="width: 100px;" placeholder="SKU-001" />
                    </td>
                    <td>
                        <input type="number" name="Variants[${variantIndex}].Price" class="form-control form-control-sm" step="0.01" required style="width: 80px;" value="@Model.Price" />
                    </td>
                    <td>
                        <input type="number" name="Variants[${variantIndex}].StockQuantity" class="form-control form-control-sm" required style="width: 70px;" value="100" />
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariantRow(this)" title="Remove variant">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                existingTable.appendChild(newRow);
            } else {
                // Create first variant with card layout (when no variants exist)
                const container = document.getElementById('variantsContainer');
                if (container) {
                    const variantHtml = `
                        <div class="variant-card mt-3" data-variant-index="${variantIndex}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">New Variant #${variantIndex + 1}</h6>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeVariantCard(${variantIndex})">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                            <input type="hidden" name="Variants[${variantIndex}].Id" value="" />
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Size</label>
                                    <select name="Variants[${variantIndex}].SizeId" class="form-select form-select-sm">
                                        <option value="">-- Optional --</option>
                                        ${sizes.map(s => `<option value="${s.value}">${s.text}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Color</label>
                                    <select name="Variants[${variantIndex}].ColorId" class="form-select form-select-sm">
                                        <option value="">-- Optional --</option>
                                        ${colors.map(c => `<option value="${c.value}">${c.text}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Pack Quantity</label>
                                    <select name="Variants[${variantIndex}].PackQuantityId" class="form-select form-select-sm">
                                        <option value="">-- Optional --</option>
                                        ${packQuantities.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">SKU *</label>
                                    <input name="Variants[${variantIndex}].SKU" type="text" class="form-control form-control-sm" required placeholder="SKU-001" />
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Price (zł) *</label>
                                    <input name="Variants[${variantIndex}].Price" type="number" step="0.01" class="form-control form-control-sm" required value="@Model.Price" />
                                </div>
                                <div class="col-md-3 mb-2">
                                    <label class="form-label">Stock *</label>
                                    <input name="Variants[${variantIndex}].StockQuantity" type="number" class="form-control form-control-sm" required value="100" />
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', variantHtml);
                }
            }
            
            variantIndex++;
        });

        function removeVariantRow(button) {
            const row = button.closest('tr');
            if (confirm('Remove this variant?')) {
                row.remove();
                // Re-index remaining variants
                reindexVariants();
            }
        }

        function removeVariantCard(index) {
            const card = document.querySelector(`.variant-card[data-variant-index="${index}"]`);
            if (card && confirm('Remove this variant?')) {
                card.remove();
            }
        }

        function reindexVariants() {
            const tbody = document.getElementById('variantsTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                row.setAttribute('data-variant-index', idx);
                row.querySelectorAll('input, select').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        input.setAttribute('name', name.replace(/\[\d+\]/, `[${idx}]`));
                    }
                });
            });
            variantIndex = rows.length;
        }

        // B2B Business Settings Logic
        function updateBusinessFields() {
            const isBusinessOnlyEl = document.getElementById('isBusinessOnlySwitch');
            const isAvailableForBusinessEl = document.getElementById('isAvailableForBusinessSwitch');
            
            if (isBusinessOnlyEl && isAvailableForBusinessEl) {
                if (isBusinessOnlyEl.checked) {
                    // If Business Only is checked, it should be available for business
                    isAvailableForBusinessEl.checked = true;
                    isAvailableForBusinessEl.disabled = true;
                } else {
                    isAvailableForBusinessEl.disabled = false;
                }
            }
        }

        // === AUTO-TRANSLATE FUNCTIONALITY ===
        document.getElementById('autoTranslateBtn').addEventListener('click', async function() {
            const btn = document.getElementById('autoTranslateBtn');
            const originalHtml = btn.innerHTML;
            
            // Determine active tab
            const enTabContent = document.getElementById('en');
            // Check if English tab is active
            const isEnActive = enTabContent.classList.contains('active');
            
            const sourceContainerId = isEnActive ? 'en' : 'pl';
            const targetContainerId = isEnActive ? 'pl' : 'en';
            
            const sourceLangCode = 'autodetect'; // Auto-detect source language
            const targetLangCode = isEnActive ? 'pl' : 'en';
            
            // Get Source Values
            const sourceContainer = document.getElementById(sourceContainerId);
            const nameVal = sourceContainer.querySelector('input[name*=".Name"]').value;
            const descVal = sourceContainer.querySelector('textarea[name*=".Description"]').value;
            const metaDescVal = sourceContainer.querySelector('input[name*=".MetaDescription"]').value;
            const keywordsVal = sourceContainer.querySelector('input[name*=".MetaKeywords"]').value;
            
            if (!nameVal) {
                alert(`Please enter ${isEnActive ? 'English' : 'Polish'} name first.`);
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Translating...';
            
            try {
                const response = await fetch('@Url.Action("TranslateContent", "AdminProduct")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: JSON.stringify({
                        sourceLanguage: sourceLangCode,
                        targetLanguage: targetLangCode,
                        name: nameVal,
                        description: descVal,
                        metaDescription: metaDescVal,
                        metaKeywords: keywordsVal
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.translations) {
                    const targetContainer = document.getElementById(targetContainerId);
                    
                    // Helper to safely set value
                    const setValue = (selector, val) => {
                        const el = targetContainer.querySelector(selector);
                        if (el && val) el.value = val;
                    };
                    
                    if (data.translations.name) setValue('input[name*=".Name"]', data.translations.name);
                    if (data.translations.description) setValue('textarea[name*=".Description"]', data.translations.description);
                    if (data.translations.slug) setValue('input[name*=".Slug"]', data.translations.slug);
                    if (data.translations.metaDescription) setValue('input[name*=".MetaDescription"]', data.translations.metaDescription);
                    if (data.translations.metaKeywords) setValue('input[name*=".MetaKeywords"]', data.translations.metaKeywords);
                    
                    // Switch to Target tab to show results
                    const targetTabBtn = document.getElementById(`${targetContainerId}-tab`);
                    if (targetTabBtn) {
                        const tab = new bootstrap.Tab(targetTabBtn);
                        tab.show();
                    }
                    
                    const targetLangName = isEnActive ? 'Polish' : 'English';
                    alert(`Translation to ${targetLangName} completed!`);
                } else {
                    alert(data.message || 'Translation failed.');
                }
            } catch (error) {
                console.error('Translation error:', error);
                alert('Translation service unavailable.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
        
        // Update Button Text on Tab Change
        const tabEls = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabEls.forEach(tabEl => {
            tabEl.addEventListener('shown.bs.tab', event => {
                const targetId = event.target.getAttribute('data-bs-target').replace('#', '');
                const btn = document.getElementById('autoTranslateBtn');
                const label = btn.closest('.d-flex').querySelector('span.text-muted');
                
                if (targetId === 'en') {
                    btn.innerHTML = '<i class="bi bi-translate me-1"></i> Auto-Translate to Polish';
                    if(label) label.textContent = 'Auto-translate English content to Polish';
                } else if (targetId === 'pl') {
                    btn.innerHTML = '<i class="bi bi-translate me-1"></i> Auto-Translate to English';
                    if(label) label.textContent = 'Auto-translate Polish content to English';
                }
            });
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateBusinessFields();
            
            // Add listener for business only checkbox
            const isBusinessOnlyEl = document.getElementById('isBusinessOnlySwitch');
            if (isBusinessOnlyEl) {
                isBusinessOnlyEl.addEventListener('change', updateBusinessFields);
            }
        });
    </script>
}
