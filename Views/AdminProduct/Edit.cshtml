@model Kokomija.Models.ViewModels.Admin.ProductUpdateDto
@using Kokomija.Models.ViewModels.Admin
@{
    ViewData["Title"] = "Edit Product";
}

<div class="admin-dashboard">
    <div class="container-fluid">
        <!-- Welcome Card -->
        <div class="welcome-card mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-pencil-square me-2"></i>Edit Product
                    </h2>
                    <p class="text-white-50 mb-0">Update product information, pricing, and inventory</p>
                </div>
                <a asp-action="Index" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> Back to Products
                </a>
            </div>
        </div>

        <form asp-action="Edit" method="post" id="productForm">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="StripeProductId" />
            <input type="hidden" asp-for="StripePriceId" />
            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
            
            <div class="row">
                <!-- Left Column: Basic Info & Images -->
                <div class="col-lg-8">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Basic Information & Translations
                            </h5>

                            <!-- Translation Tabs -->
                            <div class="translation-tabs">
                                <ul class="nav nav-tabs mb-3" id="translationTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="en-tab" data-bs-toggle="tab" data-bs-target="#en" type="button" role="tab">
                                            <i class="bi bi-flag-usa"></i> English
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="pl-tab" data-bs-toggle="tab" data-bs-target="#pl" type="button" role="tab">
                                            <i class="bi bi-flag"></i> Polski
                                        </button>
                                    </li>
                                </ul>

                            <div class="tab-content" id="translationTabContent">
                            <!-- English Translation -->
                            <div class="tab-pane fade show active" id="en" role="tabpanel">
                                @{
                                    var enTranslation = Model.Translations.FirstOrDefault(t => t.CultureCode == "en-US");
                                    var enIndex = Model.Translations.IndexOf(enTranslation ?? new ProductTranslationDto { CultureCode = "en-US" });
                                    if (enIndex == -1) enIndex = 0;
                                }
                                <input type="hidden" name="Translations[@enIndex].Id" value="@(enTranslation?.Id)" />
                                <input type="hidden" name="Translations[@enIndex].CultureCode" value="en-US" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Product Name (English) *</label>
                                    <input name="Translations[@enIndex].Name" class="form-control" value="@(enTranslation?.Name ?? Model.Name)" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Description (English) *</label>
                                    <textarea name="Translations[@enIndex].Description" class="form-control" rows="5" required>@(enTranslation?.Description ?? Model.Description)</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (URL-friendly)</label>
                                        <input name="Translations[@enIndex].Slug" class="form-control" value="@(enTranslation?.Slug)" placeholder="product-name-slug" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Description</label>
                                        <input name="Translations[@enIndex].MetaDescription" class="form-control" value="@(enTranslation?.MetaDescription)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Meta Keywords</label>
                                    <input name="Translations[@enIndex].MetaKeywords" class="form-control" value="@(enTranslation?.MetaKeywords)" />
                                </div>
                            </div>

                            <!-- Polish Translation -->
                            <div class="tab-pane fade" id="pl" role="tabpanel">
                                @{
                                    var plTranslation = Model.Translations.FirstOrDefault(t => t.CultureCode == "pl-PL");
                                    var plIndex = Model.Translations.IndexOf(plTranslation ?? new ProductTranslationDto { CultureCode = "pl-PL" });
                                    if (plIndex == -1) plIndex = 1;
                                }
                                <input type="hidden" name="Translations[@plIndex].Id" value="@(plTranslation?.Id)" />
                                <input type="hidden" name="Translations[@plIndex].CultureCode" value="pl-PL" />
                                
                                <div class="mb-3">
                                    <label class="form-label">Nazwa Produktu (Polski) *</label>
                                    <input name="Translations[@plIndex].Name" class="form-control" value="@(plTranslation?.Name ?? Model.Name)" required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Opis (Polski) *</label>
                                    <textarea name="Translations[@plIndex].Description" class="form-control" rows="5" required>@(plTranslation?.Description ?? Model.Description)</textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Slug (przyjazny URL)</label>
                                        <input name="Translations[@plIndex].Slug" class="form-control" value="@(plTranslation?.Slug)" placeholder="nazwa-produktu-slug" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Meta Opis</label>
                                        <input name="Translations[@plIndex].MetaDescription" class="form-control" value="@(plTranslation?.MetaDescription)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Słowa Kluczowe Meta</label>
                                    <input name="Translations[@plIndex].MetaKeywords" class="form-control" value="@(plTranslation?.MetaKeywords)" />
                                </div>
                            </div>
                            </div>

                            <!-- Default Fallback Values (hidden) -->
                            <input type="hidden" asp-for="Name" id="defaultName" />
                            <input type="hidden" asp-for="Description" id="defaultDescription" />
                        </div>
                    </div>

                    <!-- Pricing & Category -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-currency-dollar"></i> Pricing, Category & Options
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label asp-for="Price" class="form-label">Price (zł) *</label>
                                    <input asp-for="Price" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="Price" class="text-danger"></span>
                                    <small class="text-muted">Changing price will create new Stripe price</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label asp-for="PackSize" class="form-label">Pack Size *</label>
                                    <input asp-for="PackSize" type="number" class="form-control" />
                                    <span asp-validation-for="PackSize" class="text-danger"></span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Product Group</label>
                                    <select asp-for="ProductGroupId" class="form-select">
                                        <option value="">No group</option>
                                        @foreach (var group in (List<Kokomija.Entity.ProductGroup>)ViewBag.ProductGroups)
                                        {
                                            <option value="@group.Id">@group.Name</option>
                                        }
                                    </select>
                                    <small class="text-muted">Group related products</small>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Category *</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#categoryModalEdit">
                                    <i class="bi bi-search"></i> Select Category
                                </button>
                                <input type="hidden" asp-for="CategoryId" id="selectedCategoryIdEdit" required />
                                <div id="selectedCategoryDisplayEdit" class="mt-2">
                                    @if (Model.CategoryId > 0)
                                    {
                                        var category = ((List<Kokomija.Entity.Category>)ViewBag.Categories).FirstOrDefault(c => c.Id == Model.CategoryId);
                                        if (category != null)
                                        {
                                            var translation = category.Translations?.FirstOrDefault(t => t.CultureCode == "en-US") ?? category.Translations?.FirstOrDefault();
                                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> @(translation?.Name ?? "Unnamed")</span>
                                        }
                                    }
                                    else
                                    {
                                        <span class="text-muted">No category selected</span>
                                    }
                                </div>
                                <span asp-validation-for="CategoryId" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Associate Coupon (Optional)</label>
                                <select asp-for="CouponId" class="form-select">
                                    <option value="">No coupon - Regular pricing</option>
                                    @foreach (var coupon in (List<Kokomija.Entity.Coupon>)ViewBag.Coupons)
                                    {
                                        var displayText = $"{coupon.Code} - ";
                                        if (coupon.DiscountType == "percentage")
                                        {
                                            displayText += $"{coupon.DiscountValue}% off";
                                        }
                                        else
                                        {
                                            displayText += $"{coupon.DiscountValue} zł off";
                                        }
                                        
                                        if (coupon.UserId != null)
                                        {
                                            displayText += " (User-specific)";
                                        }
                                        
                                        <option value="@coupon.Id">@displayText</option>
                                    }
                                </select>
                                <small class="text-muted">Automatically apply discount to this product</small>
                            </div>
                        </div>
                    </div>

                    <!-- Price History -->
                    @if (Model.PriceHistory != null && Model.PriceHistory.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-clock-history"></i> Price History
                                </h5>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Old Price</th>
                                            <th>New Price</th>
                                            <th>Change</th>
                                            <th>Reason</th>
                                            <th>Changed By</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var history in Model.PriceHistory.OrderByDescending(h => h.ChangedAt))
                                        {
                                            var priceChange = history.NewPrice - history.OldPrice;
                                            var changePercent = history.OldPrice > 0 ? (priceChange / history.OldPrice * 100) : 0;
                                            <tr>
                                                <td><small>@history.ChangedAt.ToString("yyyy-MM-dd HH:mm")</small></td>
                                                <td>@history.OldPrice.ToString("C2")</td>
                                                <td>@history.NewPrice.ToString("C2")</td>
                                                <td>
                                                    @if (priceChange > 0)
                                                    {
                                                        <span class="badge bg-success">+@priceChange.ToString("C2") (+@changePercent.ToString("F1")%)</span>
                                                    }
                                                    else if (priceChange < 0)
                                                    {
                                                        <span class="badge bg-danger">@priceChange.ToString("C2") (@changePercent.ToString("F1")%)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">No change</span>
                                                    }
                                                </td>
                                                <td><small>@(history.Reason ?? "Manual Update")</small></td>
                                                <td><small>@(history.ChangedBy ?? "System")</small></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                    <!-- Product Images -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-images"></i> Product Images
                            </h5>
                            <!-- Existing Images -->
                            @if (Model.ExistingImageUrls.Any())
                            {
                                <div class="mb-3">
                                    <label class="form-label">Current Images</label>
                                    <div class="row g-3" id="existingImages">
                                        @foreach (var imageUrl in Model.ExistingImageUrls)
                                        {
                                            <div class="col-md-3 image-preview-item" data-url="@imageUrl">
                                                <img src="@imageUrl" alt="Product Image" />
                                                <button type="button" class="image-remove-btn" onclick="markForDeletion('@imageUrl')">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            
                            <div class="mb-3">
                                <label class="form-label">Upload New Images (Max 5MB each)</label>
                                <input type="file" id="imageUpload" class="form-control" accept=".jpg,.jpeg,.png,.webp" multiple />
                            </div>
                            
                            <div id="newImagePreview" class="row g-3 mt-2"></div>
                            
                            <!-- Hidden inputs -->
                            <input type="hidden" id="newImageFileNames" name="NewImageTempFileNames" />
                            <input type="hidden" id="imagesToDelete" name="ImagesToDelete" />
                        </div>
                    </div>

                    <!-- Variants Management -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-grid-3x3-gap"></i> Product Variants (@Model.Variants.Count)
                            </h5>
                            @if (Model.Variants.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Size</th>
                                                <th>Color</th>
                                                <th>SKU</th>
                                                <th>Price</th>
                                                <th>Stock</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variantsTableBody">
                                            @for (int i = 0; i < Model.Variants.Count; i++)
                                            {
                                                var variant = Model.Variants[i];
                                                <tr data-variant-id="@variant.Id" data-variant-index="@i">
                                                    <input type="hidden" name="Variants[@i].Id" value="@variant.Id" />
                                                    <td>
                                                        <select name="Variants[@i].SizeId" class="form-select form-select-sm">
                                                            <option value="">-- None --</option>
                                                            @foreach (var size in (List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableSizes)
                                                            {
                                                                var sizeSelected = variant.SizeId?.ToString() == size.Value;
                                                                if (sizeSelected)
                                                                {
                                                                    <option value="@size.Value" selected>@size.Text</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@size.Value">@size.Text</option>
                                                                }
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select name="Variants[@i].ColorId" class="form-select form-select-sm">
                                                            <option value="">-- None --</option>
                                                            @foreach (var color in (List<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>)ViewBag.AvailableColors)
                                                            {
                                                                var colorSelected = variant.ColorId?.ToString() == color.Value;
                                                                if (colorSelected)
                                                                {
                                                                    <option value="@color.Value" selected>@color.Text</option>
                                                                }
                                                                else
                                                                {
                                                                    <option value="@color.Value">@color.Text</option>
                                                                }
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="text" name="Variants[@i].SKU" class="form-control form-control-sm" value="@variant.SKU" required style="width: 100px;" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="Variants[@i].Price" class="form-control form-control-sm" value="@variant.Price" step="0.01" required style="width: 80px;" />
                                                    </td>
                                                    <td>
                                                        <input type="number" name="Variants[@i].StockQuantity" class="form-control form-control-sm" value="@variant.StockQuantity" required style="width: 70px;" />
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariantRow(this)" title="Remove variant">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="btn btn-success btn-sm" id="addVariantBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add Variant
                                </button>
                            }
                            else
                            {
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    No variants created. Add variants for different size/color combinations.
                                </div>
                                <button type="button" class="btn btn-success" id="addVariantBtn">
                                    <i class="bi bi-plus-circle me-1"></i> Add First Variant
                                </button>
                                <div id="variantsContainer"></div>
                            }
                        </div>
                    </div>

                    <!-- Review Management -->
                    @if (Model.Reviews.Any())
                    {
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-star"></i> Customer Reviews (@Model.Reviews.Count)
                                </h5>
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>User</th>
                                            <th>Rating</th>
                                            <th>Comment</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var review in Model.Reviews)
                                        {
                                            <tr id="review-@review.Id">
                                                <td>
                                                    <div>
                                                        <strong>@review.UserName</strong>
                                                        @if (review.UserIsBanned)
                                                        {
                                                            <span class="badge bg-danger ms-1">Banned</span>
                                                        }
                                                        @if (review.IsVerifiedPurchase)
                                                        {
                                                            <span class="badge bg-success ms-1">Verified</span>
                                                        }
                                                    </div>
                                                    <small class="text-muted">@review.UserEmail</small>
                                                </td>
                                                <td>
                                                    <div class="rating-stars">
                                                        @for (int i = 0; i < (int)review.Rating; i++)
                                                        {
                                                            <i class="bi bi-star-fill text-warning"></i>
                                                        }
                                                        @if (review.Rating % 1 != 0)
                                                        {
                                                            <i class="bi bi-star-half text-warning"></i>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="review-comment">@review.Comment</div>
                                                </td>
                                                <td>
                                                    @if (review.IsVisible)
                                                    {
                                                        <span class="badge bg-success">Visible</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">Hidden</span>
                                                    }
                                                </td>
                                                <td>
                                                    <small>@review.CreatedAt.ToString("MMM dd, yyyy")</small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-primary" onclick="toggleReviewVisibility(@review.Id)" title="Toggle Visibility">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <a asp-controller="AdminUser" asp-action="Edit" asp-route-id="@review.UserId" class="btn btn-outline-warning" title="Manage User">
                                                            <i class="bi bi-person"></i>
                                                        </a>
                                                        <button type="button" class="btn btn-outline-danger" onclick="deleteReview(@review.Id)" title="Delete Review">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        </div>
                                    </div>
                                </div>
                    }
                </div>

                <!-- Right Column: Status & Actions -->
                <div class="col-lg-4">
                    <!-- Status -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-toggle-on"></i> Status
                            </h5>
                            <div class="form-check form-switch mb-3">
                                <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                                <label class="form-check-label" asp-for="IsActive">
                                    Active (visible to customers)
                                </label>
                            </div>
                            
                            <div class="alert alert-info">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>Stripe Product ID:</strong><br/>
                                    <code>@Model.StripeProductId</code>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Coupons -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-ticket-perforated"></i> Product Coupons</h5>
                            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createCouponModal">
                                <i class="bi bi-plus-lg"></i> Add
                            </button>
                        </div>
                        <div class="card-body p-0" id="couponsContainer">
                            @if (ViewBag.ProductCoupons != null && ((List<Kokomija.Entity.Coupon>)ViewBag.ProductCoupons).Any())
                            {
                                <div class="list-group list-group-flush">
                                    @foreach (var coupon in (List<Kokomija.Entity.Coupon>)ViewBag.ProductCoupons)
                                    {
                                        <div class="list-group-item coupon-item" data-coupon-id="@coupon.Id">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <div class="d-flex align-items-center gap-2 mb-1">
                                                        <h6 class="mb-0 fw-bold">@coupon.Code</h6>
                                                        @if(coupon.IsActive)
                                                        {
                                                            <span class="badge bg-success">Active</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-secondary">Inactive</span>
                                                        }
                                                    </div>
                                                    <small class="text-primary fw-semibold">
                                                        @if(coupon.DiscountType == "percentage") 
                                                        { 
                                                            <span>@coupon.DiscountValue.ToString("0")% Off</span> 
                                                        }
                                                        else 
                                                        { 
                                                            <span>@coupon.DiscountValue.ToString("C") Off</span> 
                                                        }
                                                    </small>
                                                    <div class="mt-1">
                                                        <small class="text-muted">
                                                            @if(coupon.ValidUntil.HasValue)
                                                            {
                                                                <i class="bi bi-calendar-event me-1"></i>
                                                                <span>Expires: @coupon.ValidUntil.Value.ToString("MMM dd, yyyy")</span>
                                                            }
                                                            else
                                                            {
                                                                <i class="bi bi-infinity me-1"></i>
                                                                <span>No expiration</span>
                                                            }
                                                        </small>
                                                        @if(coupon.UsageLimit.HasValue)
                                                        {
                                                            <br/>
                                                            <small class="text-muted">
                                                                <i class="bi bi-people me-1"></i>
                                                                <span>Used: @coupon.UsageCount / @coupon.UsageLimit</span>
                                                            </small>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="btn-group btn-group-sm">
                                                    <button type="button" class="btn btn-outline-secondary" 
                                                            onclick="openEditCouponModal(@coupon.Id)" 
                                                            title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-info" 
                                                            onclick="toggleCoupon(@coupon.Id)" 
                                                            title="@(coupon.IsActive ? "Disable" : "Enable")">
                                                        <i class="bi bi-@(coupon.IsActive ? "pause" : "play")"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" 
                                                            onclick="deleteCoupon(@coupon.Id)" 
                                                            title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="p-4 text-center text-muted">
                                    <i class="bi bi-ticket-perforated fs-1 mb-2 d-block opacity-50"></i>
                                    <small>No coupons created for this product.</small>
                                    <br/>
                                    <small>Click "Add" to create a product-specific discount.</small>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Product Info -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle"></i> Product Info
                            </h6>
                            <small class="text-muted">
                                <div class="mb-2">
                                    <i class="bi bi-grid-3x3-gap me-1"></i>
                                    <strong>Variants:</strong> @Model.Variants.Count
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-star me-1"></i>
                                    <strong>Reviews:</strong> @Model.Reviews.Count
                                </div>
                                <div class="mb-2">
                                    <i class="bi bi-images me-1"></i>
                                    <strong>Images:</strong> @Model.ExistingImageUrls.Count
                                </div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 bg-body-tertiary p-3 rounded-3 mt-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> Update Product
                </button>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Category Selection Modal -->
<div class="modal fade" id="categoryModalEdit" tabindex="-1" aria-labelledby="categoryModalEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalEditLabel">
                    <i class="bi bi-grid-3x3-gap"></i> Select Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table id="categoryTableEdit" class="table table-striped table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Display Order</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var category in (List<Kokomija.Entity.Category>)ViewBag.Categories)
                        {
                            var translation = category.Translations?.FirstOrDefault(t => t.CultureCode == "en-US") 
                                ?? category.Translations?.FirstOrDefault();
                            var categoryName = translation?.Name ?? category.Name ?? "Unnamed";
                            <tr>
                                <td>@categoryName</td>
                                <td>
                                    @if (category.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Inactive</span>
                                    }
                                </td>
                                <td>@category.DisplayOrder</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary select-category-edit" 
                                            data-category-id="@category.Id" 
                                            data-category-name="@categoryName">
                                        Select
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Coupon Modal -->
<div class="modal fade" id="createCouponModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Product Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createCouponForm">
                    <input type="hidden" name="ProductId" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" class="form-control" name="Code" required style="text-transform: uppercase;">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Type</label>
                            <select class="form-select" name="DiscountType">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed_amount">Fixed Amount</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Value</label>
                            <input type="number" class="form-control" name="DiscountValue" required min="0" step="0.01">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valid Until (Optional)</label>
                        <input type="date" class="form-control" name="ValidUntil">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Usage Limit (Optional)</label>
                        <input type="number" class="form-control" name="UsageLimit" min="1">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createCoupon()">Create Coupon</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCouponForm">
                    <input type="hidden" name="Id" id="editCouponId" />
                    <div class="mb-3">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" class="form-control" id="editCouponCode" readonly disabled>
                        <small class="text-muted">Code cannot be changed after creation.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount</label>
                        <input type="text" class="form-control" id="editCouponDiscount" readonly disabled>
                        <small class="text-muted">Discount cannot be changed (Stripe limitation). Delete and recreate if needed.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" name="Description" id="editCouponDescription" placeholder="Internal notes about this coupon">
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Minimum Order Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="MinimumOrderAmount" id="editMinOrderAmount" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <small class="text-muted">Leave empty for no minimum.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Maximum Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="MaximumDiscountAmount" id="editMaxDiscount" min="0" step="0.01" placeholder="0.00">
                            </div>
                            <small class="text-muted">Cap for percentage discounts.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valid Until</label>
                        <input type="datetime-local" class="form-control" name="ValidUntil" id="editCouponValidUntil">
                        <small class="text-muted">Leave empty for no expiration.</small>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Total Usage Limit</label>
                            <input type="number" class="form-control" name="UsageLimit" id="editCouponUsageLimit" min="1" placeholder="Unlimited">
                            <small class="text-muted">Max total uses.</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Per-User Limit</label>
                            <input type="number" class="form-control" name="UsageLimitPerUser" id="editUsageLimitPerUser" min="1" placeholder="Unlimited">
                            <small class="text-muted">Max uses per user.</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="editCouponActive" checked>
                            <label class="form-check-label" for="editCouponActive">
                                <strong>Active</strong> - Coupon can be used at checkout
                            </label>
                        </div>
                        <small class="text-muted">Deactivating will also disable the Stripe PromotionCode.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCoupon()">
                    <i class="bi bi-cloud-arrow-up"></i> Save & Sync with Stripe
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .image-preview-item {
            position: relative;
        }
        .image-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
        .image-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .review-comment {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .variant-card {
            border: 1px solid var(--bs-border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: var(--bs-tertiary-bg);
        }
        [data-bs-theme="dark"] .variant-card {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let newImageFileNames = [];
        let imagesToDelete = [];

        async function createCoupon() {
            const form = document.getElementById('createCouponForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Convert types
            data.ProductId = parseInt(data.ProductId);
            data.DiscountValue = parseFloat(data.DiscountValue);
            if(data.UsageLimit) data.UsageLimit = parseInt(data.UsageLimit);
            if(!data.ValidUntil) data.ValidUntil = null;

            try {
                const response = await fetch('@Url.Action("CreateCoupon")', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() 
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if(result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error creating coupon');
            }
        }

        async function deleteCoupon(id) {
            if(!confirm('Delete this coupon? This will also remove it from Stripe.')) return;
            
            try {
                const response = await fetch(`@Url.Action("DeleteCoupon")?id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });
                
                const result = await response.json();
                if(result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error deleting coupon');
            }
        }

        async function toggleCoupon(id) {
            try {
                const response = await fetch(`@Url.Action("ToggleCoupon")?id=${id}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    }
                });
                
                const result = await response.json();
                if(result.success) {
                    alert('Coupon status updated. Synced with Stripe.');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error toggling coupon status');
            }
        }

        async function openEditCouponModal(id) {
            try {
                const response = await fetch(`@Url.Action("GetCoupon")?id=${id}`);
                const result = await response.json();
                
                if(result.success) {
                    const coupon = result.coupon;
                    
                    document.getElementById('editCouponId').value = coupon.id;
                    document.getElementById('editCouponCode').value = coupon.code;
                    
                    // Display discount (read-only)
                    const discountText = coupon.discountType === 'percentage' 
                        ? coupon.discountValue + '%' 
                        : '$' + coupon.discountValue.toFixed(2);
                    document.getElementById('editCouponDiscount').value = discountText;
                    
                    document.getElementById('editCouponDescription').value = coupon.description || '';
                    document.getElementById('editMinOrderAmount').value = coupon.minimumOrderAmount || '';
                    document.getElementById('editMaxDiscount').value = coupon.maximumDiscountAmount || '';
                    
                    // Handle datetime
                    if (coupon.validUntil) {
                        const date = new Date(coupon.validUntil);
                        date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                        document.getElementById('editCouponValidUntil').value = date.toISOString().slice(0, 16);
                    } else {
                        document.getElementById('editCouponValidUntil').value = '';
                    }
                    
                    document.getElementById('editCouponUsageLimit').value = coupon.usageLimit || '';
                    document.getElementById('editUsageLimitPerUser').value = coupon.usageLimitPerUser || '';
                    document.getElementById('editCouponActive').checked = coupon.isActive;
                    
                    const modal = new bootstrap.Modal(document.getElementById('editCouponModal'));
                    modal.show();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error loading coupon data');
            }
        }

        async function updateCoupon() {
            const data = {
                Id: parseInt(document.getElementById('editCouponId').value),
                Description: document.getElementById('editCouponDescription').value || null,
                MinimumOrderAmount: document.getElementById('editMinOrderAmount').value ? parseFloat(document.getElementById('editMinOrderAmount').value) : null,
                MaximumDiscountAmount: document.getElementById('editMaxDiscount').value ? parseFloat(document.getElementById('editMaxDiscount').value) : null,
                ValidUntil: document.getElementById('editCouponValidUntil').value ? new Date(document.getElementById('editCouponValidUntil').value).toISOString() : null,
                UsageLimit: document.getElementById('editCouponUsageLimit').value ? parseInt(document.getElementById('editCouponUsageLimit').value) : null,
                UsageLimitPerUser: document.getElementById('editUsageLimitPerUser').value ? parseInt(document.getElementById('editUsageLimitPerUser').value) : null,
                IsActive: document.getElementById('editCouponActive').checked
            };

            try {
                const response = await fetch('@Url.Action("UpdateCoupon")', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() 
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if(result.success) {
                    alert('Coupon updated successfully! Changes synced with Stripe.');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch(e) {
                console.error(e);
                alert('Error updating coupon');
            }
        }

        // Mark existing image for deletion
        function markForDeletion(imageUrl) {
            if (!confirm('Remove this image?')) return;
            
            imagesToDelete.push(imageUrl);
            document.querySelector(`.image-preview-item[data-url="${imageUrl}"]`).remove();
            updateHiddenInputs();
        }

        // Upload new images
        document.getElementById('imageUpload').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Max size is 5MB.`);
                    continue;
                }

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('@Url.Action("UploadImage")', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        newImageFileNames.push(result.tempFileName);
                        addNewImagePreview(result.tempUrl, result.tempFileName);
                        updateHiddenInputs();
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            
            e.target.value = '';
        });

        function addNewImagePreview(url, fileName) {
            const html = `
                <div class="col-md-3 image-preview-item" data-filename="${fileName}">
                    <img src="${url}" alt="New Image" />
                    <button type="button" class="image-remove-btn" onclick="removeNewImage('${fileName}')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            document.getElementById('newImagePreview').insertAdjacentHTML('beforeend', html);
        }

        async function removeNewImage(fileName) {
            if (!confirm('Remove this image?')) return;

            try {
                await fetch('@Url.Action("CancelUpload")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tempFileNames: [fileName] })
                });

                newImageFileNames = newImageFileNames.filter(f => f !== fileName);
                document.querySelector(`#newImagePreview .image-preview-item[data-filename="${fileName}"]`).remove();
                updateHiddenInputs();
            } catch (error) {
                console.error('Error removing image:', error);
            }
        }

        function updateHiddenInputs() {
            document.getElementById('newImageFileNames').value = newImageFileNames.join(',');
            document.getElementById('imagesToDelete').value = imagesToDelete.join(',');
        }

        // Review management functions
        async function toggleReviewVisibility(reviewId) {
            try {
                const response = await fetch('@Url.Action("ReviewToggleVisibility", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: reviewId })
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error toggling visibility:', error);
            }
        }

        async function deleteReview(reviewId) {
            if (!confirm('Delete this review permanently?')) return;

            try {
                const response = await fetch('@Url.Action("ReviewDelete", "Admin")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: reviewId })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById(`review-${reviewId}`).remove();
                }
            } catch (error) {
                console.error('Error deleting review:', error);
            }
        }

        // Sync default Name/Description from English translation for backwards compatibility
        document.getElementById('productForm').addEventListener('submit', function() {
            const enName = document.querySelector('input[name="Translations[0].Name"]');
            const enDesc = document.querySelector('textarea[name="Translations[0].Description"]');
            if (enName && enDesc) {
                document.getElementById('defaultName').value = enName.value;
                document.getElementById('defaultDescription').value = enDesc.value;
            }
        });

        // === Translation Tab URL Sync ===
        // Update URL when switching translation tabs for direct linking
        document.querySelectorAll('#translationTabs .nav-link').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                const tabId = e.target.getAttribute('id').replace('-tab', '');
                const url = new URL(window.location);
                url.searchParams.set('lang', tabId);
                window.history.pushState({}, '', url);
            });
        });

        // Restore tab from URL on page load
        (function() {
            const url = new URL(window.location);
            const lang = url.searchParams.get('lang');
            if (lang) {
                const tabEl = document.querySelector(`#${lang}-tab`);
                if (tabEl) {
                    const tab = new bootstrap.Tab(tabEl);
                    tab.show();
                }
            }
        })();

        // === Category DataTables for Edit ===
        $(document).ready(function() {
            const categoryTableEdit = $('#categoryTableEdit').DataTable({
                responsive: true,
                pageLength: 10,
                order: [[2, 'asc']], // Sort by Display Order
                language: {
                    search: "Search categories:",
                    lengthMenu: "Show _MENU_ categories",
                    info: "Showing _START_ to _END_ of _TOTAL_ categories",
                    emptyTable: "No categories available"
                }
            });

            // Category selection handler for Edit
            $(document).on('click', '.select-category-edit', function() {
                const categoryId = $(this).data('category-id');
                const categoryName = $(this).data('category-name');
                
                $('#selectedCategoryIdEdit').val(categoryId);
                $('#selectedCategoryDisplayEdit').html(
                    `<span class="badge bg-success"><i class="bi bi-check-circle"></i> ${categoryName}</span>`
                );
                
                $('#categoryModalEdit').modal('hide');
            });
        });

        // === Variant Management ===
        let variantIndex = @Model.Variants.Count;
        const sizes = @Html.Raw(Json.Serialize(ViewBag.AvailableSizes));
        const colors = @Html.Raw(Json.Serialize(ViewBag.AvailableColors));

        document.getElementById('addVariantBtn')?.addEventListener('click', function() {
            const existingTable = document.getElementById('variantsTableBody');
            
            if (existingTable) {
                // Add new row to existing table
                const newRow = document.createElement('tr');
                newRow.setAttribute('data-variant-index', variantIndex);
                newRow.innerHTML = `
                    <input type="hidden" name="Variants[${variantIndex}].Id" value="" />
                    <td>
                        <select name="Variants[${variantIndex}].SizeId" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            ${sizes.map(s => `<option value="${s.value}">${s.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <select name="Variants[${variantIndex}].ColorId" class="form-select form-select-sm">
                            <option value="">-- None --</option>
                            ${colors.map(c => `<option value="${c.value}">${c.text}</option>`).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="text" name="Variants[${variantIndex}].SKU" class="form-control form-control-sm" required style="width: 100px;" placeholder="SKU-001" />
                    </td>
                    <td>
                        <input type="number" name="Variants[${variantIndex}].Price" class="form-control form-control-sm" step="0.01" required style="width: 80px;" value="@Model.Price" />
                    </td>
                    <td>
                        <input type="number" name="Variants[${variantIndex}].StockQuantity" class="form-control form-control-sm" required style="width: 70px;" value="100" />
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeVariantRow(this)" title="Remove variant">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                existingTable.appendChild(newRow);
            } else {
                // Create first variant with card layout (when no variants exist)
                const container = document.getElementById('variantsContainer');
                if (container) {
                    const variantHtml = `
                        <div class="variant-card mt-3" data-variant-index="${variantIndex}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">New Variant #${variantIndex + 1}</h6>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeVariantCard(${variantIndex})">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </div>
                            <input type="hidden" name="Variants[${variantIndex}].Id" value="" />
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Size</label>
                                    <select name="Variants[${variantIndex}].SizeId" class="form-select form-select-sm">
                                        <option value="">-- Optional --</option>
                                        ${sizes.map(s => `<option value="${s.value}">${s.text}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label">Color</label>
                                    <select name="Variants[${variantIndex}].ColorId" class="form-select form-select-sm">
                                        <option value="">-- Optional --</option>
                                        ${colors.map(c => `<option value="${c.value}">${c.text}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">SKU *</label>
                                    <input name="Variants[${variantIndex}].SKU" type="text" class="form-control form-control-sm" required placeholder="SKU-001" />
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Price (zł) *</label>
                                    <input name="Variants[${variantIndex}].Price" type="number" step="0.01" class="form-control form-control-sm" required value="@Model.Price" />
                                </div>
                                <div class="col-md-4 mb-2">
                                    <label class="form-label">Stock *</label>
                                    <input name="Variants[${variantIndex}].StockQuantity" type="number" class="form-control form-control-sm" required value="100" />
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', variantHtml);
                }
            }
            
            variantIndex++;
        });

        function removeVariantRow(button) {
            const row = button.closest('tr');
            if (confirm('Remove this variant?')) {
                row.remove();
                // Re-index remaining variants
                reindexVariants();
            }
        }

        function removeVariantCard(index) {
            const card = document.querySelector(`.variant-card[data-variant-index="${index}"]`);
            if (card && confirm('Remove this variant?')) {
                card.remove();
            }
        }

        function reindexVariants() {
            const tbody = document.getElementById('variantsTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, idx) => {
                row.setAttribute('data-variant-index', idx);
                row.querySelectorAll('input, select').forEach(input => {
                    const name = input.getAttribute('name');
                    if (name) {
                        input.setAttribute('name', name.replace(/\[\d+\]/, `[${idx}]`));
                    }
                });
            });
            variantIndex = rows.length;
        }
    </script>
}
