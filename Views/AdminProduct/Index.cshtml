@model Kokomija.Models.ViewModels.Admin.ProductManagementViewModel
@{
    ViewData["Title"] = "Product Management";
}

<div class="admin-dashboard">
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="welcome-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1>
                                <i class="bi bi-box-seam"></i>
                                Product Management
                            </h1>
                            <p class="mb-0">Manage your product catalog, inventory, and customer reviews</p>
                        </div>
                        <div class="d-flex gap-2">
                            <a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i>
                                Back to Dashboard
                            </a>
                            <div class="btn-group">
                                <a asp-action="CreateWizard" class="btn btn-primary">
                                    <i class="bi bi-magic"></i>
                                    Wizard
                                </a>
                                <a asp-action="Create" class="btn btn-outline-primary">
                                    <i class="bi bi-plus-lg"></i>
                                    Basic
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-2-4">
                <div class="stat-card-small">
                    <div class="stat-icon-small bg-primary">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <div>
                        <h6>@Model.TotalProducts</h6>
                        <small>Total Products</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stat-card-small">
                    <div class="stat-icon-small bg-success">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div>
                        <h6>@Model.ActiveProducts</h6>
                        <small>Active</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stat-card-small">
                    <div class="stat-icon-small bg-warning">
                        <i class="bi bi-pause-circle"></i>
                    </div>
                    <div>
                        <h6>@Model.InactiveProducts</h6>
                        <small>Inactive</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stat-card-small">
                    <div class="stat-icon-small bg-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div>
                        <h6>@Model.OutOfStockProducts</h6>
                        <small>Out of Stock</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2-4">
                <div class="stat-card-small">
                    <div class="stat-icon-small bg-info">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                    <div>
                        <h6>@Model.TotalInventoryValue.ToString("C")</h6>
                        <small>Inventory Value</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Filters & Search Bar -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body py-3">
                        <div class="row g-3 align-items-end">
                            <!-- Search Input with Type Selector -->
                            <div class="col-lg-5 col-md-6">
                                <label class="form-label fw-semibold small text-muted mb-1">Search Products</label>
                                <div class="input-group">
                                    <select class="form-select" id="searchType" style="max-width: 120px;">
                                        <option value="all">All</option>
                                        <option value="name">Name</option>
                                        <option value="sku">SKU</option>
                                        <option value="stripe">Stripe ID</option>
                                    </select>
                                    <input type="text" class="form-control" id="customSearch" placeholder="Search by name, SKU, or Stripe ID...">
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="Clear search">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Quick Filters -->
                            <div class="col-lg-5 col-md-6">
                                <label class="form-label fw-semibold small text-muted mb-1">Quick Filters</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
                                    <label class="btn btn-outline-secondary" for="filterAll">
                                        <i class="bi bi-grid"></i> All
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterActive" value="active">
                                    <label class="btn btn-outline-success" for="filterActive">
                                        <i class="bi bi-check-circle"></i> Active
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterInactive" value="inactive">
                                    <label class="btn btn-outline-secondary" for="filterInactive">
                                        <i class="bi bi-pause-circle"></i> Inactive
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterLowStock" value="low">
                                    <label class="btn btn-outline-warning" for="filterLowStock">
                                        <i class="bi bi-exclamation-triangle"></i> Low Stock
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="statusFilter" id="filterOutOfStock" value="out">
                                    <label class="btn btn-outline-danger" for="filterOutOfStock">
                                        <i class="bi bi-x-circle"></i> Out
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Export/Actions -->
                            <div class="col-lg-2 col-md-12 text-end">
                                <div class="btn-group">
                                    <button class="btn btn-outline-success" type="button" id="exportExcel" title="Export to Excel">
                                        <i class="bi bi-file-earmark-excel"></i> Export to Excel
                                    </button>
                                    <button class="btn btn-outline-info" type="button" id="refreshTable" title="Refresh">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-list"></i> All Products
                                <span class="badge bg-secondary ms-2" id="filteredCount">@Model.Products.Count</span>
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <small class="text-muted" id="filterInfo">Showing all products</small>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="productsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Image</th>
                                        <th>Product</th>
                                        <th>Parent Category</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Pack</th>
                                        <th>Stock</th>
                                        <th>Variants</th>
                                        <th>Reviews</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in Model.Products)
                                    {
                                        <tr data-category="@product.CategoryName" data-status="@(product.IsActive ? "active" : "inactive")" data-stock="@product.TotalStock">
                                            <td>
                                                @if (!string.IsNullOrEmpty(product.FeaturedImage))
                                                {
                                                    <img src="@product.FeaturedImage" alt="@product.Name" class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;" onerror="this.src='/img/logo_black.png'">
                                                }
                                                else
                                                {
                                                    <div class="text-muted d-flex align-items-center justify-content-center" style="width: 60px; height: 60px; border: 1px dashed #ddd; border-radius: 4px;">
                                                        <i class="bi bi-image"></i>
                                                    </div>
                                                }
                                            </td>
                                            <td data-search="@product.Name @product.StripeProductId @string.Join(" ", product.SKUs)">
                                                <strong>@product.Name</strong>
                                                <br>
                                                <small class="text-muted">
                                                    <i class="bi bi-stripe"></i> @product.StripeProductId
                                                </small>
                                                @if (product.SKUs.Any())
                                                {
                                                    <br>
                                                    <small class="text-info sku-list" data-skus="@string.Join(",", product.SKUs)">
                                                        <i class="bi bi-upc-scan"></i> @string.Join(", ", product.SKUs.Take(2))@(product.SKUs.Count > 2 ? $" (+{product.SKUs.Count - 2} more)" : "")
                                                    </small>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(product.ParentCategoryName))
                                                {
                                                    <span class="badge bg-secondary bg-opacity-10 text-secondary">
                                                        @product.ParentCategoryName
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(product.CategoryName))
                                                {
                                                    <span class="badge bg-primary bg-opacity-10 text-primary">
                                                        @product.CategoryName
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">—</span>
                                                }
                                            </td>
                                            <td>
                                                <strong>@product.Price.ToString("C")</strong>
                                            </td>
                                            <td>
                                                @if (product.PackSize == 1)
                                                {
                                                    <span class="badge bg-secondary">Single</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-info fw-bold">@product.PackSize-Pack</span>
                                                }
                                            </td>
                                            <td>
                                                @if (product.TotalStock == 0)
                                                {
                                                    <span class="badge bg-danger">0</span>
                                                }
                                                else if (product.TotalStock < 20)
                                                {
                                                    <span class="badge bg-warning">@product.TotalStock</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-success">@product.TotalStock</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">@product.TotalVariants</span>
                                            </td>
                                            <td>
                                                @if (product.ReviewCount > 0)
                                                {
                                                    <div class="d-flex align-items-center gap-1">
                                                        <i class="bi bi-star-fill text-warning"></i>
                                                        <small>@product.AverageRating.ToString("0.0")</small>
                                                        <small class="text-muted">(@product.ReviewCount)</small>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <small class="text-muted">No reviews</small>
                                                }
                                            </td>
                                            <td>
                                                @if (product.IsActive)
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-check-circle"></i> Active
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">
                                                        <i class="bi bi-pause-circle"></i> Inactive
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a asp-action="Edit" asp-route-id="@product.Id" class="btn btn-outline-primary" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-outline-info" onclick="toggleProductStatus(@product.Id)" title="@(product.IsActive ? "Deactivate" : "Activate")">
                                                        <i class="bi bi-@(product.IsActive ? "pause" : "play")"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger" onclick="deleteProduct(@product.Id, '@product.Name')" title="Delete">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/lib/datatables/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="~/lib/datatables/responsive.bootstrap5.min.css" />
    <style>
        .col-md-2-4 {
            flex: 0 0 20%;
            max-width: 20%;
        }

        .stat-card-small {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
            height: 100%;
        }

        .stat-icon-small {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            flex-shrink: 0;
        }

        .stat-card-small h6 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .stat-card-small small {
            color: #666;
            font-size: 13px;
            display: block;
            margin-top: 2px;
        }

        /* Dark theme support for stat cards */
        [data-bs-theme="dark"] .stat-card-small {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        [data-bs-theme="dark"] .stat-card-small h6 {
            color: var(--bs-body-color);
        }

        [data-bs-theme="dark"] .stat-card-small small {
            color: var(--bs-secondary-color);
        }

        /* Ensure images display well in dark theme */
        [data-bs-theme="dark"] .img-thumbnail {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Product image placeholder in dark theme */
        [data-bs-theme="dark"] .text-muted {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Enhanced Filter Buttons */
        .btn-group .btn-check:checked + .btn-outline-success {
            background-color: var(--bs-success);
            color: white;
        }
        .btn-group .btn-check:checked + .btn-outline-warning {
            background-color: var(--bs-warning);
            color: #000;
        }
        .btn-group .btn-check:checked + .btn-outline-danger {
            background-color: var(--bs-danger);
            color: white;
        }
        .btn-group .btn-check:checked + .btn-outline-secondary {
            background-color: var(--bs-secondary);
            color: white;
        }
        
        /* SKU styling */
        .sku-list {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.75rem;
        }
        
        /* Table improvements */
        #productsTable tbody tr {
            transition: background-color 0.15s ease;
        }
        #productsTable tbody tr:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.05);
        }
        
        /* Pagination styling */
        .dataTables_paginate .paginate_button {
            border-radius: 4px !important;
            margin: 0 2px;
        }
        
        /* Search input group */
        #customSearch {
            border-left: 0;
        }
        #customSearch:focus {
            border-color: var(--bs-border-color);
            box-shadow: none;
        }
        #searchType {
            border-right: 0;
            background-color: var(--bs-tertiary-bg);
        }
        
        /* Card animation */
        .stat-card-small {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .stat-card-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Action buttons */
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
        }
        
        /* Filter badge */
        #filteredCount {
            font-size: 0.75rem;
        }
        
        /* Dark theme input group */
        [data-bs-theme="dark"] #searchType {
            background-color: var(--bs-body-bg);
            border-color: var(--bs-border-color);
        }
        [data-bs-theme="dark"] #customSearch {
            border-color: var(--bs-border-color);
        }
    </style>
}

@section Scripts {
    <script src="~/lib/datatables/dataTables.min.js"></script>
    <script src="~/lib/datatables/dataTables.bootstrap5.min.js"></script>
    <script src="~/lib/datatables/dataTables.responsive.min.js"></script>
    <script src="~/lib/datatables/responsive.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            // Store current filter states
            let currentSearchValue = '';
            let currentSearchType = 'all';
            let currentStatusFilter = 'all';
            
            // Add custom filter BEFORE initializing DataTable
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex, rowData, counter) {
                // Only apply to productsTable
                if (settings.nTable.id !== 'productsTable') return true;
                
                const $row = $(settings.aoData[dataIndex].nTr);
                const status = $row.data('status');
                const stock = parseInt($row.data('stock')) || 0;
                
                // Check status filter
                let matchesStatus = true;
                switch(currentStatusFilter) {
                    case 'active':
                        matchesStatus = status === 'active';
                        break;
                    case 'inactive':
                        matchesStatus = status === 'inactive';
                        break;
                    case 'low':
                        matchesStatus = stock > 0 && stock < 20;
                        break;
                    case 'out':
                        matchesStatus = stock === 0;
                        break;
                    default:
                        matchesStatus = true;
                }
                
                if (!matchesStatus) return false;
                
                // For text search, we rely mostly on DataTables built-in search via table.search()
                // But if we want to filter by TYPE (SKU only, Name only), we can do it here.
                if (!currentSearchValue) return true;
                
                const searchLower = currentSearchValue.toLowerCase();
                let matchesSearch = true; // Default to true if allowing default search
                
                // We use the data-search attribute content for checking
                const searchableContent = $row.find('td:eq(1)').data('search') || '';
                const fullContent = searchableContent.toString().toLowerCase();

                switch(currentSearchType) {
                    case 'sku':
                        const skuData = $row.find('.sku-list').data('skus') || '';
                        matchesSearch = skuData.toString().toLowerCase().includes(searchLower);
                        break;
                    case 'stripe':
                        // Check if stripe ID is in the content (it's in the data-search)
                        // But strictly stripe ID usually starts with prod_
                        matchesSearch = fullContent.includes(searchLower); 
                        break;
                    case 'name':
                         // Name is the primary part, simple check
                        matchesSearch = fullContent.includes(searchLower);
                        break;
                    default: // 'all'
                        // Let DataTables handle it? 
                        // Actually, if we use table.search(), DataTables does the filtering.
                        // If we return 'true' here, DataTables still checks its internal search.
                        // So we should return 'true' and let table.search() do the work?
                        // NO, table.search() sets the global search term which applies alongside this filter.
                        // BUT we are implementing our own search box which calls table.draw().
                        // We are NOT calling table.search(val).draw().
                        // So we MUST implement text search logic here.
                        matchesSearch = fullContent.includes(searchLower);
                }
                
                return matchesSearch;
            });
            
            // Initialize DataTable
            const table = $('#productsTable').DataTable({
                responsive: true,
                pageLength: 25,
                order: [[1, 'asc']],
                dom: '<"d-flex justify-content-between align-items-center mb-3"<"d-flex align-items-center gap-2"l><"ms-auto">>rtip',
                // Disable built-in search box since we have a custom one
                searching: true, 
                language: {
                    lengthMenu: "_MENU_ per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ products",
                    infoEmpty: "No products found",
                    infoFiltered: "(filtered from _MAX_ total)",
                    paginate: {
                        first: '<i class="bi bi-chevron-double-left"></i>',
                        last: '<i class="bi bi-chevron-double-right"></i>',
                        next: '<i class="bi bi-chevron-right"></i>',
                        previous: '<i class="bi bi-chevron-left"></i>'
                    }
                },
                columnDefs: [
                    { responsivePriority: 1, targets: 0 },
                    { responsivePriority: 2, targets: 1 },
                    { responsivePriority: 3, targets: -1 },
                    { responsivePriority: 4, targets: 4 },
                    { responsivePriority: 5, targets: 6 },
                    { responsivePriority: 6, targets: 9 },
                    { orderable: false, targets: [0, -1] }
                ],
                drawCallback: function() {
                    $('img.img-thumbnail').on('error', function() {
                        $(this).attr('src', '/img/logo_black.png');
                    });
                    // Use this.api() to avoid ReferenceError for 'table' during initialization
                    updateFilteredCount(this.api());
                }
            });
            
            // Apply filters function
            function applyFilters() {
                currentSearchValue = $('#customSearch').val().trim();
                currentSearchType = $('#searchType').val();
                currentStatusFilter = $('input[name="statusFilter"]:checked').val() || 'all';
                
                table.draw();
                updateFilterInfo();
            }
            
            // Search input handler
            $('#customSearch').on('input', function() {
                applyFilters();
            });
            
            // Search type change handler  
            $('#searchType').on('change', function() {
                applyFilters();
            });
            
            // Clear search button
            $('#clearSearch').on('click', function() {
                $('#customSearch').val('');
                applyFilters();
            });
            
            // Status filter buttons
            $('input[name="statusFilter"]').on('change', function() {
                applyFilters();
            });
            
            function updateFilteredCount(api) {
                // If api is not provided, try to use the table variable if it's initialized
                const dt = api || (typeof table !== 'undefined' ? table : null);
                if (dt) {
                    const count = dt.rows({ filter: 'applied' }).count();
                    $('#filteredCount').text(count);
                }
            }
            
            function updateFilterInfo() {
                const filterLabels = {
                    'all': 'Showing all products',
                    'active': 'Showing active products only',
                    'inactive': 'Showing inactive products only',
                    'low': 'Showing products with low stock (<20)',
                    'out': 'Showing out of stock products'
                };
                let info = filterLabels[currentStatusFilter] || 'Showing all products';
                if (currentSearchValue) {
                    info += ` matching "${currentSearchValue}"`;
                }
                $('#filterInfo').text(info);
            }
            
            // Export to Excel
            $('#exportExcel').on('click', function() {
                // Collect client-side filter states
                const currentSearch = $('#customSearch').val().trim();
                const currentType = $('#searchType').val();
                const currentStatus = $('input[name="statusFilter"]:checked').val() || 'all';
                
                // Build query string
                const params = new URLSearchParams();
                if(currentSearch) params.append('searchTerm', currentSearch);
                if(currentType) params.append('searchType', currentType);
                if(currentStatus && currentStatus !== 'all') params.append('statusFilter', currentStatus);
                
                // Keep categoryId if it exists in current URL (server-side filter)
                const urlParams = new URLSearchParams(window.location.search);
                if(urlParams.has('categoryId')) params.append('categoryId', urlParams.get('categoryId'));
                if(urlParams.has('isBusinessOnly')) params.append('isBusinessOnly', urlParams.get('isBusinessOnly'));

                // Go to export URL
                window.location.href = '@Url.Action("ExportToExcel")?' + params.toString();
            });
            
            // Refresh button
            $('#refreshTable').on('click', function() {
                location.reload();
            });
            
            // Initialize count on page load
            // table is initialized now, so we can pass it
            updateFilteredCount(table);
        });

        // Toggle product status
        async function toggleProductStatus(productId) {
            if (!confirm('Are you sure you want to change the product status?\n\nDeactivating will:\n- Archive the product in Stripe\n- Deactivate all prices\n- Remove from all carts')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('id', productId);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                const response = await fetch('@Url.Action("ToggleActive")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (result.message || 'Failed to update product status'));
                }
            } catch (error) {
                console.error('Error toggling product status:', error);
                alert('An error occurred while updating product status');
            }
        }

        // Delete product
        async function deleteProduct(productId, productName) {
            if (!confirm(`Are you sure you want to delete "${productName}"?\n\nThis will:\n- Remove the product from Stripe\n- Delete all variants and images\n- Remove from all carts and wishlists\n\nThis action cannot be undone!`)) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('id', productId);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                const response = await fetch('@Url.Action("Delete")', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (result.message || 'Failed to delete product'));
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('An error occurred while deleting product');
            }
        }
    </script>

    <form id="antiforgerForm" style="display:none;">
        @Html.AntiForgeryToken()
    </form>
}
