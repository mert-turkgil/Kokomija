name: .NET Core Deploy to MonsterASP

on:
  push:
    branches: [ main ]

jobs:
  publish-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'

    - name: Publish
      run: dotnet publish -c Release -o ./publish

    # 1. ADIM: Profesyonel ve Animasyonlu app_offline.htm Dosyasƒ±nƒ± Olu≈ütur
    # Bu dosya HTML5 standartlarƒ±nda, responsive ve ≈üƒ±k bir tasarƒ±ma sahiptir.
    - name: Create styled app_offline.htm
      run: |
        cat <<EOF > app_offline.htm
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Updating...</title>
            <style>
                body {
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background-color: #f8f9fa;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    color: #495057;
                    text-align: center;
                }
                .message-container {
                    margin-top: 60px;
                }
                h2 {
                    font-size: 1.2rem;
                    margin: 10px 0;
                    font-weight: 400;
                    opacity: 0.9;
                }
                /* KULLANICININ VERDƒ∞ƒûƒ∞ ANIMASYON KODLARI */
                .ü§ö {
                  --skin-color: #E4C560;
                  --tap-speed: 0.6s;
                  --tap-stagger: 0.1s;
                  position: relative;
                  width: 80px;
                  height: 60px;
                  /* Ortalama sorunu olmamasƒ± i√ßin margin-left kaldƒ±rƒ±ldƒ± veya container ile dengelendi */
                }
                .ü§ö:before {
                  content: '';
                  display: block;
                  width: 180%;
                  height: 75%;
                  position: absolute;
                  top: 70%;
                  right: 20%;
                  background-color: black;
                  border-radius: 40px 10px;
                  filter: blur(10px);
                  opacity: 0.3;
                }
                .üå¥ {
                  display: block;
                  width: 100%;
                  height: 100%;
                  position: absolute;
                  top: 0;
                  left: 0;
                  background-color: var(--skin-color);
                  border-radius: 10px 40px;
                }
                .üëç {
                  position: absolute;
                  width: 120%;
                  height: 38px;
                  background-color: var(--skin-color);
                  bottom: -18%;
                  right: 1%;
                  transform-origin: calc(100% - 20px) 20px;
                  transform: rotate(-20deg);
                  border-radius: 30px 20px 20px 10px;
                  border-bottom: 2px solid rgba(0, 0, 0, 0.1);
                  border-left: 2px solid rgba(0, 0, 0, 0.1);
                }
                .üëç:after {
                  width: 20%;
                  height: 60%;
                  content: '';
                  background-color: rgba(255, 255, 255, 0.3);
                  position: absolute;
                  bottom: -8%;
                  left: 5px;
                  border-radius: 60% 10% 10% 30%;
                  border-right: 2px solid rgba(0, 0, 0, 0.05);
                }
                .üëâ {
                  position: absolute;
                  width: 80%;
                  height: 35px;
                  background-color: var(--skin-color);
                  bottom: 32%;
                  right: 64%;
                  transform-origin: 100% 20px;
                  animation-duration: calc(var(--tap-speed) * 2);
                  animation-timing-function: ease-in-out;
                  animation-iteration-count: infinite;
                  transform: rotate(10deg);
                }
                .üëâ:before {
                  content: '';
                  position: absolute;
                  width: 140%;
                  height: 30px;
                  background-color: var(--skin-color);
                  bottom: 8%;
                  right: 65%;
                  transform-origin: calc(100% - 20px) 20px;
                  transform: rotate(-60deg);
                  border-radius: 20px;
                }
                .üëâ:nth-child(1) { animation-delay: 0; filter: brightness(70%); animation-name: tap-upper-1; }
                .üëâ:nth-child(2) { animation-delay: var(--tap-stagger); filter: brightness(80%); animation-name: tap-upper-2; }
                .üëâ:nth-child(3) { animation-delay: calc(var(--tap-stagger) * 2); filter: brightness(90%); animation-name: tap-upper-3; }
                .üëâ:nth-child(4) { animation-delay: calc(var(--tap-stagger) * 3); filter: brightness(100%); animation-name: tap-upper-4; }
                @keyframes tap-upper-1 { 0%, 50%, 100% { transform: rotate(10deg) scale(0.4); } 40% { transform: rotate(50deg) scale(0.4); } }
                @keyframes tap-upper-2 { 0%, 50%, 100% { transform: rotate(10deg) scale(0.6); } 40% { transform: rotate(50deg) scale(0.6); } }
                @keyframes tap-upper-3 { 0%, 50%, 100% { transform: rotate(10deg) scale(0.8); } 40% { transform: rotate(50deg) scale(0.8); } }
                @keyframes tap-upper-4 { 0%, 50%, 100% { transform: rotate(10deg) scale(1); } 40% { transform: rotate(50deg) scale(1); } }
            </style>
        </head>
        <body>
            <div class="ü§ö">
                <div class="üëâ"></div>
                <div class="üëâ"></div>
                <div class="üëâ"></div>
                <div class="üëâ"></div>
                <div class="üå¥"></div>		
                <div class="üëç"></div>
            </div>

            <div class="message-container">
                <h2>The system is updating, please try again in 5 minutes...</h2>
                <h2>System jest aktualizowany, spr√≥buj ponownie za 5 minut...</h2>
                <h2>Sistem g√ºncelleniyor, l√ºtfen 5 dakika sonra tekrar deneyin...</h2>
            </div>
        </body>
        </html>
        EOF

    # 2. ADIM: Sadece app_offline.htm dosyasƒ±nƒ± g√∂nder (Uygulamayƒ± Durdur)
    - name: FTP Upload app_offline
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: /wwwroot/
        exclude: |
          **/*
          !app_offline.htm

    # 3. ADIM: GARANTƒ∞ BEKLEME (5 Dakika / 300 Saniye)
    - name: Wait for 5 minutes to ensure all locks are released
      run: sleep 300

    # 4. ADIM: T√ºm dosyalarƒ± (DLL'leri) y√ºkle
    - name: FTP Deploy (Full Upload)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./publish/
        server-dir: /wwwroot/
        protocol: ftp

    # 5. ADIM: app_offline.htm dosyasƒ±nƒ± sil ve siteyi a√ß
    - name: Start App (Delete app_offline.htm)
      run: rm ./publish/app_offline.htm || true

    - name: FTP Cleanup (Remove app_offline from server)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./publish/
        server-dir: /wwwroot/
        dangerous-clean-slate: false
